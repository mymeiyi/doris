1. 文档基本信息

1.1 功能标识

- 功能名称：Group Commit（高并发导入优化）
- 功能编码：DB-FUNC-002-DD
- 关联文档：
  - 需求文档：Group Commit 需求定义文档 V1.0
  - 概要设计文档：Group Commit 概要设计文档 V1.0
- 设计版本：V1.0
- 设计日期：2025-01-26
- 设计人员：陈明雨

2. 设计概述

2.1 设计范围

- 本次设计覆盖Group Commit功能的完整实现，包括FE端和BE端的核心模块设计
- FE端设计范围：
  - PreparedStatement缓存机制
  - Group Commit模式判断逻辑
  - 数据路由分发
- BE端设计范围：
  - 数据接收与缓存
  - 同步模式处理（sync_mode）
  - 异步模式处理（async_mode）
  - WAL写入与恢复

- 核心业务逻辑
怎样实现攒批？
将多个用户导入关联到一个内部导入，只有内部导入开启和提交事务
1. BE接收到用户发起的Group commit数据导入
2. 检查是否有该table 关联的内部导入
  1. 如果有：复用这个内部导入
  2. 如果没有，先block客户端的导入。同时申请一个新的内部导入：
    1. BE向FE发起内部导入SQL；
    2. FE解析SQL，开启事务，把导入规划返回给BE；
    3. BE执行这个导入规划，内部导入就绪。
3. BE把客户端的导入数据，写入到内部导入的内存队列中
4. 后台线程检查是否满足提交间隔或数据量任意一个条件：
  1. 时间条件：距离首次数据进入时间 >= group_commit_interval_ms
  2. 数据量条件：当前缓存数据量 >= group_commit_data_bytes
5. 如果满足的话，BE对这个内部导入，向FE发起提交事务。

2.2 设计目标

- 技术实现目标：
  - 实现高并发小批量导入的事务合并机制
  - 实现同步和异步两种提交模式
  - 实现WAL机制保证异步模式下的数据可靠性
  - 实现PreparedStatement缓存减少SQL解析开销
- 质量属性目标：
  - 性能：高并发场景下吞吐量提升5-10倍
  - 可靠性：async_mode通过WAL保证数据不丢失
  - 可维护性：模块职责清晰，接口设计合理
  - 可配置性：支持通过参数灵活调整行为

3. 模块详细设计

3.1 模块结构

```
Group Commit模块 (BE端)
├── 核心管理模块 (be/src/runtime/)
│   ├── GroupCommitMgr类                    # Group Commit全局管理器
│   │   ├── get_first_block_load_queue()    # 获取或创建LoadBlockQueue
│   │   ├── get_load_block_queue()          # 根据instance_id获取队列
│   │   ├── remove_load_id()                # 移除load_id
│   │   └── stop()                          # 停止管理器
│   ├── GroupCommitTable类                  # 单表的Group Commit管理
│   │   ├── get_first_block_load_queue()    # 获取或创建该表的队列
│   │   ├── get_load_block_queue()          # 获取队列
│   │   ├── _create_group_commit_load()     # 创建内部导入
│   │   ├── _exec_plan_fragment()           # 执行导入计划
│   │   └── _finish_group_commit_load()     # 完成导入（提交/回滚事务）
│   └── LoadBlockQueue类                    # 数据块队列
│       ├── add_block()                     # 添加数据块
│       ├── get_block()                     # 获取数据块
│       ├── add_load_id() / remove_load_id() # 管理load_id
│       ├── create_wal() / close_wal()      # WAL管理
│       ├── need_commit()                   # 检查是否需要提交
│       └── cancel()                        # 取消队列
│
├── Pipeline Operator模块 (be/src/pipeline/exec/)
│   ├── GroupCommitBlockSinkOperator        # 数据写入Operator
│   │   ├── GroupCommitBlockSinkOperatorX   # Operator定义
│   │   │   ├── init()                      # 初始化
│   │   │   ├── prepare()                   # 准备执行
│   │   │   └── sink()                      # 写入数据块
│   │   └── GroupCommitBlockSinkLocalState  # 本地状态
│   │       ├── _add_block()                # 添加单个块
│   │       ├── _add_blocks()               # 批量添加块
│   │       ├── _initialize_load_queue()    # 初始化队列
│   │       └── _calculate_estimated_wal_bytes() # 计算WAL大小
│   └── GroupCommitScanOperator             # 数据读取Operator
│       ├── GroupCommitOperatorX            # Operator定义
│       │   └── get_block()                 # 从队列获取数据块
│       └── GroupCommitLocalState           # 本地状态
│           └── init()                      # 初始化并关联队列
│
└── WAL模块 (be/src/olap/wal/)
    ├── WalManager类                        # WAL全局管理器
    │   ├── init()                          # 初始化WAL目录
    │   ├── create_wal_path()               # 创建WAL文件路径
    │   ├── get_wal_path()                  # 获取WAL路径
    │   ├── delete_wal()                    # 删除WAL文件
    │   ├── add_recover_wal()               # 添加待恢复的WAL
    │   ├── update_wal_dir_estimated_wal_bytes() # 更新预估WAL大小
    │   └── get_wal_dir_available_size()    # 获取可用空间
    ├── WalWriter类                         # WAL写入器
    │   ├── init()                          # 初始化写入器
    │   ├── append_header()                 # 写入头部
    │   ├── append_blocks()                 # 写入数据块
    │   └── finalize()                      # 完成写入
    ├── WalReader类                         # WAL读取器
    │   ├── init()                          # 初始化读取器
    │   ├── read_header()                   # 读取头部
    │   ├── read_block()                    # 读取数据块
    │   └── finalize()                      # 完成读取
    ├── WalTable类                          # 单表WAL恢复管理
    │   ├── add_wal()                       # 添加WAL文件
    │   ├── replay_wals()                   # 重放WAL文件
    │   └── stop()                          # 停止恢复
    └── WalDirsInfo类                       # WAL目录信息管理
        ├── add()                           # 添加目录
        ├── get_available_random_wal_dir()  # 获取可用目录
        ├── update_wal_dir_limit()          # 更新目录限制
        └── get_wal_dir_available_size()    # 获取可用空间
```

3.2 类设计

3.2.1 类名：GroupCommitMgr

- 源文件：be/src/runtime/group_commit_mgr.h, group_commit_mgr.cpp
- 类职责：Group Commit全局管理器，管理所有表的Group Commit操作，维护表到GroupCommitTable的映射
- 类关系：
  - 依赖：ExecEnv、ThreadPool
  - 聚合：GroupCommitTable（按table_id管理多个表）
- 属性列表：

| 属性名 | 类型 | 默认值 | 说明 | 约束 |
|-------|------|-------|------|------|
| _exec_env | ExecEnv* | nullptr | 执行环境 | - |
| _thread_pool | unique_ptr<ThreadPool> | - | Group Commit线程池 | 最大线程数由config::group_commit_insert_threads控制 |
| _all_block_queues_bytes | shared_ptr<atomic_size_t> | 0 | 所有表的Block队列内存占用总量 | 用于内存反压 |
| _lock | mutex | - | 保护_table_map的互斥锁 | - |
| _table_map | unordered_map<int64_t, shared_ptr<GroupCommitTable>> | - | table_id到GroupCommitTable的映射 | 线程安全 |

- 方法列表：

| 方法签名 | 返回类型 | 参数 | 说明 | 异常 |
|---------|---------|------|------|------|
| get_first_block_load_queue(...) | Status | db_id, table_id, base_schema_version, index_size, load_id, load_block_queue, be_exe_version, mem_tracker, create_plan_dep, put_block_dep | 获取或创建LoadBlockQueue | InternalError |
| get_load_block_queue(table_id, instance_id, load_block_queue, get_block_dep) | Status | table_id, instance_id, load_block_queue引用, get_block_dep | 根据instance_id获取队列 | NotFound |
| remove_load_id(table_id, load_id) | void | table_id, load_id | 从队列中移除指定的load_id | - |
| stop() | void | - | 停止线程池 | - |

3.2.2 类名：GroupCommitTable

- 源文件：be/src/runtime/group_commit_mgr.h, group_commit_mgr.cpp
- 类职责：管理单个表的Group Commit操作，负责创建和管理LoadBlockQueue
- 类关系：
  - 依赖：ExecEnv、ThreadPool、WalManager
  - 聚合：LoadBlockQueue（按fragment_instance_id管理）
- 属性列表：

| 属性名 | 类型 | 默认值 | 说明 | 约束 |
|-------|------|-------|------|------|
| _exec_env | ExecEnv* | nullptr | 执行环境 | - |
| _thread_pool | ThreadPool* | nullptr | 线程池指针 | - |
| _all_block_queues_bytes | shared_ptr<atomic_size_t> | - | 所有队列内存占用（共享） | - |
| _db_id | int64_t | - | 数据库ID | - |
| _table_id | int64_t | - | 表ID | - |
| _lock | mutex | - | 保护队列映射的互斥锁 | - |
| _load_block_queues | unordered_map<UniqueId, shared_ptr<LoadBlockQueue>> | - | fragment_instance_id到队列的映射 | - |
| _is_creating_plan_fragment | bool | false | 是否正在创建执行计划 | - |
| _create_plan_deps | unordered_map<UniqueId, tuple<...>> | - | 等待创建计划的依赖 | - |

- 方法列表：

| 方法签名 | 返回类型 | 参数 | 说明 | 异常 |
|---------|---------|------|------|------|
| get_first_block_load_queue(...) | Status | 同GroupCommitMgr | 获取或创建队列，必要时创建内部导入 | DataQualityError, InternalError |
| get_load_block_queue(instance_id, load_block_queue, get_block_dep) | Status | instance_id, load_block_queue引用, get_block_dep | 根据instance_id获取队列 | InternalError |
| remove_load_id(load_id) | void | load_id | 移除load_id | - |
| _create_group_commit_load(be_exe_version, mem_tracker) | Status | be_exe_version, mem_tracker | 创建内部Group Commit导入 | InternalError |
| _exec_plan_fragment(db_id, table_id, label, txn_id, pipeline_params) | Status | 执行参数 | 执行导入计划Fragment | - |
| _finish_group_commit_load(...) | Status | db_id, table_id, label, txn_id, instance_id, status, state | 完成导入，提交或回滚事务 | - |

3.2.3 类名：LoadBlockQueue

- 源文件：be/src/runtime/group_commit_mgr.h, group_commit_mgr.cpp
- 类职责：管理单个内部导入的数据块队列，支持多个用户导入写入同一队列，实现攒批功能
- 类关系：
  - 依赖：vectorized::Block、VWalWriter、pipeline::Dependency
  - 关联：被GroupCommitBlockSinkOperator写入，被GroupCommitScanOperator读取
- 属性列表：

| 属性名 | 类型 | 默认值 | 说明 | 约束 |
|-------|------|-------|------|------|
| load_instance_id | UniqueId | - | 内部导入的instance_id | 唯一标识 |
| label | string | - | 导入标签（group_commit_xxx格式） | - |
| txn_id | int64_t | - | 事务ID | - |
| schema_version | int64_t | - | 表Schema版本 | 用于兼容性检查 |
| index_size | int64_t | - | 索引数量 | - |
| wait_internal_group_commit_finish | bool | false | 是否等待内部导入完成 | sync_mode时为true |
| data_size_condition | bool | false | 是否因数据量触发提交 | - |
| group_commit_load_count | atomic_size_t | 0 | 当前攒批的用户导入数量 | - |
| mutex | mutex | - | 保护队列的互斥锁 | - |
| process_finish | atomic<bool> | false | 内部导入是否执行完成 | - |
| status | Status | OK | 执行状态 | - |
| dependencies | vector<shared_ptr<Dependency>> | - | 等待完成的依赖列表 | 用于sync_mode |
| _load_ids_to_write_dep | map<UniqueId, shared_ptr<Dependency>> | - | load_id到写入依赖的映射 | - |
| _block_queue | list<BlockData> | - | 数据块队列 | - |
| _v_wal_writer | shared_ptr<VWalWriter> | - | WAL写入器 | async_mode时使用 |
| _need_commit | bool | false | 是否需要提交 | - |
| _group_commit_interval_ms | int64_t | 10000 | 提交时间间隔（毫秒） | 可通过表属性配置 |
| _group_commit_data_bytes | int64_t | 67108864 | 提交数据量阈值（64MB） | 可通过表属性配置 |
| _data_bytes | int64_t | 0 | 当前累积数据量 | - |
| _start_time | steady_clock::time_point | - | 首次数据进入时间 | - |
| _all_block_queues_bytes | shared_ptr<atomic_size_t> | - | 全局队列内存占用 | 用于内存反压 |

- 方法列表：

| 方法签名 | 返回类型 | 参数 | 说明 | 异常 |
|---------|---------|------|------|------|
| add_block(runtime_state, block, write_wal, load_id) | Status | runtime_state, block, write_wal, load_id | 添加数据块到队列 | InternalError |
| get_block(runtime_state, block, find_block, eos, get_block_dep) | Status | runtime_state, block指针, find_block指针, eos指针, get_block_dep | 从队列获取数据块 | - |
| add_load_id(load_id, put_block_dep) | Status | load_id, put_block_dep | 添加新的用户load_id到队列 | InternalError |
| remove_load_id(load_id) | Status | load_id | 移除用户load_id | NotFound |
| contain_load_id(load_id) | bool | load_id | 检查是否包含指定load_id | - |
| cancel(st) | void | st: 取消原因 | 取消队列，清空数据 | - |
| need_commit() | bool | - | 检查是否满足提交条件 | - |
| create_wal(db_id, tb_id, wal_id, import_label, wal_manager, slot_desc, be_exe_version) | Status | WAL创建参数 | 创建WAL文件 | - |
| close_wal() | Status | - | 关闭WAL文件 | - |
| has_enough_wal_disk_space(estimated_wal_bytes) | bool | estimated_wal_bytes | 检查WAL磁盘空间是否充足 | - |
| append_dependency(finish_dep) | void | finish_dep | 添加完成依赖（sync_mode） | - |
| append_read_dependency(read_dep) | void | read_dep | 添加读取依赖 | - |

3.2.4 类名：GroupCommitBlockSinkOperatorX

- 源文件：be/src/pipeline/exec/group_commit_block_sink_operator.h, group_commit_block_sink_operator.cpp
- 类职责：Pipeline Operator，负责将用户导入数据写入LoadBlockQueue
- 类关系：
  - 继承：DataSinkOperatorX<GroupCommitBlockSinkLocalState>
  - 依赖：OlapTableSchemaParam、VOlapTablePartitionParam
- 属性列表：

| 属性名 | 类型 | 默认值 | 说明 | 约束 |
|-------|------|-------|------|------|
| _row_desc | RowDescriptor& | - | 行描述符 | - |
| _t_output_expr | vector<TExpr>& | - | 输出表达式 | - |
| _output_vexpr_ctxs | VExprContextSPtrs | - | 向量化表达式上下文 | - |
| _tuple_desc_id | int | -1 | Tuple描述符ID | - |
| _schema | shared_ptr<OlapTableSchemaParam> | - | 表Schema参数 | - |
| _output_tuple_desc | TupleDescriptor* | nullptr | 输出Tuple描述符 | - |
| _db_id | int64_t | - | 数据库ID | - |
| _table_id | int64_t | - | 表ID | - |
| _base_schema_version | int64_t | 0 | 基础Schema版本 | - |
| _load_id | UniqueId | - | 用户导入ID | - |
| _max_filter_ratio | double | 0.0 | 最大过滤比例 | - |
| _partition | TOlapTablePartitionParam | - | 分区参数 | - |
| _group_commit_mode | TGroupCommitMode::type | - | Group Commit模式 | SYNC_MODE或ASYNC_MODE |

- 方法列表：

| 方法签名 | 返回类型 | 参数 | 说明 | 异常 |
|---------|---------|------|------|------|
| init(t_sink) | Status | t_sink: TDataSink | 初始化Operator | InternalError |
| prepare(state) | Status | state: RuntimeState | 准备执行 | InternalError |
| sink(state, block, eos) | Status | state, block, eos | 写入数据块 | DataQualityError |

3.2.5 类名：GroupCommitBlockSinkLocalState

- 源文件：be/src/pipeline/exec/group_commit_block_sink_operator.h, group_commit_block_sink_operator.cpp
- 类职责：GroupCommitBlockSinkOperatorX的本地状态，持有实际的数据处理逻辑
- 类关系：
  - 继承：PipelineXSinkLocalState<BasicSharedState>
  - 依赖：LoadBlockQueue、OlapTableBlockConvertor、VOlapTablePartitionParam
- 属性列表：

| 属性名 | 类型 | 默认值 | 说明 | 约束 |
|-------|------|-------|------|------|
| _output_vexpr_ctxs | VExprContextSPtrs | - | 输出表达式上下文 | - |
| _block_convertor | unique_ptr<OlapTableBlockConvertor> | - | 数据块转换器 | - |
| _load_block_queue | shared_ptr<LoadBlockQueue> | nullptr | 关联的LoadBlockQueue | - |
| _blocks | vector<shared_ptr<Block>> | - | 缓存的数据块（用于计算filter ratio） | - |
| _is_block_appended | bool | false | 数据块是否已添加到队列 | - |
| _vpartition | unique_ptr<VOlapTablePartitionParam> | - | 分区参数 | - |
| _partitions | vector<VOlapTablePartition*> | - | 分区列表 | - |
| _has_filtered_rows | bool | false | 是否有过滤行 | - |
| _estimated_wal_bytes | size_t | 0 | 预估WAL大小 | - |
| _group_commit_mode | TGroupCommitMode::type | - | Group Commit模式 | 可能从ASYNC降级为SYNC |
| _filter_bitmap | Bitmap | 1024 | 过滤位图 | - |
| _table_id | int64_t | - | 表ID | - |
| _finish_dependency | shared_ptr<Dependency> | - | 完成依赖 | sync_mode时使用 |
| _create_plan_dependency | shared_ptr<Dependency> | nullptr | 创建计划依赖 | - |
| _put_block_dependency | shared_ptr<Dependency> | nullptr | 写入Block依赖 | 用于内存反压 |

- 方法列表：

| 方法签名 | 返回类型 | 参数 | 说明 | 异常 |
|---------|---------|------|------|------|
| init(state, info) | Status | state, info | 初始化本地状态 | - |
| open(state) | Status | state | 打开Operator | InternalError |
| close(state, close_status) | Status | state, close_status | 关闭Operator，等待sync_mode完成 | InternalError |
| _add_block(state, block) | Status | state, block | 添加单个数据块到队列 | - |
| _add_blocks(state, is_blocks_contain_all_load_data) | Status | state, is_blocks_contain_all_load_data | 批量添加数据块到队列 | InternalError |
| _initialize_load_queue() | Status | - | 初始化LoadBlockQueue | InternalError |
| _calculate_estimated_wal_bytes(is_blocks_contain_all_load_data) | size_t | is_blocks_contain_all_load_data | 计算预估WAL大小 | - |
| _remove_estimated_wal_bytes() | void | - | 移除预估WAL大小 | - |

3.2.6 类名：GroupCommitOperatorX

- 源文件：be/src/pipeline/exec/group_commit_scan_operator.h, group_commit_scan_operator.cpp
- 类职责：Pipeline Operator，负责从LoadBlockQueue读取数据块供内部导入使用
- 类关系：
  - 继承：ScanOperatorX<GroupCommitLocalState>
  - 依赖：LoadBlockQueue
- 属性列表：

| 属性名 | 类型 | 默认值 | 说明 | 约束 |
|-------|------|-------|------|------|
| _table_id | int64_t | - | 表ID | 从TPlanNode获取 |

- 方法列表：

| 方法签名 | 返回类型 | 参数 | 说明 | 异常 |
|---------|---------|------|------|------|
| get_block(state, block, eos) | Status | state, block指针, eos指针 | 从LoadBlockQueue获取数据块 | - |

3.2.7 类名：GroupCommitLocalState

- 源文件：be/src/pipeline/exec/group_commit_scan_operator.h, group_commit_scan_operator.cpp
- 类职责：GroupCommitOperatorX的本地状态
- 类关系：
  - 继承：ScanLocalState<GroupCommitLocalState>
  - 依赖：LoadBlockQueue、Dependency
- 属性列表：

| 属性名 | 类型 | 默认值 | 说明 | 约束 |
|-------|------|-------|------|------|
| load_block_queue | shared_ptr<LoadBlockQueue> | nullptr | 关联的LoadBlockQueue | - |
| _get_block_dependency | shared_ptr<Dependency> | nullptr | 获取Block依赖 | 队列为空时阻塞 |
| _runtime_filter_timer | shared_ptr<RuntimeFilterTimer> | nullptr | 运行时过滤计时器 | - |

- 方法列表：

| 方法签名 | 返回类型 | 参数 | 说明 | 异常 |
|---------|---------|------|------|------|
| init(state, info) | Status | state, info | 初始化本地状态，获取LoadBlockQueue | InternalError |
| dependencies() | vector<Dependency*> | - | 返回依赖列表 | - |
| _process_conjuncts(state) | Status | state | 处理谓词 | - |

3.2.8 类名：WalManager

- 源文件：be/src/olap/wal/wal_manager.h, wal_manager.cpp
- 类职责：WAL全局管理器，管理WAL文件的创建、删除、恢复，以及磁盘空间监控
- 类关系：
  - 依赖：ExecEnv、WalDirsInfo、WalTable、ThreadPool
  - 聚合：WalTable（按table_id管理）
- 属性列表：

| 属性名 | 类型 | 默认值 | 说明 | 约束 |
|-------|------|-------|------|------|
| _exec_env | ExecEnv* | nullptr | 执行环境 | - |
| _stop | atomic<bool> | false | 停止标志 | - |
| _wal_dirs | vector<string> | - | WAL目录列表 | 由配置决定或使用存储路径下的wal目录 |
| _update_wal_dirs_info_thread | shared_ptr<Thread> | - | 更新WAL目录信息的后台线程 | - |
| _wal_dirs_info | unique_ptr<WalDirsInfo> | - | WAL目录信息管理 | - |
| _replay_thread | shared_ptr<Thread> | - | WAL重放后台线程 | - |
| _thread_pool | unique_ptr<ThreadPool> | - | WAL重放线程池 | 最大线程数由config::group_commit_relay_wal_threads控制 |
| _table_lock | shared_mutex | - | 保护_table_map的读写锁 | - |
| _table_map | map<int64_t, shared_ptr<WalTable>> | - | table_id到WalTable的映射 | - |
| _wal_path_lock | shared_mutex | - | 保护_wal_path_map的读写锁 | - |
| _wal_path_map | unordered_map<int64_t, string> | - | wal_id到wal_path的映射 | - |
| _wal_queue_lock | shared_mutex | - | 保护_wal_queues的读写锁 | - |
| _wal_queues | unordered_map<int64_t, set<int64_t>> | - | table_id到wal_id集合的映射 | 用于监控 |
| _first_replay | atomic<bool> | true | 是否首次重放 | - |

- 方法列表：

| 方法签名 | 返回类型 | 参数 | 说明 | 异常 |
|---------|---------|------|------|------|
| init() | Status | - | 初始化WAL目录和后台线程 | InternalError |
| is_running() | bool | - | 检查WalManager是否运行中 | - |
| stop() | void | - | 停止WalManager | - |
| create_wal_path(db_id, table_id, wal_id, label, base_path, wal_version) | Status | 创建参数 | 创建WAL文件路径 | InternalError |
| get_wal_path(wal_id, wal_path) | Status | wal_id, wal_path引用 | 获取WAL文件路径 | InternalError |
| delete_wal(table_id, wal_id) | Status | table_id, wal_id | 删除WAL文件 | - |
| add_recover_wal(db_id, table_id, wal_id, wal) | Status | 恢复参数 | 添加待恢复的WAL | - |
| add_wal_queue(table_id, wal_id) | void | table_id, wal_id | 添加WAL到监控队列 | - |
| erase_wal_queue(table_id, wal_id) | void | table_id, wal_id | 从监控队列移除WAL | - |
| get_wal_queue_size(table_id) | size_t | table_id | 获取WAL队列大小 | - |
| update_wal_dir_estimated_wal_bytes(wal_dir, increase, decrease) | Status | wal_dir, 增减量 | 更新预估WAL大小 | - |
| get_wal_dir_available_size(wal_dir, available_bytes) | Status | wal_dir, available_bytes指针 | 获取可用空间 | - |
| get_max_available_size() | size_t | - | 获取最大可用空间 | - |
| get_wal_dirs_info_string() | string | - | 获取WAL目录信息字符串（用于日志） | - |
| parse_wal_path(file_name, version, backend_id, wal_id, label) | Status | 解析参数 | 解析WAL文件名 | InvalidArgument |
| get_base_wal_path(wal_path_str) | string | wal_path_str | 获取WAL基础路径 | - |

3.2.9 类名：WalWriter

- 源文件：be/src/olap/wal/wal_writer.h, wal_writer.cpp
- 类职责：WAL文件写入器，负责将数据块序列化写入WAL文件
- 类关系：
  - 依赖：FileWriter、PBlock
- 属性列表：

| 属性名 | 类型 | 默认值 | 说明 | 约束 |
|-------|------|-------|------|------|
| _file_name | string | - | WAL文件名 | - |
| _file_writer | FileWriterPtr | - | 文件写入器 | - |

- 常量定义：

| 常量名 | 类型 | 值 | 说明 |
|-------|------|---|------|
| LENGTH_SIZE | int64_t | 8 | 长度字段大小 |
| CHECKSUM_SIZE | int64_t | 4 | 校验和大小 |
| VERSION_SIZE | int64_t | 4 | 版本字段大小 |

- 方法列表：

| 方法签名 | 返回类型 | 参数 | 说明 | 异常 |
|---------|---------|------|------|------|
| init(fs) | Status | fs: FileSystemSPtr | 初始化写入器 | IOException |
| finalize() | Status | - | 完成写入 | IOException |
| append_header(col_ids) | Status | col_ids: 列ID字符串 | 写入WAL头部 | IOException |
| append_blocks(blocks) | Status | blocks: PBlockArray | 写入数据块 | IOException |
| file_name() | string | - | 获取文件名 | - |

3.2.10 类名：WalReader

- 源文件：be/src/olap/wal/wal_reader.h, wal_reader.cpp
- 类职责：WAL文件读取器，负责读取和反序列化WAL文件中的数据块
- 类关系：
  - 依赖：FileReader、PBlock
- 属性列表：

| 属性名 | 类型 | 默认值 | 说明 | 约束 |
|-------|------|-------|------|------|
| _file_name | string | - | WAL文件名 | - |
| _offset | size_t | - | 当前读取偏移 | - |
| file_reader | FileReaderSPtr | - | 文件读取器 | - |

- 方法列表：

| 方法签名 | 返回类型 | 参数 | 说明 | 异常 |
|---------|---------|------|------|------|
| init() | Status | - | 初始化读取器 | IOException |
| finalize() | Status | - | 完成读取 | - |
| read_header(version, col_ids) | Status | version引用, col_ids引用 | 读取WAL头部 | IOException |
| read_block(block) | Status | block: PBlock引用 | 读取数据块 | IOException |

3.2.11 类名：WalTable

- 源文件：be/src/olap/wal/wal_table.h, wal_table.cpp
- 类职责：管理单个表的WAL恢复，负责重放WAL文件
- 类关系：
  - 依赖：ExecEnv、WalInfo、HttpStreamAction
- 属性列表：

| 属性名 | 类型 | 默认值 | 说明 | 约束 |
|-------|------|-------|------|------|
| _exec_env | ExecEnv* | - | 执行环境 | - |
| _db_id | int64_t | - | 数据库ID | - |
| _table_id | int64_t | - | 表ID | - |
| _http_stream_action | shared_ptr<HttpStreamAction> | - | HTTP流处理 | 用于重放WAL |
| _replay_wal_lock | mutex | - | 保护重放的互斥锁 | - |
| _replay_wal_map | map<string, shared_ptr<WalInfo>> | - | WAL路径到WalInfo的映射 | - |
| _replaying_queue | list<shared_ptr<WalInfo>> | - | 正在重放的WAL队列 | - |

- 方法列表：

| 方法签名 | 返回类型 | 参数 | 说明 | 异常 |
|---------|---------|------|------|------|
| add_wal(wal_id, wal) | void | wal_id, wal路径 | 添加WAL文件 | - |
| replay_wals() | Status | - | 重放所有待恢复的WAL | - |
| size() | size_t | - | 获取待重放WAL数量 | - |
| stop() | void | - | 停止重放 | - |

3.2.12 类名：WalDirsInfo

- 源文件：be/src/olap/wal/wal_dirs_info.h, wal_dirs_info.cpp
- 类职责：管理所有WAL目录的空间信息，实现空间监控和负载均衡
- 类关系：
  - 聚合：WalDirInfo
- 属性列表：

| 属性名 | 类型 | 默认值 | 说明 | 约束 |
|-------|------|-------|------|------|
| _wal_dirs_info_vec | vector<shared_ptr<WalDirInfo>> | - | WAL目录信息列表 | - |
| _lock | shared_mutex | - | 保护信息列表的读写锁 | - |

- 方法列表：

| 方法签名 | 返回类型 | 参数 | 说明 | 异常 |
|---------|---------|------|------|------|
| add(wal_dir, limit, used, estimated_wal_bytes) | Status | 添加参数 | 添加WAL目录 | - |
| get_available_random_wal_dir() | string | - | 随机获取可用的WAL目录 | - |
| get_max_available_size() | size_t | - | 获取最大可用空间 | - |
| update_wal_dir_limit(wal_dir, limit) | Status | wal_dir, limit | 更新目录限制 | - |
| update_all_wal_dir_limit() | Status | - | 更新所有目录限制 | - |
| update_wal_dir_used(wal_dir, used) | Status | wal_dir, used | 更新目录已用空间 | - |
| update_all_wal_dir_used() | Status | - | 更新所有目录已用空间 | - |
| update_wal_dir_estimated_wal_bytes(wal_dir, increase, decrease) | Status | wal_dir, 增减量 | 更新预估WAL大小 | - |
| get_wal_dir_available_size(wal_dir, available_bytes) | Status | wal_dir, available_bytes指针 | 获取目录可用空间 | - |
| get_wal_dirs_info_string() | string | - | 获取所有目录信息字符串 | - |

3.2.13 类名：WalDirInfo

- 源文件：be/src/olap/wal/wal_dirs_info.h, wal_dirs_info.cpp
- 类职责：管理单个WAL目录的空间信息
- 属性列表：

| 属性名 | 类型 | 默认值 | 说明 | 约束 |
|-------|------|-------|------|------|
| _wal_dir | string | - | WAL目录路径 | - |
| _limit | size_t | - | 空间限制（字节） | 由config::group_commit_wal_max_disk_limit控制 |
| _used | size_t | - | 已使用空间（字节） | - |
| _estimated_wal_bytes | size_t | - | 预估WAL大小（字节） | - |
| _lock | shared_mutex | - | 保护空间信息的读写锁 | - |

- 方法列表：

| 方法签名 | 返回类型 | 参数 | 说明 | 异常 |
|---------|---------|------|------|------|
| get_wal_dir() | const string& | - | 获取WAL目录路径 | - |
| get_limit() | size_t | - | 获取空间限制 | - |
| get_used() | size_t | - | 获取已使用空间 | - |
| get_estimated_wal_bytes() | size_t | - | 获取预估WAL大小 | - |
| set_limit(limit) | void | limit | 设置空间限制 | - |
| set_used(used) | void | used | 设置已使用空间 | - |
| set_estimated_wal_bytes(increase, decrease) | void | 增减量 | 设置预估WAL大小 | - |
| available() | size_t | - | 获取可用空间 | - |
| update_wal_dir_limit(limit) | Status | limit | 更新空间限制 | - |
| update_wal_dir_used(used) | Status | used | 更新已使用空间 | - |
| get_wal_dir_info_string() | string | - | 获取目录信息字符串 | - |

3.3 关键方法详细设计

3.3.1 方法名：LoadBlockQueue::add_block()

- 源文件：be/src/runtime/group_commit_mgr.cpp
- 功能描述：将数据块添加到队列中，同时写入WAL（如果需要），并检查提交条件

- 算法描述：
```
1. 获取mutex锁
2. 检查状态：
   - 检查队列status是否OK
   - 检查runtime_state是否被取消
3. 如果block有数据（rows > 0）：
   a. 如果不是wait_replay_wal_finish模式：
      - 将block添加到_block_queue
      - 更新_data_bytes
      - 更新全局_all_block_queues_bytes
   b. 如果需要写WAL（write_wal为true或wait_replay_wal_finish模式）：
      - 调用_v_wal_writer->write_wal(block)
      - 如果写入失败，取消队列并返回错误
   c. 如果全局内存超过group_commit_queue_mem_limit：
      - 阻塞当前load_id的写入依赖（内存反压）
4. 检查提交条件（如果_need_commit为false）：
   a. 数据量条件：_data_bytes >= _group_commit_data_bytes
   b. 时间条件：当前时间 - _start_time >= _group_commit_interval_ms
   c. 满足任一条件则设置_need_commit = true
5. 唤醒所有读取依赖（_read_deps）
6. 返回Status::OK()
```

- 输入参数：

| 参数名 | 类型 | 是否必填 | 描述 | 校验规则 |
|-------|------|---------|------|---------|
| runtime_state | RuntimeState* | 是 | 运行时状态 | 非空 |
| block | shared_ptr<vectorized::Block> | 是 | 待添加的数据块 | 非空 |
| write_wal | bool | 是 | 是否写入WAL | async_mode时为true |
| load_id | UniqueId& | 是 | 用户导入ID | 必须已在队列中注册 |

- 返回值：Status

- 异常处理：

| 异常类型 | 触发条件 | 处理方式 |
|---------|---------|---------|
| InternalError | 队列状态异常 | 返回队列status |
| Cancelled | runtime_state被取消 | 返回cancel_reason |
| WAL写入失败 | _v_wal_writer->write_wal失败 | 取消队列并返回错误 |

- 性能考虑：
  - 时间复杂度：O(1)
  - 空间复杂度：O(n)，n为block的数据量
  - 内存反压：通过全局_all_block_queues_bytes实现反压

3.3.2 方法名：LoadBlockQueue::get_block()

- 源文件：be/src/runtime/group_commit_mgr.cpp
- 功能描述：从队列中获取数据块，供GroupCommitScanOperator使用

- 算法描述：
```
1. 初始化find_block = false, eos = false
2. 获取mutex锁
3. 检查状态：
   - 如果runtime_state被取消或队列status异常，取消队列并返回status
4. 检查时间条件：
   - 如果_need_commit为false且超过_group_commit_interval_ms，设置_need_commit = true
5. 如果队列为空：
   - 如果超过10倍_group_commit_interval_ms，打印日志
   - 如果不需要提交，阻塞get_block_dep
6. 如果队列非空：
   - 取出队首元素，swap到输出block
   - 设置find_block = true
   - 从队列移除该元素
   - 更新全局_all_block_queues_bytes
7. 判断是否结束（eos）：
   - 队列为空 && _need_commit && _load_ids_to_write_dep为空
8. 如果全局内存低于group_commit_queue_mem_limit：
   - 唤醒所有写入依赖（解除内存反压）
9. 返回Status::OK()
```

- 输入参数：

| 参数名 | 类型 | 是否必填 | 描述 | 校验规则 |
|-------|------|---------|------|---------|
| runtime_state | RuntimeState* | 是 | 运行时状态 | 非空 |
| block | vectorized::Block* | 是 | 输出数据块 | 非空 |
| find_block | bool* | 是 | 是否找到数据块 | 非空 |
| eos | bool* | 是 | 是否结束 | 非空 |
| get_block_dep | shared_ptr<Dependency> | 是 | 获取Block依赖 | 非空 |

- 返回值：Status

3.3.3 方法名：GroupCommitTable::_create_group_commit_load()

- 源文件：be/src/runtime/group_commit_mgr.cpp
- 功能描述：创建内部Group Commit导入，向FE发起导入请求，获取执行计划

- 算法描述：
```
1. 切换到指定的内存Tracker
2. 生成唯一的load_id
3. 构造label：group_commit_ + load_id（替换-为_）
4. 构造内部导入SQL：
   insert into doris_internal_table_id({table_id}) WITH LABEL {label}
   select * from group_commit("table_id"="{table_id}")
5. 构造TStreamLoadPutRequest：
   - 设置load_sql, loadId, label, token, max_filter_ratio, strictMode等
6. 通过ThriftRpcHelper向FE发起RPC请求
7. 检查返回结果：
   - 如果失败或不是pipeline模式，返回错误
8. 从结果中获取：
   - schema_version, index_size, txn_id, instance_id
9. 创建LoadBlockQueue：
   - 设置label, txn_id, schema_version等
   - 调用create_wal创建WAL文件
10. 在锁内：
    - 将队列添加到_load_block_queues
    - 为等待的load_id分配队列
11. 调用_exec_plan_fragment执行导入计划
12. 如果执行失败，调用_finish_group_commit_load回滚
```

- 输入参数：

| 参数名 | 类型 | 是否必填 | 描述 | 校验规则 |
|-------|------|---------|------|---------|
| be_exe_version | int | 是 | BE执行版本 | - |
| mem_tracker | shared_ptr<MemTrackerLimiter> | 是 | 内存Tracker | 非空 |

- 返回值：Status

3.3.4 方法名：GroupCommitTable::_finish_group_commit_load()

- 源文件：be/src/runtime/group_commit_mgr.cpp
- 功能描述：完成Group Commit导入，提交或回滚事务，处理WAL

- 算法描述：
```
1. 如果status为OK（提交事务）：
   a. 构造TLoadTxnCommitRequest
   b. 通过ThriftRpcHelper向FE发起commit RPC
   c. 如果遇到DELETE_BITMAP_LOCK_ERROR，重试最多3次
2. 如果status不OK（回滚事务）：
   a. 构造TLoadTxnRollbackRequest
   b. 通过ThriftRpcHelper向FE发起rollback RPC
3. 获取LoadBlockQueue：
   a. 如果status不OK，取消队列
   b. 关闭WAL
   c. 设置process_finish = true
   d. 唤醒所有等待的依赖（sync_mode的用户导入）
4. 从_load_block_queues中移除该队列
5. WAL处理：
   a. 如果成功：删除WAL文件
   b. 如果失败：将WAL添加到恢复队列
6. 打印完成日志
```

- 输入参数：

| 参数名 | 类型 | 是否必填 | 描述 | 校验规则 |
|-------|------|---------|------|---------|
| db_id | int64_t | 是 | 数据库ID | - |
| table_id | int64_t | 是 | 表ID | - |
| label | string& | 是 | 导入标签 | - |
| txn_id | int64_t | 是 | 事务ID | - |
| instance_id | TUniqueId& | 是 | Fragment实例ID | - |
| status | Status& | 是 | 执行状态 | - |
| state | RuntimeState* | 否 | 运行时状态（可为nullptr） | - |

- 返回值：Status

3.3.5 方法名：GroupCommitBlockSinkOperatorX::sink()

- 源文件：be/src/pipeline/exec/group_commit_block_sink_operator.cpp
- 功能描述：Pipeline Sink操作，将数据块写入LoadBlockQueue

- 算法描述：
```
1. 获取LocalState
2. 如果_load_block_queue为空，调用_initialize_load_queue()初始化
3. 定义wind_up闭包（处理eos情况）：
   a. 更新统计信息
   b. 如果数据块未添加到队列：
      - 检查filter ratio，如果超过max_filter_ratio返回错误
      - 调用_add_blocks添加数据
   c. 移除预估WAL大小
   d. 从队列移除load_id
4. 如果输入block为空，执行wind_up并返回
5. 更新num_rows_load_total和num_bytes_load_total
6. 数据块转换：
   a. 调用_block_convertor->validate_and_convert_block验证并转换数据
7. 如果不是自动分区：
   a. 调用find_partition查找分区
   b. 标记无分区的行为过滤行
8. 过滤无效行：
   a. 过滤被转换器标记的行
   b. 过滤无分区的行
9. 调用_add_block添加数据块
10. 执行wind_up并返回
```

- 输入参数：

| 参数名 | 类型 | 是否必填 | 描述 | 校验规则 |
|-------|------|---------|------|---------|
| state | RuntimeState* | 是 | 运行时状态 | 非空 |
| input_block | vectorized::Block* | 是 | 输入数据块 | 非空 |
| eos | bool | 是 | 是否结束 | - |

- 返回值：Status

3.3.6 方法名：GroupCommitBlockSinkLocalState::_add_blocks()

- 源文件：be/src/pipeline/exec/group_commit_block_sink_operator.cpp
- 功能描述：批量添加数据块到LoadBlockQueue，处理async_mode到sync_mode的降级

- 算法描述：
```
1. 检查WalManager是否运行
2. 如果是ASYNC_MODE：
   a. 计算预估WAL大小
   b. 检查WAL磁盘空间是否充足
   c. 如果空间不足，降级为SYNC_MODE
   d. 如果保持ASYNC_MODE，记录预估WAL大小
3. 如果需要等待完成（wait_internal_group_commit_finish或SYNC_MODE）：
   - 添加_finish_dependency到队列
4. 设置import_label和wal_id到state
5. 遍历_blocks，依次调用add_block添加到队列
6. 设置_is_block_appended = true
7. 清空_blocks
```

- 输入参数：

| 参数名 | 类型 | 是否必填 | 描述 | 校验规则 |
|-------|------|---------|------|---------|
| state | RuntimeState* | 是 | 运行时状态 | 非空 |
| is_blocks_contain_all_load_data | bool | 是 | 数据块是否包含所有导入数据 | - |

- 返回值：Status

3.3.7 方法名：WalManager::_replay_background()

- 源文件：be/src/olap/wal/wal_manager.cpp
- 功能描述：后台线程，定期检查并重放WAL文件

- 算法描述：
```
1. 循环直到_stop为true：
   a. 检查FE连接是否就绪（master_fe_addr.port != 0）
   b. 首次重放时调用_load_wals()加载历史WAL
   c. 更新WAL队列统计信息
   d. 收集需要重放的表：
      - 遍历_table_map
      - 收集size > 0的表ID
   e. 为每个表提交重放任务到线程池：
      - 调用table->replay_wals()
   f. 等待group_commit_replay_wal_retry_interval_seconds后继续
```

- 输入参数：无

- 返回值：Status

3.3.8 方法名：WalManager::create_wal_path()

- 源文件：be/src/olap/wal/wal_manager.cpp
- 功能描述：创建WAL文件路径

- 算法描述：
```
1. 调用_wal_dirs_info->get_available_random_wal_dir()获取可用目录
2. 构造WAL路径：
   {base_path}/{db_id}/{table_id}/{wal_version}_{backend_id}_{wal_id}_{label}
3. 获取_wal_path_lock写锁
4. 检查wal_id是否已存在于_wal_path_map
5. 将wal_id和路径添加到_wal_path_map
6. 返回Status::OK()
```

- 输入参数：

| 参数名 | 类型 | 是否必填 | 描述 | 校验规则 |
|-------|------|---------|------|---------|
| db_id | int64_t | 是 | 数据库ID | - |
| table_id | int64_t | 是 | 表ID | - |
| wal_id | int64_t | 是 | WAL ID（通常等于txn_id） | - |
| label | string& | 是 | 导入标签 | - |
| base_path | string& | 是 | 输出基础路径 | - |
| wal_version | uint32_t | 是 | WAL版本（当前为1） | - |

- 返回值：Status

4. 接口详细设计

4.1 API接口

4.1.1 接口名称：INSERT INTO VALUES（Group Commit模式）

- 请求方式：SQL语句
- 使用方式：
```sql
-- 设置Group Commit模式
SET group_commit = async_mode;  -- 或 sync_mode

-- 执行插入
INSERT INTO table_name (col1, col2, col3) VALUES (val1, val2, val3);
```

- 请求参数：
  - 标准INSERT INTO VALUES语法

- 响应格式：
```
Query OK, N rows affected (X.XX sec)
{'label':'group_commit_xxxxx', 'status':'PREPARE', 'txnId':'12345'}
```

- 错误码定义：

| 错误码 | 错误信息 | 说明 |
|-------|---------|------|
| 1064 | Syntax error | SQL语法错误 |
| 1142 | INSERT denied | 权限不足 |
| 1062 | Duplicate entry | 主键冲突（Unique模型） |

- 示例请求/响应：
```sql
mysql> SET group_commit = async_mode;
Query OK, 0 rows affected (0.00 sec)

mysql> INSERT INTO dt VALUES(1, 'Bob', 90), (2, 'Alice', 99);
Query OK, 2 rows affected (0.05 sec)
{'label':'group_commit_a145ce07f1c972fc-bd2c54597052a9ad', 'status':'PREPARE', 'txnId':'181508'}
```

4.1.2 接口名称：Stream Load（Group Commit模式）

- 请求方式：HTTP PUT
- URL路径：`http://{fe_host}:{http_port}/api/{db}/{table}/_stream_load`
- 请求头：

| 头字段 | 是否必须 | 示例值 | 说明 |
|-------|---------|-------|------|
| group_commit | 是 | async_mode | Group Commit模式 |
| column_separator | 否 | , | 列分隔符 |
| Authorization | 是 | Basic xxx | 认证信息 |

- 请求参数：
  - Body：CSV或JSON格式的数据内容

- 响应格式：
```json
{
    "TxnId": 7009,
    "Label": "group_commit_c84d2099208436ab_96e33fda01eddba8",
    "Comment": "",
    "GroupCommit": true,
    "Status": "Success",
    "Message": "OK",
    "NumberTotalRows": 2,
    "NumberLoadedRows": 2,
    "NumberFilteredRows": 0,
    "NumberUnselectedRows": 0,
    "LoadBytes": 19,
    "LoadTimeMs": 35
}
```

- 错误码定义：

| 错误码 | 错误信息 | 说明 |
|-------|---------|------|
| FAILED | Authentication failed | 认证失败 |
| FAILED | Table not found | 表不存在 |
| FAILED | Data format error | 数据格式错误 |

- 示例请求/响应：
```bash
# 请求
curl --location-trusted -u root: \
    -T data.csv \
    -H "group_commit:async_mode" \
    -H "column_separator:," \
    http://127.0.0.1:8030/api/db/dt/_stream_load

# 响应
{
    "TxnId": 7009,
    "Label": "group_commit_c84d2099208436ab_96e33fda01eddba8",
    "GroupCommit": true,
    "Status": "Success",
    "Message": "OK",
    "NumberTotalRows": 2,
    "NumberLoadedRows": 2
}
```

4.2 内部接口

本节描述Group Commit模块内部各组件之间的C++接口定义。

4.2.1 LoadBlockQueue接口

LoadBlockQueue是Group Commit的核心数据结构，负责管理数据块队列。

- 源文件：be/src/runtime/group_commit_mgr.h

**接口：添加数据块**
```cpp
Status add_block(RuntimeState* runtime_state, 
                 std::shared_ptr<vectorized::Block> block,
                 bool write_wal, 
                 UniqueId& load_id);
```
- 功能：将数据块添加到队列中，同时根据需要写入WAL
- 参数说明：
  - runtime_state (RuntimeState*, 必填) - 运行时状态，用于检查是否被取消
  - block (shared_ptr<Block>, 必填) - 待添加的向量化数据块
  - write_wal (bool, 必填) - 是否写入WAL（async_mode时为true）
  - load_id (UniqueId&, 必填) - 用户导入ID，必须已在队列中注册
- 返回值：Status - 操作状态，成功返回OK，失败返回错误信息
- 调用方：GroupCommitBlockSinkLocalState::_add_block()

**接口：获取数据块**
```cpp
Status get_block(RuntimeState* runtime_state, 
                 vectorized::Block* block, 
                 bool* find_block,
                 bool* eos, 
                 std::shared_ptr<pipeline::Dependency> get_block_dep);
```
- 功能：从队列中获取数据块供内部导入使用
- 参数说明：
  - runtime_state (RuntimeState*, 必填) - 运行时状态
  - block (Block*, 必填) - 输出参数，获取到的数据块
  - find_block (bool*, 必填) - 输出参数，是否找到数据块
  - eos (bool*, 必填) - 输出参数，是否到达流结束
  - get_block_dep (shared_ptr<Dependency>, 必填) - 获取Block依赖，队列为空时阻塞
- 返回值：Status - 操作状态
- 调用方：GroupCommitOperatorX::get_block()

**接口：添加用户导入ID**
```cpp
Status add_load_id(const UniqueId& load_id,
                   const std::shared_ptr<pipeline::Dependency> put_block_dep);
```
- 功能：将新的用户导入ID注册到队列中
- 参数说明：
  - load_id (const UniqueId&, 必填) - 用户导入ID
  - put_block_dep (shared_ptr<Dependency>, 必填) - 写入Block依赖，用于内存反压
- 返回值：Status - 操作状态
- 调用方：GroupCommitTable::get_first_block_load_queue()（复用已有队列时）

**接口：移除用户导入ID**
```cpp
Status remove_load_id(const UniqueId& load_id);
```
- 功能：从队列中移除指定的用户导入ID
- 参数说明：
  - load_id (const UniqueId&, 必填) - 要移除的用户导入ID
- 返回值：Status - 操作状态
- 调用方：
  - GroupCommitBlockSinkLocalState析构函数
  - GroupCommitBlockSinkOperatorX::sink()（在eos时调用）

**接口：创建WAL**
```cpp
Status create_wal(int64_t db_id, int64_t tb_id, int64_t wal_id, 
                  const std::string& import_label,
                  WalManager* wal_manager, 
                  std::vector<TSlotDescriptor>& slot_desc,
                  int be_exe_version);
```
- 功能：创建WAL文件，用于async_mode下的数据持久化
- 参数说明：
  - db_id (int64_t, 必填) - 数据库ID
  - tb_id (int64_t, 必填) - 表ID
  - wal_id (int64_t, 必填) - WAL ID（通常等于txn_id）
  - import_label (const string&, 必填) - 导入标签
  - wal_manager (WalManager*, 必填) - WAL管理器
  - slot_desc (vector<TSlotDescriptor>&, 必填) - 列描述符
  - be_exe_version (int, 必填) - BE执行版本
- 返回值：Status - 操作状态

**接口：检查提交条件**
```cpp
bool need_commit();
```
- 功能：检查是否满足提交条件（时间间隔或数据量）
- 返回值：bool - 是否需要提交
- 调用方：
  - GroupCommitTable::get_first_block_load_queue()（判断队列是否可复用）
  - LoadBlockQueue::get_block()（判断是否结束）

4.2.2 GroupCommitMgr接口

GroupCommitMgr是Group Commit的全局管理器，管理所有表的Group Commit操作。

- 源文件：be/src/runtime/group_commit_mgr.h

**接口：获取或创建LoadBlockQueue**
```cpp
Status get_first_block_load_queue(
    int64_t db_id, int64_t table_id, int64_t base_schema_version,
    int64_t index_size, const UniqueId& load_id,
    std::shared_ptr<LoadBlockQueue>& load_block_queue,
    int be_exe_version,
    std::shared_ptr<MemTrackerLimiter> mem_tracker,
    std::shared_ptr<pipeline::Dependency> create_plan_dep,
    std::shared_ptr<pipeline::Dependency> put_block_dep);
```
- 功能：获取现有的LoadBlockQueue或创建新的内部导入
- 参数说明：
  - db_id (int64_t, 必填) - 数据库ID
  - table_id (int64_t, 必填) - 表ID
  - base_schema_version (int64_t, 必填) - 基础Schema版本，用于兼容性检查
  - index_size (int64_t, 必填) - 索引数量
  - load_id (const UniqueId&, 必填) - 用户导入ID
  - load_block_queue (shared_ptr<LoadBlockQueue>&, 必填) - 输出参数，获取到的队列
  - be_exe_version (int, 必填) - BE执行版本
  - mem_tracker (shared_ptr<MemTrackerLimiter>, 必填) - 内存Tracker
  - create_plan_dep (shared_ptr<Dependency>, 必填) - 创建计划依赖
  - put_block_dep (shared_ptr<Dependency>, 必填) - 写入Block依赖
- 返回值：Status - 操作状态
- 调用方：GroupCommitBlockSinkLocalState::_initialize_load_queue()

**接口：根据instance_id获取队列**
```cpp
Status get_load_block_queue(int64_t table_id, const TUniqueId& instance_id,
                            std::shared_ptr<LoadBlockQueue>& load_block_queue,
                            std::shared_ptr<pipeline::Dependency> get_block_dep);
```
- 功能：根据Fragment instance_id获取对应的LoadBlockQueue
- 参数说明：
  - table_id (int64_t, 必填) - 表ID
  - instance_id (const TUniqueId&, 必填) - Fragment实例ID
  - load_block_queue (shared_ptr<LoadBlockQueue>&, 必填) - 输出参数
  - get_block_dep (shared_ptr<Dependency>, 必填) - 获取Block依赖
- 返回值：Status - 操作状态
- 调用方：GroupCommitLocalState::init()

**接口：移除load_id**
```cpp
void remove_load_id(int64_t table_id, const UniqueId& load_id);
```
- 功能：从指定表的队列中移除load_id
- 参数说明：
  - table_id (int64_t, 必填) - 表ID
  - load_id (const UniqueId&, 必填) - 要移除的用户导入ID
- 调用方：GroupCommitBlockSinkOperatorX::sink()（在eos时调用）

4.2.3 WalManager接口

WalManager是WAL全局管理器，管理WAL文件的创建、删除和恢复。

- 源文件：be/src/olap/wal/wal_manager.h

**接口：初始化**
```cpp
Status init();
```
- 功能：初始化WAL目录、后台线程和目录信息
- 返回值：Status - 操作状态
- 调用时机：BE启动时由ExecEnv调用

**接口：创建WAL路径**
```cpp
Status create_wal_path(int64_t db_id, int64_t table_id, int64_t wal_id,
                       const std::string& label, std::string& base_path, 
                       uint32_t wal_version);
```
- 功能：创建WAL文件路径，选择可用的WAL目录
- 参数说明：
  - db_id (int64_t, 必填) - 数据库ID
  - table_id (int64_t, 必填) - 表ID
  - wal_id (int64_t, 必填) - WAL ID（通常等于txn_id）
  - label (const string&, 必填) - 导入标签
  - base_path (string&, 必填) - 输出参数，WAL基础路径
  - wal_version (uint32_t, 必填) - WAL版本（当前为1）
- 返回值：Status - 操作状态
- 调用方：LoadBlockQueue::create_wal()

**接口：获取WAL路径**
```cpp
Status get_wal_path(int64_t wal_id, std::string& wal_path);
```
- 功能：根据wal_id获取WAL文件路径
- 参数说明：
  - wal_id (int64_t, 必填) - WAL ID
  - wal_path (string&, 必填) - 输出参数，WAL文件路径
- 返回值：Status - 操作状态
- 调用方：
  - GroupCommitBlockSinkLocalState::_remove_estimated_wal_bytes()
  - GroupCommitTable::_finish_group_commit_load()

**接口：删除WAL**
```cpp
Status delete_wal(int64_t table_id, int64_t wal_id);
```
- 功能：删除指定的WAL文件
- 参数说明：
  - table_id (int64_t, 必填) - 表ID
  - wal_id (int64_t, 必填) - WAL ID
- 返回值：Status - 操作状态
- 调用时机：事务提交成功后

**接口：添加待恢复的WAL**
```cpp
Status add_recover_wal(int64_t db_id, int64_t table_id, int64_t wal_id, std::string wal);
```
- 功能：将WAL文件添加到恢复队列
- 参数说明：
  - db_id (int64_t, 必填) - 数据库ID
  - table_id (int64_t, 必填) - 表ID
  - wal_id (int64_t, 必填) - WAL ID
  - wal (string, 必填) - WAL文件路径
- 返回值：Status - 操作状态
- 调用时机：事务提交失败后

**接口：更新预估WAL大小**
```cpp
Status update_wal_dir_estimated_wal_bytes(const std::string& wal_dir,
                                          size_t increase_estimated_wal_bytes,
                                          size_t decrease_estimated_wal_bytes);
```
- 功能：更新WAL目录的预估WAL大小，用于磁盘空间管理
- 参数说明：
  - wal_dir (const string&, 必填) - WAL目录路径
  - increase_estimated_wal_bytes (size_t, 必填) - 增加的预估大小
  - decrease_estimated_wal_bytes (size_t, 必填) - 减少的预估大小
- 返回值：Status - 操作状态
- 调用方：
  - GroupCommitBlockSinkLocalState::_add_blocks()（增加预估大小）
  - GroupCommitBlockSinkLocalState::_remove_estimated_wal_bytes()（减少预估大小）

**接口：获取可用空间**
```cpp
Status get_wal_dir_available_size(const std::string& wal_dir, size_t* available_bytes);
```
- 功能：获取指定WAL目录的可用空间
- 参数说明：
  - wal_dir (const string&, 必填) - WAL目录路径
  - available_bytes (size_t*, 必填) - 输出参数，可用空间大小
- 返回值：Status - 操作状态
- 调用方：LoadBlockQueue::has_enough_wal_disk_space()

**接口：解析WAL文件名**
```cpp
static Status parse_wal_path(const std::string& file_name, int64_t& version,
                             int64_t& backend_id, int64_t& wal_id, std::string& label);
```
- 功能：解析WAL文件名，提取版本、BE ID、WAL ID和标签
- 参数说明：
  - file_name (const string&, 必填) - WAL文件名（格式：version_backend_id_wal_id_label）
  - version (int64_t&, 必填) - 输出参数，WAL版本
  - backend_id (int64_t&, 必填) - 输出参数，BE ID
  - wal_id (int64_t&, 必填) - 输出参数，WAL ID
  - label (string&, 必填) - 输出参数，导入标签
- 返回值：Status - 操作状态
- 调用方：WalManager::_scan_wals()（扫描历史WAL文件时解析文件名）

4.2.4 WalWriter接口

WalWriter负责将数据块序列化写入WAL文件。

- 源文件：be/src/olap/wal/wal_writer.h

**接口：初始化**
```cpp
Status init(const io::FileSystemSPtr& fs);
```
- 功能：初始化WAL写入器，创建文件
- 参数说明：
  - fs (const FileSystemSPtr&, 必填) - 文件系统
- 返回值：Status - 操作状态
- 调用方：VWalWriter::init()（向量化WAL写入器封装）

**接口：写入头部**
```cpp
Status append_header(std::string col_ids);
```
- 功能：写入WAL文件头部，包含列ID信息
- 参数说明：
  - col_ids (string, 必填) - 列ID字符串
- 返回值：Status - 操作状态
- 调用方：VWalWriter::init()

**接口：写入数据块**
```cpp
Status append_blocks(const PBlockArray& blocks);
```
- 功能：将数据块序列化并写入WAL文件
- 参数说明：
  - blocks (const PBlockArray&, 必填) - PBlock数组
- 返回值：Status - 操作状态
- 调用方：VWalWriter::write_wal()

**接口：完成写入**
```cpp
Status finalize();
```
- 功能：完成WAL文件写入，关闭文件
- 返回值：Status - 操作状态
- 调用方：LoadBlockQueue::close_wal()

**常量定义**
```cpp
static const int64_t LENGTH_SIZE = 8;    // 长度字段大小（字节）
static const int64_t CHECKSUM_SIZE = 4;  // 校验和大小（字节）
static const int64_t VERSION_SIZE = 4;   // 版本字段大小（字节）
```

4.2.5 WalReader接口

WalReader负责读取和反序列化WAL文件。

- 源文件：be/src/olap/wal/wal_reader.h

**接口：初始化**
```cpp
Status init();
```
- 功能：初始化WAL读取器，打开文件
- 返回值：Status - 操作状态
- 调用方：WalTable::_read_wal_header()（WAL恢复时读取头部前初始化）

**接口：读取头部**
```cpp
Status read_header(uint32_t& version, std::string& col_ids);
```
- 功能：读取WAL文件头部
- 参数说明：
  - version (uint32_t&, 必填) - 输出参数，WAL版本
  - col_ids (string&, 必填) - 输出参数，列ID字符串
- 返回值：Status - 操作状态
- 调用方：WalTable::_read_wal_header()

**接口：读取数据块**
```cpp
Status read_block(PBlock& block);
```
- 功能：从WAL文件读取一个数据块
- 参数说明：
  - block (PBlock&, 必填) - 输出参数，读取到的PBlock
- 返回值：Status - 操作状态，到达文件末尾返回EndOfFile
- 调用方：vectorized::WalReader::get_next_block()（向量化WAL读取器）

**接口：完成读取**
```cpp
Status finalize();
```
- 功能：完成WAL文件读取，关闭文件
- 返回值：Status - 操作状态
- 调用方：WalTable::_replay_wal_internal()（WAL恢复完成后）

4.2.6 Pipeline Operator接口

Pipeline Operator实现了Group Commit在Pipeline执行框架中的集成。

- 源文件：
  - be/src/pipeline/exec/group_commit_block_sink_operator.h
  - be/src/pipeline/exec/group_commit_scan_operator.h

**GroupCommitBlockSinkOperatorX::sink()**
```cpp
Status sink(RuntimeState* state, vectorized::Block* block, bool eos);
```
- 功能：Pipeline Sink操作，将数据块写入LoadBlockQueue
- 参数说明：
  - state (RuntimeState*, 必填) - 运行时状态
  - block (Block*, 必填) - 输入数据块
  - eos (bool, 必填) - 是否到达流结束
- 返回值：Status - 操作状态
- 调用方：Pipeline执行框架（PipelineTask调度执行时自动调用）
- 实现逻辑：
  1. 初始化LoadBlockQueue（首次调用时）
  2. 验证并转换数据块
  3. 查找分区并过滤无效行
  4. 调用_add_block添加数据到队列
  5. eos时移除load_id并等待完成（sync_mode）

**GroupCommitBlockSinkLocalState::_add_block()**
```cpp
Status _add_block(RuntimeState* state, std::shared_ptr<vectorized::Block> block);
```
- 功能：添加单个数据块到队列
- 参数说明：
  - state (RuntimeState*, 必填) - 运行时状态
  - block (shared_ptr<Block>, 必填) - 待添加的数据块
- 返回值：Status - 操作状态
- 调用方：GroupCommitBlockSinkOperatorX::sink()

**GroupCommitBlockSinkLocalState::_add_blocks()**
```cpp
Status _add_blocks(RuntimeState* state, bool is_blocks_contain_all_load_data);
```
- 功能：批量添加缓存的数据块到队列，处理async_mode到sync_mode的降级
- 参数说明：
  - state (RuntimeState*, 必填) - 运行时状态
  - is_blocks_contain_all_load_data (bool, 必填) - 数据块是否包含所有导入数据
- 返回值：Status - 操作状态
- 调用方：
  - GroupCommitBlockSinkLocalState::_add_block()（超过内存行数阈值时）
  - GroupCommitBlockSinkOperatorX::sink()（eos时）

**GroupCommitBlockSinkLocalState::_initialize_load_queue()**
```cpp
Status _initialize_load_queue();
```
- 功能：初始化LoadBlockQueue，获取或创建队列
- 返回值：Status - 操作状态
- 调用方：
  - GroupCommitBlockSinkLocalState::open()
  - GroupCommitBlockSinkOperatorX::sink()（首次sink时）

**GroupCommitOperatorX::get_block()**
```cpp
Status get_block(RuntimeState* state, vectorized::Block* block, bool* eos);
```
- 功能：从LoadBlockQueue获取数据块
- 参数说明：
  - state (RuntimeState*, 必填) - 运行时状态
  - block (Block*, 必填) - 输出数据块
  - eos (bool*, 必填) - 输出参数，是否到达流结束
- 返回值：Status - 操作状态
- 调用方：Pipeline执行框架（PipelineTask调度执行时自动调用）
- 实现逻辑：调用LoadBlockQueue::get_block()获取数据

**GroupCommitLocalState::init()**
```cpp
Status init(RuntimeState* state, LocalStateInfo& info);
```
- 功能：初始化本地状态，获取LoadBlockQueue并设置依赖
- 参数说明：
  - state (RuntimeState*, 必填) - 运行时状态
  - info (LocalStateInfo&, 必填) - 本地状态初始化信息
- 返回值：Status - 操作状态
- 调用方：Pipeline执行框架（创建LocalState时）

4.2.7 Thrift RPC接口

Group Commit涉及BE与FE之间的Thrift RPC通信。

**创建内部导入RPC**
```cpp
// 请求：TStreamLoadPutRequest
// 响应：TStreamLoadPutResult
Status ThriftRpcHelper::rpc<FrontendServiceClient>(
    master_addr, 
    [&result, &request](FrontendServiceConnection& client) {
        client->streamLoadPut(result, request);
    });
```
- 功能：BE向FE发起内部导入请求，获取执行计划
- 请求参数（TStreamLoadPutRequest）：
  - db (string) - 数据库名
  - tbl (string) - 表名
  - loadId (TUniqueId) - 导入ID
  - label (string) - 导入标签
  - load_sql (string) - 内部导入SQL
  - token (string) - 认证Token
  - backend_id (int64_t) - BE ID
- 响应参数（TStreamLoadPutResult）：
  - status (TStatus) - 操作状态
  - pipeline_params (TPipelineFragmentParams) - Pipeline执行参数
  - base_schema_version (int64_t) - Schema版本
  - table_indexes_size (int64_t) - 索引数量
  - wait_internal_group_commit_finish (bool) - 是否等待内部导入完成
  - group_commit_interval_ms (int64_t) - 提交时间间隔
  - group_commit_data_bytes (int64_t) - 提交数据量阈值
- 调用方：GroupCommitTable::_create_group_commit_load()

**提交事务RPC**
```cpp
// 请求：TLoadTxnCommitRequest
// 响应：TLoadTxnCommitResult
Status ThriftRpcHelper::rpc<FrontendServiceClient>(
    master_addr,
    [&result, &request](FrontendServiceConnection& client) {
        client->loadTxnCommit(result, request);
    });
```
- 功能：BE向FE发起事务提交请求
- 请求参数（TLoadTxnCommitRequest）：
  - db_id (int64_t) - 数据库ID
  - table_id (int64_t) - 表ID
  - txnId (int64_t) - 事务ID
  - commitInfos (list<TTabletCommitInfo>) - Tablet提交信息
  - auth_code (int64_t) - 认证码（已废弃，使用token）
  - token (string) - 认证Token
  - groupCommit (bool) - 是否为Group Commit（设为true）
  - receiveBytes (int64_t) - 接收的数据字节数
  - backendId (int64_t) - BE ID
- 响应参数（TLoadTxnCommitResult）：
  - status (TStatus) - 操作状态
- 调用方：GroupCommitTable::_finish_group_commit_load()（status.ok()时）
- 重试机制：遇到DELETE_BITMAP_LOCK_ERROR时最多重试config::mow_stream_load_commit_retry_times次

**回滚事务RPC**
```cpp
// 请求：TLoadTxnRollbackRequest
// 响应：TLoadTxnRollbackResult
Status ThriftRpcHelper::rpc<FrontendServiceClient>(
    master_addr,
    [&result, &request](FrontendServiceConnection& client) {
        client->loadTxnRollback(result, request);
    });
```
- 功能：BE向FE发起事务回滚请求
- 请求参数（TLoadTxnRollbackRequest）：
  - db_id (int64_t) - 数据库ID
  - txnId (int64_t) - 事务ID
  - reason (string) - 回滚原因
  - auth_code (int64_t) - 认证码（已废弃，使用token）
  - token (string) - 认证Token
- 响应参数（TLoadTxnRollbackResult）：
  - status (TStatus) - 操作状态
- 调用方：GroupCommitTable::_finish_group_commit_load()（status不OK时）

5. 配置设计

5.1 配置文件

5.1.1 文件：Session变量配置

- 文件格式：Session变量（通过SET语句设置）
- 配置项：

| 配置项 | 类型 | 默认值 | 说明 | 环境差异 |
|-------|------|-------|------|---------|
| group_commit | String | off_mode | Group Commit模式：off_mode/sync_mode/async_mode | 无 |
| enable_prepared_stmt_audit_log | boolean | false | 是否打印PreparedStatement的审计日志 | 无 |

- 热更新支持：是（会话级别立即生效）

5.1.2 文件：表属性配置

- 文件格式：通过ALTER TABLE设置
- 配置项：

| 配置项 | 类型 | 默认值 | 说明 | 环境差异 |
|-------|------|-------|------|---------|
| group_commit_interval_ms | long | 10000 | 提交时间间隔（毫秒） | 无 |
| group_commit_data_bytes | long | 67108864 | 提交数据量阈值（字节，64MB） | 无 |

- 热更新支持：是（ALTER TABLE后立即生效）
- 配置示例：
```sql
ALTER TABLE dt SET ("group_commit_interval_ms" = "2000");
ALTER TABLE dt SET ("group_commit_data_bytes" = "134217728");
```

5.1.3 文件：BE配置（be.conf）

- 文件格式：Properties
- 源文件：`be/src/common/config.cpp`
- 配置项：

| 配置项 | 类型 | 默认值 | 说明 | 热更新 |
|-------|------|-------|------|--------|
| group_commit_wal_path | String | "" (空) | WAL文件存储路径，多路径用分号分隔。为空时使用 {storage_root_path}/wal | 否 |
| group_commit_replay_wal_retry_num | Int32 | 10 | WAL重放失败时的最大重试次数 | 否 |
| group_commit_replay_wal_retry_interval_seconds | Int32 | 5 | WAL重放重试的初始间隔时间（秒） | 否 |
| group_commit_replay_wal_retry_interval_max_seconds | Int32 | 1800 | WAL重放重试的最大间隔时间（秒，30分钟），使用指数退避策略 | 否 |
| group_commit_relay_wal_threads | Int32 | 10 | WAL重放线程池大小 | 否 |
| group_commit_insert_threads | Int32 | 10 | Group Commit请求Fragment线程池大小 | 否 |
| group_commit_memory_rows_for_max_filter_ratio | Int32 | 10000 | 用于计算max_filter_ratio的内存行数阈值 | 否 |
| wait_internal_group_commit_finish | Bool | false | 是否等待内部Group Commit完成后再返回 | 否 |
| group_commit_queue_mem_limit | Int32 | 67108864 | Group Commit队列的最大内存限制（字节，默认64MB），用于内存反压 | 是 |
| group_commit_wal_max_disk_limit | String | "10%" | WAL磁盘使用上限，支持绝对值（字节）或百分比格式，用于磁盘空间反压 | 否 |
| group_commit_wait_replay_wal_finish | Bool | false | BE启动时是否等待所有WAL重放完成 | 否 |

- 热更新说明：
  - 标记为"是"的配置项可通过HTTP API动态修改，无需重启BE
  - 标记为"否"的配置项需要修改be.conf并重启BE生效

- 配置示例：
```properties
# WAL存储路径配置（多路径分散IO压力）
group_commit_wal_path=/data1/storage/wal;/data2/storage/wal;/data3/storage/wal

# WAL重放配置
group_commit_replay_wal_retry_num=10
group_commit_replay_wal_retry_interval_seconds=5
group_commit_replay_wal_retry_interval_max_seconds=1800

# 线程池配置
group_commit_relay_wal_threads=10
group_commit_insert_threads=10

# 内存与磁盘反压配置
group_commit_queue_mem_limit=67108864
group_commit_wal_max_disk_limit=10%

# 调试配置
wait_internal_group_commit_finish=false
group_commit_wait_replay_wal_finish=false
```

- 配置建议：
  - **生产环境**：建议配置多个WAL路径以分散IO压力，并根据磁盘容量调整`group_commit_wal_max_disk_limit`
  - **高并发场景**：可适当增加`group_commit_insert_threads`和`group_commit_relay_wal_threads`
  - **内存受限环境**：减小`group_commit_queue_mem_limit`以降低内存使用

6. 错误处理设计

6.1 错误分类

| 错误类型 | 错误码范围 | 处理策略 | 日志级别 |
|---------|----------|---------|---------|
| 系统错误 | 5000-5999 | 记录日志，尝试恢复 | ERROR |
| IO错误 | 6000-6999 | 自动降级sync_mode | WARN |
| 业务错误 | 7000-7999 | 返回错误信息 | INFO |
| 配置错误 | 8000-8999 | 使用默认值 | WARN |

6.2 错误处理机制

- 重试机制：
  - WAL写入失败：不重试，直接降级为sync_mode
  - 事务提交失败：重试3次，间隔1秒
  - 网络错误：由客户端重试

- 降级方案：
  - async_mode自动降级触发条件：
    - 导入数据量超过WAL单目录80%空间
    - chunked stream load（不知道数据量）
    - 磁盘可用空间不足
  - 降级后行为：切换为sync_mode处理当前请求

- 报警机制：
  - 报警条件：
    - WAL磁盘空间使用率 > 80%
    - 事务提交连续失败 > 3次
    - BE重启时发现大量未恢复的WAL
  - 报警方式：
    - 记录ERROR日志
    - BE metrics指标上报

7. 部署与运维设计

7.1 监控指标

| 指标名称 | 采集方式 | 报警阈值 | 处理建议 |
|---------|---------|---------|---------|
| group_commit_buffer_size | BE metrics | > 500MB | 检查提交是否正常 |
| group_commit_wal_size | BE metrics | > 磁盘80% | 扩容或检查提交 |
| group_commit_commit_count | BE metrics | - | 监控提交频率 |
| group_commit_commit_latency | BE metrics | > 30s | 检查系统负载 |
| group_commit_fallback_count | BE metrics | > 10/min | 检查磁盘空间 |

7.2 日志规范

- 日志级别：
  - DEBUG：详细的请求处理信息
  - INFO：正常的提交操作、WAL写入
  - WARN：降级操作、配置问题
  - ERROR：系统错误、恢复失败

- 日志格式：
```
[timestamp] [level] [thread] [class] [tableId] [txnId] message [key=value]*
```

- 日志示例：
```
2025-01-26 10:30:45.123 INFO [GroupCommitTrigger-1] [GroupCommitTrigger] [table_123] Trigger commit, batches=50, dataBytes=67108864
2025-01-26 10:30:45.456 INFO [WalManager-1] [WalManager] [table_123] WAL write success, recordId=1001, dataBytes=1024
2025-01-26 10:30:45.789 WARN [AsyncModeHandler-1] [AsyncModeHandler] [table_123] Fallback to sync_mode, reason=data_too_large
2025-01-26 10:30:46.012 ERROR [WalManager-1] [WalManager] WAL write failed, path=/data1/wal, error=No space left
```

- 关键日志点：
  - 模式选择：记录使用的Group Commit模式
  - WAL操作：记录WAL写入、恢复、清理
  - 触发提交：记录提交触发原因（时间/数据量）
  - 降级操作：记录降级原因
  - 异常处理：记录异常详情和处理结果
