1. 文档基本信息

1.1 功能标识

- 功能名称：Group Commit（高并发导入优化）
- 功能编码：DB-FUNC-002-DD
- 关联文档：
  - 需求文档：Group Commit 需求定义文档 V1.0
  - 概要设计文档：Group Commit 概要设计文档 V1.0
- 设计版本：V1.0
- 设计日期：2025-01-26
- 设计人员：陈明雨

2. 设计概述

2.1 设计范围

- 本次设计覆盖Group Commit功能的完整实现，包括FE端和BE端的核心模块设计
- FE端设计范围：
  - PreparedStatement缓存机制
  - Group Commit模式判断逻辑
  - 数据路由分发
- BE端设计范围：
  - 数据接收与缓存
  - 同步模式处理（sync_mode）
  - 异步模式处理（async_mode）
  - WAL写入与恢复
  - 事务合并与提交触发
- 支持的导入方式：
  - INSERT INTO VALUES语句
  - Stream Load导入
- 不包括的内容：
  - 其他导入方式的Group Commit支持（如Routine Load）
  - 多表事务支持

2.2 设计目标

- 技术实现目标：
  - 实现高并发小批量导入的事务合并机制
  - 实现同步和异步两种提交模式
  - 实现WAL机制保证异步模式下的数据可靠性
  - 实现PreparedStatement缓存减少SQL解析开销
- 质量属性目标：
  - 性能：高并发场景下吞吐量提升5-10倍
  - 可靠性：async_mode通过WAL保证数据不丢失
  - 可维护性：模块职责清晰，接口设计合理
  - 可配置性：支持通过参数灵活调整行为

3. 模块详细设计

3.1 模块结构

```
Group Commit模块
├── FE端模块
│   ├── 缓存模块
│   │   └── PreparedStatementContext类
│   │       ├── sqlCache (SQL缓存)
│   │       └── planCache (执行计划缓存)
│   ├── 模式判断模块
│   │   └── GroupCommitPlanner类
│   │       ├── shouldUseGroupCommit()方法
│   │       └── selectMode()方法
│   └── 路由分发模块
│       └── DataRouter类
│           ├── selectBackend()方法
│           └── sendData()方法
└── BE端模块
    ├── 数据接收模块
    │   └── GroupCommitReceiver类
    │       ├── receiveData()方法
    │       └── dispatch()方法
    ├── 数据缓存模块
    │   └── GroupCommitBuffer类
    │       ├── addBatch()方法
    │       ├── getBatches()方法
    │       ├── clear()方法
    │       └── checkTriggerCondition()方法
    ├── 模式处理模块
    │   ├── SyncModeHandler类
    │   │   ├── handle()方法
    │   │   └── waitForCommit()方法
    │   └── AsyncModeHandler类
    │       ├── handle()方法
    │       └── returnImmediate()方法
    ├── 事务合并模块
    │   ├── GroupCommitMerger类
    │   │   ├── merge()方法
    │   │   └── createTransaction()方法
    │   └── GroupCommitTrigger类
    │       ├── checkTimeCondition()方法
    │       ├── checkDataCondition()方法
    │       └── triggerCommit()方法
    └── WAL模块
        └── WalManager类
            ├── write()方法
            ├── read()方法
            ├── recover()方法
            └── cleanup()方法
```

3.2 类设计

3.2.1 类名：GroupCommitBuffer

- 类职责：管理待合并的数据缓存，支持多线程安全的数据添加和获取
- 类关系：
  - 依赖：RowBatch、TableId
  - 关联：被GroupCommitReceiver写入，被GroupCommitMerger读取
- 属性列表：

| 属性名 | 类型 | 默认值 | 说明 | 约束 |
|-------|------|-------|------|------|
| tableId | TableId | - | 表标识 | 必填 |
| pendingBatches | List<RowBatch> | 空列表 | 待合并的数据批次 | 线程安全 |
| currentDataBytes | AtomicLong | 0 | 当前缓存数据量（字节） | >= 0 |
| firstBatchTime | AtomicLong | 0 | 首次数据进入时间 | 毫秒时间戳 |
| lock | ReentrantLock | - | 同步锁 | - |
| commitCondition | Condition | - | 提交等待条件 | - |
| commitIntervalMs | long | 10000 | 提交时间间隔 | 毫秒 |
| commitDataBytes | long | 67108864 | 提交数据量阈值 | 字节，默认64MB |

- 方法列表：

| 方法签名 | 返回类型 | 参数 | 说明 | 异常 |
|---------|---------|------|------|------|
| addBatch(RowBatch batch) | void | batch: 数据批次 | 添加数据到缓存 | BufferFullException |
| getBatches() | List<RowBatch> | - | 获取并清空所有缓存数据 | - |
| checkTriggerCondition() | boolean | - | 检查是否满足提交触发条件 | - |
| waitForCommit(long timeoutMs) | boolean | timeoutMs: 超时时间 | 等待提交完成 | InterruptedException |
| notifyCommit() | void | - | 通知等待的线程提交已完成 | - |
| getDataSize() | long | - | 获取当前缓存数据量 | - |

3.2.2 类名：WalManager

- 类职责：管理WAL文件的写入、读取和恢复
- 类关系：
  - 依赖：WalRecord、FileSystem
  - 关联：被AsyncModeHandler调用写入，BE启动时调用恢复
- 属性列表：

| 属性名 | 类型 | 默认值 | 说明 | 约束 |
|-------|------|-------|------|------|
| walPaths | List<String> | - | WAL文件存储路径列表 | 配置项 |
| currentWriter | WalWriter | - | 当前WAL写入器 | - |
| recordIdGenerator | AtomicLong | 0 | 记录ID生成器 | - |
| lock | ReentrantLock | - | 同步锁 | - |
| pendingRecords | Map<Long, WalRecord> | - | 待提交的WAL记录 | 线程安全 |

- 方法列表：

| 方法签名 | 返回类型 | 参数 | 说明 | 异常 |
|---------|---------|------|------|------|
| write(WalRecord record) | long | record: WAL记录 | 写入WAL，返回recordId | IOException |
| markCommitted(long recordId) | void | recordId: 记录ID | 标记记录已提交 | - |
| recover() | List<WalRecord> | - | 恢复未提交的WAL记录 | IOException |
| cleanup() | void | - | 清理已提交的WAL文件 | IOException |
| getWalSize() | long | - | 获取WAL占用空间 | - |
| checkDiskSpace() | boolean | - | 检查磁盘空间是否充足 | - |

3.2.3 类名：GroupCommitTrigger

- 类职责：监控提交触发条件，触发事务合并和提交
- 类关系：
  - 依赖：GroupCommitBuffer、GroupCommitMerger
  - 实现：Runnable接口（后台线程）
- 属性列表：

| 属性名 | 类型 | 默认值 | 说明 | 约束 |
|-------|------|-------|------|------|
| buffers | Map<TableId, GroupCommitBuffer> | - | 表ID到Buffer的映射 | 线程安全 |
| merger | GroupCommitMerger | - | 事务合并器 | - |
| running | AtomicBoolean | true | 运行状态 | - |
| checkIntervalMs | long | 100 | 检查间隔 | 毫秒 |

- 方法列表：

| 方法签名 | 返回类型 | 参数 | 说明 | 异常 |
|---------|---------|------|------|------|
| run() | void | - | 后台线程主循环 | - |
| checkAllBuffers() | void | - | 检查所有Buffer的触发条件 | - |
| triggerCommit(TableId tableId) | void | tableId: 表ID | 触发指定表的提交 | - |
| stop() | void | - | 停止后台线程 | - |
| registerBuffer(TableId tableId, GroupCommitBuffer buffer) | void | - | 注册新的Buffer | - |

3.2.4 类名：SyncModeHandler

- 类职责：处理同步模式的导入逻辑
- 类关系：
  - 依赖：GroupCommitBuffer
  - 关联：被GroupCommitReceiver调用
- 属性列表：

| 属性名 | 类型 | 默认值 | 说明 | 约束 |
|-------|------|-------|------|------|
| buffer | GroupCommitBuffer | - | 数据缓存 | - |
| defaultTimeoutMs | long | 30000 | 默认等待超时 | 毫秒 |

- 方法列表：

| 方法签名 | 返回类型 | 参数 | 说明 | 异常 |
|---------|---------|------|------|------|
| handle(RowBatch batch) | CommitResult | batch: 数据批次 | 处理同步模式导入 | TimeoutException |
| waitForCommit() | CommitResult | - | 等待事务提交完成 | TimeoutException |

3.2.5 类名：AsyncModeHandler

- 类职责：处理异步模式的导入逻辑
- 类关系：
  - 依赖：WalManager、GroupCommitBuffer
  - 关联：被GroupCommitReceiver调用
- 属性列表：

| 属性名 | 类型 | 默认值 | 说明 | 约束 |
|-------|------|-------|------|------|
| walManager | WalManager | - | WAL管理器 | - |
| buffer | GroupCommitBuffer | - | 数据缓存 | - |
| maxWalDataBytes | long | - | WAL单目录80%空间 | - |

- 方法列表：

| 方法签名 | 返回类型 | 参数 | 说明 | 异常 |
|---------|---------|------|------|------|
| handle(RowBatch batch) | PrepareResult | batch: 数据批次 | 处理异步模式导入 | IOException |
| writeToWal(RowBatch batch) | long | batch: 数据批次 | 写入WAL | IOException |
| shouldFallbackToSync(RowBatch batch) | boolean | batch: 数据批次 | 判断是否需要降级为同步模式 | - |

3.3 关键方法详细设计

3.3.1 方法名：GroupCommitBuffer.addBatch(RowBatch batch)

- 功能描述：将数据批次添加到缓存中，更新统计信息，如果是首次添加则记录时间

- 算法描述：
```
1. 获取锁
2. 如果firstBatchTime为0，设置为当前时间
3. 将batch添加到pendingBatches列表
4. 更新currentDataBytes（加上batch的数据量）
5. 检查是否满足触发条件（checkTriggerCondition）
6. 如果满足，唤醒等待的提交线程
7. 释放锁
```

- 输入参数：

| 参数名 | 类型 | 是否必填 | 描述 | 校验规则 |
|-------|------|---------|------|---------|
| batch | RowBatch | 是 | 待添加的数据批次 | 非空 |

- 返回值：void

- 异常处理：

| 异常类型 | 触发条件 | 处理方式 |
|---------|---------|---------|
| BufferFullException | 缓存已达上限 | 向上抛出，由调用方处理 |

- 性能考虑：
  - 时间复杂度：O(1)
  - 空间复杂度：O(n)，n为batch中的行数

3.3.2 方法名：WalManager.write(WalRecord record)

- 功能描述：将WAL记录写入WAL文件，确保持久化成功

- 算法描述：
```
1. 生成recordId
2. 设置record的recordId和时间戳
3. 获取锁
4. 选择WAL文件（根据walPaths轮询或空间判断）
5. 序列化record为字节数组
6. 写入WAL文件
7. 调用fsync确保持久化
8. 将record添加到pendingRecords
9. 释放锁
10. 返回recordId
```

- 输入参数：

| 参数名 | 类型 | 是否必填 | 描述 | 校验规则 |
|-------|------|---------|------|---------|
| record | WalRecord | 是 | WAL记录 | 非空，包含tableId和data |

- 返回值：

| 字段 | 类型 | 描述 |
|-----|------|------|
| recordId | long | WAL记录的唯一标识 |

- 异常处理：

| 异常类型 | 触发条件 | 处理方式 |
|---------|---------|---------|
| IOException | 文件写入失败 | 向上抛出，由调用方切换为sync_mode |
| DiskFullException | 磁盘空间不足 | 向上抛出，由调用方切换为sync_mode |

- 性能考虑：
  - 时间复杂度：O(n)，n为数据大小
  - 空间复杂度：O(n)

3.3.3 方法名：GroupCommitTrigger.run()

- 功能描述：后台线程主循环，定期检查所有Buffer的触发条件，满足条件时触发提交

- 算法描述：
```
1. while (running) {
2.   遍历所有buffers
3.   对于每个buffer：
4.     如果buffer.checkTriggerCondition()返回true：
5.       调用triggerCommit(tableId)
6.   sleep(checkIntervalMs)
7. }
```

- 输入参数：无

- 返回值：void

- 异常处理：

| 异常类型 | 触发条件 | 处理方式 |
|---------|---------|---------|
| InterruptedException | 线程被中断 | 退出循环，设置running为false |

- 性能考虑：
  - 时间复杂度：O(m)，m为buffer数量
  - 空间复杂度：O(1)

3.3.4 方法名：AsyncModeHandler.handle(RowBatch batch)

- 功能描述：处理异步模式的导入请求，写入WAL后立即返回

- 算法描述：
```
1. 检查是否需要降级为同步模式（shouldFallbackToSync）
   - 数据量过大（超过WAL单目录80%空间）
   - chunked stream load
   - 磁盘空间不足
2. 如果需要降级：
   - 调用SyncModeHandler.handle(batch)
   - 返回同步模式的结果
3. 否则：
   - 构造WalRecord
   - 调用walManager.write(record)获取recordId
   - 异步将数据放入buffer（提交后台任务）
   - 构造PrepareResult，包含label和txnId
   - 立即返回PrepareResult
```

- 输入参数：

| 参数名 | 类型 | 是否必填 | 描述 | 校验规则 |
|-------|------|---------|------|---------|
| batch | RowBatch | 是 | 数据批次 | 非空 |

- 返回值：

| 字段 | 类型 | 描述 |
|-----|------|------|
| label | String | 以group_commit_开头的标签 |
| status | String | PREPARE |
| txnId | long | 事务ID |

- 异常处理：

| 异常类型 | 触发条件 | 处理方式 |
|---------|---------|---------|
| IOException | WAL写入失败 | 自动降级为sync_mode |

- 性能考虑：
  - 时间复杂度：O(n)，n为数据大小
  - 空间复杂度：O(n)

3.3.5 方法名：WalManager.recover()

- 功能描述：BE启动时恢复未提交的WAL记录

- 算法描述：
```
1. 遍历所有walPaths
2. 对于每个路径下的WAL文件：
   a. 读取文件内容
   b. 反序列化为WalRecord列表
   c. 过滤出状态为PENDING的记录
   d. 添加到待恢复列表
3. 按recordId排序（保证恢复顺序）
4. 返回待恢复的WalRecord列表
5. 调用方负责将这些记录重新放入Buffer
```

- 输入参数：无

- 返回值：

| 字段 | 类型 | 描述 |
|-----|------|------|
| records | List<WalRecord> | 待恢复的WAL记录列表 |

- 异常处理：

| 异常类型 | 触发条件 | 处理方式 |
|---------|---------|---------|
| IOException | 文件读取失败 | 记录日志，跳过损坏的文件 |

- 性能考虑：
  - 时间复杂度：O(n)，n为WAL记录数量
  - 空间复杂度：O(n)

4. 接口详细设计

4.1 API接口

4.1.1 接口名称：INSERT INTO VALUES（Group Commit模式）

- 请求方式：SQL语句
- 使用方式：
```sql
-- 设置Group Commit模式
SET group_commit = async_mode;  -- 或 sync_mode

-- 执行插入
INSERT INTO table_name (col1, col2, col3) VALUES (val1, val2, val3);
```

- 请求参数：
  - 标准INSERT INTO VALUES语法

- 响应格式：
```
Query OK, N rows affected (X.XX sec)
{'label':'group_commit_xxxxx', 'status':'PREPARE', 'txnId':'12345'}
```

- 错误码定义：

| 错误码 | 错误信息 | 说明 |
|-------|---------|------|
| 1064 | Syntax error | SQL语法错误 |
| 1142 | INSERT denied | 权限不足 |
| 1062 | Duplicate entry | 主键冲突（Unique模型） |

- 示例请求/响应：
```sql
mysql> SET group_commit = async_mode;
Query OK, 0 rows affected (0.00 sec)

mysql> INSERT INTO dt VALUES(1, 'Bob', 90), (2, 'Alice', 99);
Query OK, 2 rows affected (0.05 sec)
{'label':'group_commit_a145ce07f1c972fc-bd2c54597052a9ad', 'status':'PREPARE', 'txnId':'181508'}
```

4.1.2 接口名称：Stream Load（Group Commit模式）

- 请求方式：HTTP PUT
- URL路径：`http://{fe_host}:{http_port}/api/{db}/{table}/_stream_load`
- 请求头：

| 头字段 | 是否必须 | 示例值 | 说明 |
|-------|---------|-------|------|
| group_commit | 是 | async_mode | Group Commit模式 |
| column_separator | 否 | , | 列分隔符 |
| Authorization | 是 | Basic xxx | 认证信息 |

- 请求参数：
  - Body：CSV或JSON格式的数据内容

- 响应格式：
```json
{
    "TxnId": 7009,
    "Label": "group_commit_c84d2099208436ab_96e33fda01eddba8",
    "Comment": "",
    "GroupCommit": true,
    "Status": "Success",
    "Message": "OK",
    "NumberTotalRows": 2,
    "NumberLoadedRows": 2,
    "NumberFilteredRows": 0,
    "NumberUnselectedRows": 0,
    "LoadBytes": 19,
    "LoadTimeMs": 35
}
```

- 错误码定义：

| 错误码 | 错误信息 | 说明 |
|-------|---------|------|
| FAILED | Authentication failed | 认证失败 |
| FAILED | Table not found | 表不存在 |
| FAILED | Data format error | 数据格式错误 |

- 示例请求/响应：
```bash
# 请求
curl --location-trusted -u root: \
    -T data.csv \
    -H "group_commit:async_mode" \
    -H "column_separator:," \
    http://127.0.0.1:8030/api/db/dt/_stream_load

# 响应
{
    "TxnId": 7009,
    "Label": "group_commit_c84d2099208436ab_96e33fda01eddba8",
    "GroupCommit": true,
    "Status": "Success",
    "Message": "OK",
    "NumberTotalRows": 2,
    "NumberLoadedRows": 2
}
```

4.2 内部接口

4.2.1 服务接口

- 接口名称：GroupCommitBuffer.addBatch()
- 方法签名：
```java
public void addBatch(RowBatch batch) throws BufferFullException
```
- 参数说明：
  - batch (RowBatch, 必填) - 待添加的数据批次，包含行数据和元信息
- 返回值说明：
  - void
- 依赖服务：无

4.2.2 服务接口

- 接口名称：WalManager.write()
- 方法签名：
```java
public long write(WalRecord record) throws IOException
```
- 参数说明：
  - record (WalRecord, 必填) - WAL记录，包含tableId、data、timestamp
- 返回值说明：
  - long - 生成的recordId，用于后续标记提交状态
- 依赖服务：
  - 文件系统服务

4.2.3 服务接口

- 接口名称：GroupCommitTrigger.triggerCommit()
- 方法签名：
```java
public void triggerCommit(TableId tableId)
```
- 参数说明：
  - tableId (TableId, 必填) - 表标识
- 返回值说明：
  - void
- 依赖服务：
  - GroupCommitMerger - 事务合并
  - GroupCommitBuffer - 数据获取

4.2.4 服务接口

- 接口名称：WalManager.recover()
- 方法签名：
```java
public List<WalRecord> recover() throws IOException
```
- 参数说明：无
- 返回值说明：
  - List<WalRecord> - 待恢复的WAL记录列表
- 依赖服务：
  - 文件系统服务

5. 配置设计

5.1 配置文件

5.1.1 文件：Session变量配置

- 文件格式：Session变量（通过SET语句设置）
- 配置项：

| 配置项 | 类型 | 默认值 | 说明 | 环境差异 |
|-------|------|-------|------|---------|
| group_commit | String | off_mode | Group Commit模式：off_mode/sync_mode/async_mode | 无 |
| enable_prepared_stmt_audit_log | boolean | false | 是否打印PreparedStatement的审计日志 | 无 |

- 热更新支持：是（会话级别立即生效）

5.1.2 文件：表属性配置

- 文件格式：通过ALTER TABLE设置
- 配置项：

| 配置项 | 类型 | 默认值 | 说明 | 环境差异 |
|-------|------|-------|------|---------|
| group_commit_interval_ms | long | 10000 | 提交时间间隔（毫秒） | 无 |
| group_commit_data_bytes | long | 67108864 | 提交数据量阈值（字节，64MB） | 无 |

- 热更新支持：是（ALTER TABLE后立即生效）
- 配置示例：
```sql
ALTER TABLE dt SET ("group_commit_interval_ms" = "2000");
ALTER TABLE dt SET ("group_commit_data_bytes" = "134217728");
```

5.1.3 文件：BE配置（be.conf）

- 文件格式：Properties
- 配置项：

| 配置项 | 类型 | 默认值 | 说明 | 环境差异 |
|-------|------|-------|------|---------|
| group_commit_wal_path | String | {storage_root_path}/wal | WAL文件存储路径 | 无 |

- 热更新支持：否（需要重启BE）
- 配置示例：
```
group_commit_wal_path=/data1/storage/wal;/data2/storage/wal;/data3/storage/wal
```

6. 错误处理设计

6.1 错误分类

| 错误类型 | 错误码范围 | 处理策略 | 日志级别 |
|---------|----------|---------|---------|
| 系统错误 | 5000-5999 | 记录日志，尝试恢复 | ERROR |
| IO错误 | 6000-6999 | 自动降级sync_mode | WARN |
| 业务错误 | 7000-7999 | 返回错误信息 | INFO |
| 配置错误 | 8000-8999 | 使用默认值 | WARN |

6.2 错误处理机制

- 重试机制：
  - WAL写入失败：不重试，直接降级为sync_mode
  - 事务提交失败：重试3次，间隔1秒
  - 网络错误：由客户端重试

- 降级方案：
  - async_mode自动降级触发条件：
    - 导入数据量超过WAL单目录80%空间
    - chunked stream load（不知道数据量）
    - 磁盘可用空间不足
  - 降级后行为：切换为sync_mode处理当前请求

- 报警机制：
  - 报警条件：
    - WAL磁盘空间使用率 > 80%
    - 事务提交连续失败 > 3次
    - BE重启时发现大量未恢复的WAL
  - 报警方式：
    - 记录ERROR日志
    - BE metrics指标上报

7. 部署与运维设计

7.1 监控指标

| 指标名称 | 采集方式 | 报警阈值 | 处理建议 |
|---------|---------|---------|---------|
| group_commit_buffer_size | BE metrics | > 500MB | 检查提交是否正常 |
| group_commit_wal_size | BE metrics | > 磁盘80% | 扩容或检查提交 |
| group_commit_commit_count | BE metrics | - | 监控提交频率 |
| group_commit_commit_latency | BE metrics | > 30s | 检查系统负载 |
| group_commit_fallback_count | BE metrics | > 10/min | 检查磁盘空间 |

7.2 日志规范

- 日志级别：
  - DEBUG：详细的请求处理信息
  - INFO：正常的提交操作、WAL写入
  - WARN：降级操作、配置问题
  - ERROR：系统错误、恢复失败

- 日志格式：
```
[timestamp] [level] [thread] [class] [tableId] [txnId] message [key=value]*
```

- 日志示例：
```
2025-01-26 10:30:45.123 INFO [GroupCommitTrigger-1] [GroupCommitTrigger] [table_123] Trigger commit, batches=50, dataBytes=67108864
2025-01-26 10:30:45.456 INFO [WalManager-1] [WalManager] [table_123] WAL write success, recordId=1001, dataBytes=1024
2025-01-26 10:30:45.789 WARN [AsyncModeHandler-1] [AsyncModeHandler] [table_123] Fallback to sync_mode, reason=data_too_large
2025-01-26 10:30:46.012 ERROR [WalManager-1] [WalManager] WAL write failed, path=/data1/wal, error=No space left
```

- 关键日志点：
  - 模式选择：记录使用的Group Commit模式
  - WAL操作：记录WAL写入、恢复、清理
  - 触发提交：记录提交触发原因（时间/数据量）
  - 降级操作：记录降级原因
  - 异常处理：记录异常详情和处理结果
