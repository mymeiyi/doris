1. 功能设计概述

1.1 功能基本信息

- 功能名称：Group Commit（高并发导入优化）
- 关联需求编号：DB-FUNC-002
- 设计负责人：陈明雨
- 设计日期：2025-01-26
- 版本：V1.0

1.2 设计目标

- 优化Doris在高频小批量写入场景下的导入性能，解决传统模式下每个导入创建独立事务的开销问题
- 通过将多个小批量导入合并成一个大事务提交，减少版本数增长，降低compaction压力
- 提供同步和异步两种模式，满足不同场景对数据可见性延迟的要求
- 通过WAL机制保证异步模式下的数据可靠性
- 提升系统的并发处理能力和整体吞吐量

2. 整体架构设计

2.1 架构示意图

Group Commit采用FE和BE协同工作的架构模式：

┌─────────────────────────────────────────────────────────────────────┐
│                          客户端层                                    │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐     │
│  │  JDBC Client    │  │  MySQL Client   │  │  HTTP Client    │     │
│  │  (PreparedStmt) │  │  (INSERT INTO)  │  │  (Stream Load)  │     │
│  └────────┬────────┘  └────────┬────────┘  └────────┬────────┘     │
└───────────┼────────────────────┼────────────────────┼───────────────┘
            │                    │                    │
            ▼                    ▼                    ▼
┌─────────────────────────────────────────────────────────────────────┐
│                      FE (Frontend)                                   │
│  ┌───────────────────────────────────────────────────────────────┐  │
│  │  SQL解析与执行计划                                              │  │
│  │  ┌─────────────────────────────────────────────────────────┐  │  │
│  │  │ PreparedStatement缓存（Session级别）                      │  │  │
│  │  │ - 缓存SQL解析结果和执行计划                               │  │  │
│  │  │ - 减少重复SQL的解析开销                                   │  │  │
│  │  └─────────────────────────────────────────────────────────┘  │  │
│  │           ↓                                                    │  │
│  │  ┌─────────────────────────────────────────────────────────┐  │  │
│  │  │ Group Commit模式判断                                      │  │  │
│  │  │ - 检查session变量group_commit                            │  │  │
│  │  │ - 判断是否满足Group Commit条件                            │  │  │
│  │  └─────────────────────────────────────────────────────────┘  │  │
│  │           ↓                                                    │  │
│  │  ┌─────────────────────────────────────────────────────────┐  │  │
│  │  │ 路由分发                                                  │  │  │
│  │  │ - 将数据发送到对应的BE节点                                │  │  │
│  │  └─────────────────────────────────────────────────────────┘  │  │
│  └───────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────┘
                              ↕
┌─────────────────────────────────────────────────────────────────────┐
│                      BE (Backend)                                    │
│  ┌───────────────────────────────────────────────────────────────┐  │
│  │  Group Commit处理模块                                          │  │
│  │  ┌─────────────────────────────────────────────────────────┐  │  │
│  │  │ 数据接收与缓存                                            │  │  │
│  │  │ - 接收来自FE的导入数据                                    │  │  │
│  │  │ - 按表进行数据分组缓存                                    │  │  │
│  │  └─────────────────────────────────────────────────────────┘  │  │
│  │           ↓                                                    │  │
│  │  ┌─────────────────────────────────────────────────────────┐  │  │
│  │  │ 模式分支处理                                              │  │  │
│  │  │                                                           │  │  │
│  │  │  ┌───────────────────┐    ┌───────────────────┐         │  │  │
│  │  │  │ sync_mode         │    │ async_mode        │         │  │  │
│  │  │  │ - 等待合并条件满足 │    │ - 写入WAL文件     │         │  │  │
│  │  │  │ - 批量提交事务    │    │ - 立即返回        │         │  │  │
│  │  │  │ - 返回结果        │    │ - 异步批量提交    │         │  │  │
│  │  │  └───────────────────┘    └───────────────────┘         │  │  │
│  │  └─────────────────────────────────────────────────────────┘  │  │
│  │           ↓                                                    │  │
│  │  ┌─────────────────────────────────────────────────────────┐  │  │
│  │  │ 事务合并与提交                                            │  │  │
│  │  │ - 根据时间间隔或数据量触发提交                            │  │  │
│  │  │ - 将多个小批量数据合并为一个事务                          │  │  │
│  │  │ - 减少版本数增长                                          │  │  │
│  │  └─────────────────────────────────────────────────────────┘  │  │
│  └───────────────────────────────────────────────────────────────┘  │
│                                                                      │
│  ┌───────────────────────────────────────────────────────────────┐  │
│  │  WAL模块（async_mode专用）                                     │  │
│  │  ┌─────────────────────────────────────────────────────────┐  │  │
│  │  │ WAL写入                                                   │  │  │
│  │  │ - 将数据写入WAL文件                                       │  │  │
│  │  │ - 保证数据持久化                                          │  │  │
│  │  └─────────────────────────────────────────────────────────┘  │  │
│  │  ┌─────────────────────────────────────────────────────────┐  │  │
│  │  │ WAL恢复                                                   │  │  │
│  │  │ - BE重启时恢复未提交数据                                  │  │  │
│  │  │ - 保证数据不丢失                                          │  │  │
│  │  └─────────────────────────────────────────────────────────┘  │  │
│  └───────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────────┐
│                        存储层                                        │
│  ┌───────────────────────────────────────────────────────────────┐  │
│  │  数据存储                                                       │  │
│  │  - 合并后的数据写入存储                                         │  │
│  │  - 减少版本数，降低compaction压力                               │  │
│  └───────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────┘

架构层次：

1. 客户端层：
   - JDBC Client：支持PreparedStatement，减少SQL解析开销
   - MySQL Client：支持INSERT INTO VALUES语句
   - HTTP Client：支持Stream Load导入

2. FE层（Frontend）：
   - SQL解析与缓存：PreparedStatement缓存，减少重复解析
   - 模式判断：根据配置决定是否使用Group Commit
   - 路由分发：将数据发送到对应的BE节点

3. BE层（Backend）：
   - 数据接收与缓存：接收并缓存导入数据
   - 模式分支处理：sync_mode同步等待，async_mode异步写入WAL
   - 事务合并与提交：将多个小批量数据合并为一个事务
   - WAL模块：保证async_mode下的数据可靠性

4. 存储层：
   - 数据存储：合并后的数据写入存储
   - 版本管理：减少版本数，降低compaction压力

3. 模块详细设计

3.1 模块划分

3.1.1 FE端模块

| 模块名称 | 职责说明 | 核心类/组件 |
|---------|---------|------------|
| PreparedStatement缓存模块 | 缓存SQL解析结果和执行计划，减少重复解析开销 | PreparedStatementContext |
| Group Commit判断模块 | 判断是否满足Group Commit条件，选择合适的模式 | GroupCommitPlanner |
| 路由分发模块 | 将数据发送到对应的BE节点 | DataRouter |

3.1.2 BE端模块

| 模块名称 | 职责说明 | 核心类/组件 |
|---------|---------|------------|
| 数据接收模块 | 接收来自FE的导入数据 | GroupCommitReceiver |
| 数据缓存模块 | 按表进行数据分组缓存 | GroupCommitBuffer |
| 事务合并模块 | 将多个小批量数据合并为一个事务 | GroupCommitMerger |
| WAL模块 | 写入和恢复WAL文件 | WalManager |
| 提交触发模块 | 根据条件触发事务提交 | GroupCommitTrigger |

3.2 关键流程设计

3.2.1 sync_mode同步模式流程

流程名称：sync_mode数据导入流程

步骤说明：
1. 客户端发送导入请求（INSERT INTO VALUES或Stream Load）
2. FE解析请求，检查session变量`group_commit=sync_mode`
3. FE将数据发送到BE
4. BE将数据写入GroupCommitBuffer
5. BE等待合并条件满足：
   - 时间间隔达到`group_commit_interval_ms`（默认10秒）
   - 或数据量达到`group_commit_data_bytes`（默认64MB）
6. BE将缓存中的多个小批量数据合并为一个事务提交
7. 提交成功后，返回结果给客户端
8. 客户端收到响应，数据立即可见

3.2.2 async_mode异步模式流程

流程名称：async_mode数据导入流程

步骤说明：
1. 客户端发送导入请求（INSERT INTO VALUES或Stream Load）
2. FE解析请求，检查session变量`group_commit=async_mode`
3. FE将数据发送到BE
4. BE将数据写入WAL文件
5. WAL写入成功后，立即返回结果给客户端（status='PREPARE'）
6. 客户端收到响应，此时数据尚不可见
7. BE后台异步处理：
   - 将WAL中的数据写入GroupCommitBuffer
   - 等待合并条件满足（时间间隔或数据量）
   - 将缓存中的数据合并为一个事务提交
   - 提交成功后删除WAL文件
8. 数据提交后可见（默认延迟约10秒）

3.2.3 WAL恢复流程

流程名称：WAL数据恢复流程

步骤说明：
1. BE启动时检查WAL目录
2. 发现未删除的WAL文件
3. 读取WAL文件内容
4. 将WAL中的数据重新写入GroupCommitBuffer
5. 正常执行合并和提交流程
6. 提交成功后删除WAL文件

4. 数据模型设计

4.1 核心数据结构设计

4.1.1 GroupCommitBuffer数据结构

```
// GroupCommitBuffer数据结构（伪代码）
class GroupCommitBuffer {
    // 表标识
    TableId tableId;
    
    // 数据缓存列表
    List<RowBatch> pendingBatches;
    
    // 当前缓存数据量（字节）
    long currentDataBytes;
    
    // 首次数据进入时间
    long firstBatchTime;
    
    // 同步锁
    Lock lock;
    
    // 条件变量（用于sync_mode等待）
    Condition commitCondition;
}
```

4.1.2 WAL记录数据结构

```
// WAL记录数据结构（伪代码）
class WalRecord {
    // 记录ID
    long recordId;
    
    // 表标识
    TableId tableId;
    
    // 数据内容
    byte[] data;
    
    // 写入时间戳
    long timestamp;
    
    // 状态
    WalStatus status;  // PENDING, COMMITTED, DELETED
}
```

4.2 数据关系图

```
导入请求
    ↓
FE解析
    ↓
BE接收
    ↓
┌───────────────────────────────────────┐
│           模式判断                     │
│  ┌─────────────┐  ┌─────────────────┐ │
│  │ sync_mode   │  │ async_mode      │ │
│  │     ↓       │  │     ↓           │ │
│  │ 直接缓存    │  │ 写入WAL        │ │
│  │     ↓       │  │     ↓           │ │
│  │ 等待提交    │  │ 立即返回       │ │
│  │     ↓       │  │     ↓           │ │
│  │ 返回结果    │  │ 异步缓存       │ │
│  └─────────────┘  └─────────────────┘ │
└───────────────────────────────────────┘
    ↓
GroupCommitBuffer
    ↓
触发条件满足（时间/数据量）
    ↓
事务合并提交
    ↓
数据可见
```

4.3 索引设计

- GroupCommitBuffer按TableId进行索引，快速定位表对应的缓存
- WAL文件按时间戳排序，支持顺序读取和恢复
- 使用锁机制保证多线程环境下的数据一致性

5. 接口设计

5.1 外部接口

5.1.1 INSERT INTO VALUES接口

* 接口类型：SQL语句

* 使用方式：
```sql
-- 设置Group Commit模式
SET group_commit = async_mode;  -- 或 sync_mode

-- 执行插入
INSERT INTO table_name VALUES (value1, value2, ...);
```

* 返回结果：
```
Query OK, N rows affected (X.XX sec)
{'label':'group_commit_xxx', 'status':'PREPARE', 'txnId':'xxx'}
```

5.1.2 Stream Load接口

* 接口端点：HTTP API

* 请求方法：PUT

* URL路径：`http://{fe_host}:{http_port}/api/{db}/{table}/_stream_load`

* 请求头：
  - `group_commit`: async_mode 或 sync_mode
  - `column_separator`: 列分隔符

* 返回结果：
```json
{
    "TxnId": 7009,
    "Label": "group_commit_xxx",
    "GroupCommit": true,
    "Status": "Success",
    "Message": "OK",
    "NumberTotalRows": 2,
    "NumberLoadedRows": 2
}
```

5.2 内部接口

5.2.1 GroupCommitBuffer接口

* 类/方法名：`GroupCommitBuffer.addBatch(RowBatch batch)`
* 参数：batch - 待添加的数据批次
* 返回值：void
* 异常处理：BufferFullException - 缓存已满

* 类/方法名：`GroupCommitBuffer.flush()`
* 参数：无
* 返回值：FlushResult - 提交结果
* 异常处理：CommitException - 提交失败

5.2.2 WalManager接口

* 类/方法名：`WalManager.write(WalRecord record)`
* 参数：record - WAL记录
* 返回值：void
* 异常处理：IOException - 写入失败

* 类/方法名：`WalManager.recover()`
* 参数：无
* 返回值：List<WalRecord> - 待恢复的记录列表
* 异常处理：IOException - 读取失败

6. 性能与安全设计

6.1 性能优化设计

6.1.1 减少SQL解析开销

* PreparedStatement缓存：SQL和执行计划缓存到Session级别的内存中
* 配置建议：JDBC URL设置`useServerPrepStmts=true&cachePrepStmts=true`

6.1.2 减少事务开销

* 事务合并：将多个小批量导入合并为一个事务
* 版本数控制：减少版本数增长，降低compaction压力

6.1.3 并行处理

* BE端并行接收多个导入请求
* 异步模式下WAL写入与数据提交并行执行

6.1.4 参数调优建议

* 提交间隔：
  - 较短间隔（如2秒）：数据可见性延迟更低，但系统开销更大
  - 较长间隔（如30秒）：系统开销更小，但数据可见性延迟更高

* 提交数据量：
  - 较小阈值（如32MB）：内存占用更少
  - 较大阈值（如256MB）：批量提交效率更高

6.2 安全设计

6.2.1 权限控制

* 继承Doris现有的用户权限体系
* 用户必须具有表的INSERT权限

6.2.2 数据安全

* WAL机制保证async_mode下的数据可靠性
* 数据先写入WAL，再异步提交

6.2.3 审计日志

* 可通过`enable_prepared_stmt_audit_log`控制是否打印PreparedStatement的审计日志
* 默认关闭以提高性能

7. 设计约束与限制

7.1 已知限制

1. INSERT INTO VALUES退化条件：
   - 使用事务写入
   - 指定Label
   - VALUES中包含表达式
   - 列更新写入
   - 表不支持轻量级模式更改

2. Stream Load退化条件：
   - 使用两阶段提交
   - 指定Label
   - 列更新写入
   - 表不支持轻量级模式更改

3. Unique模型限制：
   - Group Commit不保证提交顺序
   - 建议使用Sequence列保证数据一致性

4. WAL限制：
   - WAL文件是单副本存储
   - 磁盘损坏或文件误删可能导致数据丢失
   - 下线BE节点时使用DECOMMISSION命令

5. 模式自动切换：
   - async_mode在数据量过大时自动切换为sync_mode
   - chunked stream load不知道数据量时切换为sync_mode
   - 磁盘可用空间不足时切换为sync_mode

7.2 假设条件

1. 磁盘可靠性：假设WAL存储磁盘具有一定的可靠性
2. 网络稳定性：假设FE和BE之间的网络连接相对稳定
3. 内存充足：假设BE有足够的内存进行数据缓存

7.3 技术债务

1. WAL多副本：当前WAL是单副本存储，未来可考虑多副本机制
2. 提交顺序保证：当前不保证提交顺序，Unique模型需要依赖Sequence列
3. Count(*)优化：重量级Schema Change时拒绝Group Commit写入

8. 附录

8.1 配置参数说明

8.1.1 Session变量

* **`group_commit`**
  - 功能：控制Group Commit模式
  - 默认值：off_mode
  - 可选值：off_mode / sync_mode / async_mode
  - 示例：`SET group_commit = async_mode;`

8.1.2 表属性

* **`group_commit_interval_ms`**
  - 功能：控制提交时间间隔
  - 默认值：10000（毫秒）
  - 示例：`ALTER TABLE dt SET ("group_commit_interval_ms" = "2000");`

* **`group_commit_data_bytes`**
  - 功能：控制提交数据量阈值
  - 默认值：67108864（64MB）
  - 示例：`ALTER TABLE dt SET ("group_commit_data_bytes" = "134217728");`

8.1.3 BE配置

* **`group_commit_wal_path`**
  - 功能：WAL文件存储目录
  - 默认值：各storage_root_path目录下的wal子目录
  - 示例：`group_commit_wal_path=/data1/storage/wal;/data2/storage/wal`

8.2 使用示例

8.2.1 JDBC使用示例

```java
// JDBC URL配置
String url = "jdbc:mysql://127.0.0.1:9030/db?" +
    "useServerPrepStmts=true&" +
    "useLocalSessionState=true&" +
    "rewriteBatchedStatements=true&" +
    "cachePrepStmts=true&" +
    "prepStmtCacheSqlLimit=99999&" +
    "prepStmtCacheSize=500&" +
    "sessionVariables=group_commit=async_mode";

// 使用PreparedStatement
PreparedStatement stmt = conn.prepareStatement("INSERT INTO dt VALUES(?, ?, ?)");
for (int i = 0; i < batchSize; i++) {
    stmt.setInt(1, i);
    stmt.setString(2, "name" + i);
    stmt.setInt(3, i + 10);
    stmt.addBatch();
}
stmt.executeBatch();
```

8.2.2 Stream Load使用示例

```bash
# async_mode
curl --location-trusted -u user:passwd \
    -T data.csv \
    -H "group_commit:async_mode" \
    -H "column_separator:," \
    http://fe_host:8030/api/db/table/_stream_load

# sync_mode
curl --location-trusted -u user:passwd \
    -T data.csv \
    -H "group_commit:sync_mode" \
    -H "column_separator:," \
    http://fe_host:8030/api/db/table/_stream_load
```

8.3 相关文档

- Group Commit需求定义文档：1-需求定义文档.md
- Group Commit用户手册：group-commit-manual.md
