1. 功能基本信息
- 功能名称：Group Commit（高并发导入优化）
- 功能编号：DB-FUNC-002
- 创建日期：2025-01-26
- 提出人：陈明雨
- 当前版本：V1.0

2. 功能概述

2.1 功能目标

- 解决高频小批量写入场景下，每个导入都创建独立事务导致的FE解析SQL和生成执行计划开销问题
- 解决每个导入生成新版本导致版本数快速增长、增加后台compaction压力的问题
- 通过将多个小批量导入在后台合并成一个大事务提交，显著提升高并发小批量写入的性能
- 预期达到的效果：在高并发小数据量场景下，有效提升导入性能，减少版本数增长，降低系统合并数据的压力

3. 功能详述

3.1 功能描述

- Group Commit是一种高并发导入优化机制，不是一种新的导入方式，而是对现有导入方式的优化扩展，主要针对：
  - `INSERT INTO tbl VALUES(...)` 语句
  - Stream Load 导入

- Group Commit写入有三种模式：
  1. **关闭模式（off_mode）**：不开启Group Commit，使用传统导入方式
  2. **同步模式（sync_mode）**：Doris根据负载和表的`group_commit_interval`属性将多个导入在一个事务提交，事务提交后导入返回。适用于高并发写入场景，且在导入完成后要求数据立即可见
  3. **异步模式（async_mode）**：Doris首先将数据写入WAL（Write Ahead Log），然后导入立即返回。Doris会根据负载和表的`group_commit_interval`属性异步提交数据，提交之后数据可见。适用于写入延迟敏感以及高频写入的场景

- 自动提交条件：
  - 当满足时间间隔（默认10秒）或数据量（默认64MB）其中一个条件时，会自动提交数据
  - 可通过`group_commit_interval_ms`和`group_commit_data_bytes`表属性进行调整

- 已知限制：
  1. `INSERT INTO VALUES` 语句在以下情况下会退化为非Group Commit方式：
     - 使用事务写入（Begin; INSERT INTO VALUES; COMMIT）
     - 指定Label（INSERT INTO dt WITH LABEL {label} VALUES）
     - VALUES中包含表达式（INSERT INTO dt VALUES (1 + 100)）
     - 列更新写入
     - 表不支持轻量级模式更改
  2. `Stream Load` 在以下情况下会退化为非Group Commit方式：
     - 使用两阶段提交
     - 指定Label（-H "label:my_label"）
     - 列更新写入
     - 表不支持轻量级模式更改
  3. Unique模型下，Group Commit不保证提交顺序，建议使用Sequence列来保证数据一致性
  4. WAL文件是单副本存储的，磁盘损坏或文件误删可能导致数据丢失

3.2 输入/输出

- 输入：
  - 查询请求：用户提交的INSERT INTO VALUES语句或Stream Load请求
  - 配置参数：
    - `group_commit`：session变量，控制Group Commit模式（off_mode/sync_mode/async_mode）
    - `group_commit_interval_ms`：表属性，控制提交间隔（默认10000ms）
    - `group_commit_data_bytes`：表属性，控制提交数据量阈值（默认64MB）
    - `group_commit_wal_path`：BE配置，WAL文件存储目录
  - 数据内容：待导入的数据行

- 输出：
  - 导入结果：包含label、status、txnId等信息
    - 返回的label以`group_commit_`开头，表示使用了Group Commit
    - async_mode返回status为'PREPARE'，sync_mode返回实际提交状态
  - 性能指标：导入耗时、数据行数、数据量等
  - 错误信息：导入失败时的错误提示

4. 非功能性需求

4.1 性能要求

- 响应时间要求：
  - async_mode：导入立即返回，数据可见延迟由`group_commit_interval_ms`控制（默认10秒）
  - sync_mode：导入耗时至少为`group_commit_interval_ms`，但数据立即可见
  - 相比传统模式，在高并发小数据量场景下显著提升导入吞吐量

- 并发用户数：
  - 支持高并发写入场景（测试数据显示支持数百并发）
  - 多个并发导入会被合并到同一个事务中提交

- 数据处理量：
  - 单次批量提交数据量由`group_commit_data_bytes`控制（默认64MB）
  - 在async_mode下，当单次导入数据量较大时会自动切换为sync_mode
  - 性能测试数据：
    - Stream Load场景：500KB单并发数据量、30并发可达到267.1 MB/秒吞吐量
    - JDBC场景：100行单次插入、30并发可达到214,323行/秒

- 内存使用：
  - FE端：通过PreparedStatement缓存减少SQL解析开销
  - BE端：WAL文件写入磁盘，不额外占用大量内存

4.2 安全性要求

- 权限控制：
  - 继承Doris现有的用户权限体系
  - 用户必须具有表的INSERT权限才能使用Group Commit

- 数据保护：
  - async_mode使用WAL机制保证数据可靠性
  - WAL写入成功后删除，失败时通过WAL恢复
  - WAL文件是单副本存储，建议使用DECOMMISSION命令下线BE节点以防数据丢失

- 访问控制：
  - 通过session变量控制Group Commit模式，用户可自行选择
  - 通过表属性控制提交间隔和数据量阈值

4.3 兼容性要求

- 支持的数据库版本：
  - 支持Doris 3.0及以上版本
  - 向后兼容传统导入模式，用户可以选择关闭Group Commit

- 导入方式兼容性：
  - 支持INSERT INTO VALUES语句
  - 支持Stream Load导入
  - 支持JDBC PreparedStatement

- 操作系统兼容性：
  - 支持Doris支持的所有操作系统平台（Linux等）
  - 不依赖特定的操作系统特性

- 客户端兼容性：
  - 支持MySQL协议客户端
  - 支持JDBC驱动（需要开启PreparedStatement支持）
  - 支持各种编程语言客户端（Java、Golang等）

- 配置兼容性：
  - 支持通过session变量动态开启/关闭Group Commit
  - 支持通过表属性配置提交参数
  - 支持通过BE配置调整WAL存储路径
