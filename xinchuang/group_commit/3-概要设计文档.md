1. 文档概述

1.1 设计目的

- 明确Group Commit功能的技术实现蓝图和总体架构
- 定义各模块职责和接口关系
- 为详细设计与开发提供依据

1.2 预期读者

- 系统架构师
- 开发工程师
- 测试工程师
- 项目管理人员

2. 系统总体设计

2.1 设计目标与原则

- 功能目标：
  - 实现高并发小批量导入的性能优化
  - 通过事务合并减少版本数增长和compaction压力
  - 提供同步和异步两种模式满足不同场景需求
  - 通过WAL机制保证异步模式下的数据可靠性

- 设计原则：
  - 高内聚低耦合：FE和BE各自职责明确，通过标准接口交互
  - 可扩展性：支持多种导入方式（INSERT INTO VALUES、Stream Load）
  - 可配置性：支持通过session变量和表属性灵活配置
  - 向后兼容：不影响传统导入模式的正常使用

- 技术约束：
  - 必须兼容MySQL协议
  - 必须支持现有的JDBC驱动
  - WAL文件存储受磁盘空间限制

2.2 系统架构图

```
┌────────────────────────────────────────────────────────────────────────┐
│                              客户端                                     │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐                 │
│  │    JDBC      │  │    MySQL     │  │    HTTP      │                 │
│  │   Client     │  │    Client    │  │   Client     │                 │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘                 │
└─────────┼─────────────────┼─────────────────┼──────────────────────────┘
          │                 │                 │
          ▼                 ▼                 ▼
┌────────────────────────────────────────────────────────────────────────┐
│                         FE (Frontend)                                   │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                    请求处理层                                     │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────────┐  │   │
│  │  │ SQL Parser  │  │ Plan Cache  │  │ Group Commit Planner    │  │   │
│  │  └─────────────┘  └─────────────┘  └─────────────────────────┘  │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                    路由分发层                                     │   │
│  │  ┌─────────────────────────────────────────────────────────────┐│   │
│  │  │               Data Router (选择目标BE)                       ││   │
│  │  └─────────────────────────────────────────────────────────────┘│   │
│  └─────────────────────────────────────────────────────────────────┘   │
└────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌────────────────────────────────────────────────────────────────────────┐
│                         BE (Backend)                                    │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                    数据接收层                                     │   │
│  │  ┌─────────────────────────────────────────────────────────────┐│   │
│  │  │            Group Commit Receiver                             ││   │
│  │  └─────────────────────────────────────────────────────────────┘│   │
│  └─────────────────────────────────────────────────────────────────┘   │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                    处理层                                         │   │
│  │  ┌────────────────┐            ┌────────────────┐               │   │
│  │  │   Sync Mode    │            │   Async Mode   │               │   │
│  │  │   Handler      │            │   Handler      │               │   │
│  │  │                │            │       │        │               │   │
│  │  │  ┌──────────┐  │            │  ┌────▼─────┐  │               │   │
│  │  │  │  Buffer  │  │            │  │   WAL    │  │               │   │
│  │  │  └──────────┘  │            │  │  Writer  │  │               │   │
│  │  │       │        │            │  └──────────┘  │               │   │
│  │  │       ▼        │            │       │        │               │   │
│  │  │  ┌──────────┐  │            │  ┌────▼─────┐  │               │   │
│  │  │  │  Wait    │  │            │  │  Return  │  │               │   │
│  │  │  │  Commit  │  │            │  │ Immediate│  │               │   │
│  │  │  └──────────┘  │            │  └──────────┘  │               │   │
│  │  └────────────────┘            └────────────────┘               │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                    合并提交层                                     │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────────┐  │   │
│  │  │  Merger     │  │  Trigger    │  │  Transaction Manager    │  │   │
│  │  │  (合并数据)  │  │ (触发提交)   │  │  (事务管理)              │  │   │
│  │  └─────────────┘  └─────────────┘  └─────────────────────────┘  │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                    WAL管理层                                      │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────────┐  │   │
│  │  │ WAL Writer  │  │ WAL Reader  │  │  WAL Recovery           │  │   │
│  │  └─────────────┘  └─────────────┘  └─────────────────────────┘  │   │
│  └─────────────────────────────────────────────────────────────────┘   │
└────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌────────────────────────────────────────────────────────────────────────┐
│                           存储层                                        │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  数据文件存储 (合并后的数据，减少版本数)                            │   │
│  └─────────────────────────────────────────────────────────────────┘   │
└────────────────────────────────────────────────────────────────────────┘
```

2.3 关键技术选型

| 技术领域 | 选用方案 | 简要说明 |
|---------|---------|---------|
| 数据缓存 | 内存Buffer | 使用内存缓存待合并的数据，支持高并发写入 |
| 持久化保证 | WAL机制 | 异步模式使用WAL保证数据不丢失 |
| 事务合并 | 批量提交 | 将多个小事务合并为一个大事务提交 |
| 触发机制 | 时间/数据量双触发 | 支持按时间间隔或数据量触发提交 |
| SQL缓存 | PreparedStatement | 缓存SQL解析结果，减少重复解析开销 |

3. 模块/组件设计

3.1 模块划分图

```
Group Commit功能模块
├── FE端模块
│   ├── SQL解析模块
│   │   └── PreparedStatement缓存
│   ├── Group Commit判断模块
│   │   └── 模式选择逻辑
│   └── 路由分发模块
│       └── BE节点选择
├── BE端模块
│   ├── 数据接收模块
│   │   └── GroupCommitReceiver
│   ├── 数据缓存模块
│   │   └── GroupCommitBuffer
│   ├── 模式处理模块
│   │   ├── SyncModeHandler
│   │   └── AsyncModeHandler
│   ├── 事务合并模块
│   │   ├── GroupCommitMerger
│   │   └── GroupCommitTrigger
│   └── WAL模块
│       ├── WalWriter
│       ├── WalReader
│       └── WalRecovery
└── 公共组件
    ├── 配置管理
    └── 监控指标
```

3.2 模块功能描述

| 模块名称 | 主要职责 | 输入 | 输出 | 依赖模块 |
|---------|---------|------|------|---------|
| SQL解析模块 | 解析INSERT INTO VALUES语句，缓存执行计划 | SQL语句 | 执行计划 | 无 |
| Group Commit判断模块 | 判断是否使用Group Commit及模式选择 | 配置参数、SQL类型 | 模式决策 | SQL解析模块 |
| 路由分发模块 | 选择目标BE并发送数据 | 数据批次 | 发送结果 | Group Commit判断模块 |
| 数据接收模块 | 接收FE发送的数据 | 网络数据 | RowBatch | 无 |
| 数据缓存模块 | 缓存待合并的数据 | RowBatch | 缓存状态 | 数据接收模块 |
| SyncModeHandler | 处理同步模式逻辑 | RowBatch | 提交结果 | 数据缓存模块 |
| AsyncModeHandler | 处理异步模式逻辑 | RowBatch | 写入确认 | WAL模块 |
| 事务合并模块 | 将多个数据批次合并为一个事务 | 缓存数据 | 合并事务 | 数据缓存模块 |
| WAL模块 | 写入和恢复WAL | 数据记录 | 持久化确认 | 无 |

4. 接口设计

4.1 外部接口

- SQL接口：
  - INSERT INTO VALUES语句：标准MySQL协议
  - Session变量设置：SET group_commit = xxx

- HTTP接口：
  - Stream Load API：支持group_commit请求头

- 数据库接口：
  - JDBC PreparedStatement：支持批量执行

4.2 内部接口

| 接口名称 | 调用方 | 被调用方 | 通信方式 | 数据格式 |
|---------|--------|---------|---------|---------|
| SendData | FE | BE | RPC | RowBatch |
| CommitNotify | BE | FE | RPC | CommitResult |
| WalWrite | AsyncHandler | WalWriter | 本地调用 | WalRecord |
| WalRecover | BE启动 | WalRecovery | 本地调用 | WalRecord列表 |
| TriggerCommit | Trigger | Merger | 本地调用 | 触发信号 |

5. 数据设计概要

5.1 数据流图

```
INSERT INTO VALUES / Stream Load
            │
            ▼
      ┌─────────────┐
      │   FE解析    │
      └──────┬──────┘
             │
             ▼
      ┌─────────────┐
      │   BE接收    │
      └──────┬──────┘
             │
     ┌───────┴───────┐
     │               │
     ▼               ▼
┌─────────┐    ┌─────────┐
│sync_mode│    │async_mode│
└────┬────┘    └────┬────┘
     │              │
     ▼              ▼
┌─────────┐    ┌─────────┐
│  缓存   │    │ WAL写入 │
└────┬────┘    └────┬────┘
     │              │
     ▼              ▼
┌─────────┐    ┌─────────┐
│等待提交 │    │立即返回 │
└────┬────┘    └────┬────┘
     │              │
     └───────┬──────┘
             │
             ▼
      ┌─────────────┐
      │  触发提交   │
      │ (时间/数据量)│
      └──────┬──────┘
             │
             ▼
      ┌─────────────┐
      │  事务合并   │
      └──────┬──────┘
             │
             ▼
      ┌─────────────┐
      │  数据写入   │
      └─────────────┘
```

5.2 存储方案

- 结构化数据：
  - GroupCommitBuffer：内存中的数据缓存
  - 按TableId组织，每个表一个Buffer

- 非结构化数据：
  - WAL文件：顺序写入的日志文件
  - 存储路径由`group_commit_wal_path`配置

- 缓存数据：
  - PreparedStatement缓存：Session级别
  - GroupCommitBuffer：BE级别

5.3 数据一致性方案

- 事务处理机制：
  - 同步模式：等待事务提交后返回，保证强一致性
  - 异步模式：WAL写入成功后返回，最终一致性

- 数据同步策略：
  - WAL先写：数据先写入WAL，再异步提交
  - 提交后删除：事务提交成功后删除WAL文件

6. 关键技术方案

6.1 核心业务逻辑实现方案

6.1.1 事务合并逻辑

```
1. 接收数据批次，放入GroupCommitBuffer
2. 检查触发条件：
   - 时间条件：距离首次数据进入时间 >= group_commit_interval_ms
   - 数据量条件：当前缓存数据量 >= group_commit_data_bytes
3. 满足任一条件时触发提交：
   - 锁定Buffer
   - 取出所有缓存数据
   - 合并为一个事务
   - 批量写入存储
   - 释放Buffer
```

6.1.2 WAL写入逻辑

```
1. 收到async_mode的导入请求
2. 构造WalRecord，包含表ID、数据内容、时间戳
3. 将WalRecord追加写入WAL文件
4. 调用fsync确保持久化
5. 返回成功响应给客户端
6. 异步将WAL数据放入Buffer
7. 正常触发提交流程
8. 提交成功后标记WAL记录为已提交
9. 清理已提交的WAL记录
```

6.2 性能关键点设计

- 瓶颈预估：
  - FE端SQL解析：高并发INSERT可能成为瓶颈
  - BE端Buffer锁竞争：多线程写入同一表可能竞争
  - WAL写入IO：磁盘IO可能成为async_mode瓶颈

- 优化方向：
  - PreparedStatement缓存减少SQL解析
  - 分段Buffer减少锁竞争
  - WAL批量写入减少IO次数

6.3 容错与异常处理

- 异常分类：
  - 系统异常：BE宕机、磁盘故障、网络中断
  - 业务异常：数据格式错误、权限不足

- 处理策略：
  - BE宕机：通过WAL恢复未提交数据
  - 磁盘故障：async_mode自动切换为sync_mode
  - 网络中断：客户端重试

7. 非功能性设计

7.1 性能设计

- 响应时间目标：
  - sync_mode：约等于group_commit_interval_ms
  - async_mode：毫秒级响应

- 吞吐量目标：
  - Stream Load：100KB-1MB单并发可达200+ MB/秒
  - JDBC：100行单次插入可达20万行/秒

- 资源预估：
  - CPU：主要消耗在数据解析和合并
  - 内存：Buffer大小由group_commit_data_bytes控制
  - 存储：WAL文件大小取决于数据写入速度

7.2 安全性设计

- 认证授权：
  - 继承Doris现有的用户认证体系
  - INSERT权限控制

- 数据安全：
  - WAL文件权限控制
  - 数据传输使用Doris标准协议

- 安全审计：
  - 可配置的审计日志
  - 通过enable_prepared_stmt_audit_log控制

7.3 可扩展性设计

- 水平扩展方案：
  - 支持多BE节点并行处理
  - 每个BE独立管理自己的Buffer和WAL

8. 开发计划建议

8.1 开发阶段划分

| 阶段 | 主要内容 | 预计周期 | 输出物 |
|-----|---------|---------|--------|
| 阶段1 | 基础框架搭建 | 2周 | 核心类结构、接口定义 |
| 阶段2 | sync_mode实现 | 2周 | 同步模式完整功能 |
| 阶段3 | async_mode实现 | 2周 | 异步模式、WAL机制 |
| 阶段4 | 性能优化 | 1周 | PreparedStatement缓存、参数调优 |
| 阶段5 | 测试与文档 | 1周 | 测试用例、用户文档 |

8.2 技术风险评估

| 风险描述 | 可能性 | 影响程度 | 应对措施 |
|---------|--------|---------|---------|
| WAL磁盘空间不足 | 中 | 高 | 监控磁盘空间，自动切换sync_mode |
| Buffer锁竞争导致性能下降 | 中 | 中 | 采用分段锁或无锁数据结构 |
| BE宕机导致数据丢失 | 低 | 高 | WAL恢复机制，建议使用DECOMMISSION下线 |
| 高并发下FE成为瓶颈 | 中 | 中 | PreparedStatement缓存，多FE部署 |
| Unique模型数据顺序问题 | 中 | 中 | 文档说明，建议使用Sequence列 |
