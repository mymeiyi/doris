1. 功能基本信息
- 功能名称：Batch Mode（批处理模式）
- 创建日期：2025-05-20
- 提出人：陈明雨
- 当前版本：V1.0
2. 功能概述

2.1 功能目标

- 解决传统模式下FE生成大量split导致的内存压力问题，通过迭代方式边读取元数据边生成split，减少FE内存占用
- 解决FE预先分配split但无法感知BE运行状态导致的分配不优问题，改为BE主动请求split，实现动态负载均衡
- 解决FE生成split的IO操作与BE读取文件的IO操作串行执行导致的查询效率瓶颈，通过并行执行提升整体查询效率
- 预期达到的效果：显著提升大数据量查询的性能，减少内存压力，提高系统资源利用率，降低查询响应时间
3. 功能详述

3.1 功能描述

- Batch Mode是一种优化的数据读取模式，用于改进Doris在读取大数据量时的性能表现。在传统模式下，FE负责一次性生成所有split并预先分配给BE，BE被动等待接收split后开始读取数据。Batch Mode采用迭代式生成split和BE主动请求的方式，实现了更高效的数据读取流程。
- 功能具体内容：
  传统模式流程：
- FE在做plan时，一次性读取完所有Iceberg元数据信息
- FE根据元数据文件生成所有split并分配给对应的BE
- FE将split发送给BE
- BE等待接收split后开始进行数据读取
  Batch模式流程：
- FE在做plan时，以迭代方式边读取元数据信息边生成split
- FE将生成的split保存到splitAssignment中
- BE主动向FE请求一批split（通过remote_split_source_batch_size配置控制批次大小）
- FE通过service读取splitAssignment并向请求的BE发送split
- BE获取到split后立即开始读取数据
- BE完成当前批次split的读取后，再次向FE请求新的split
- 重复上述过程直到所有split读取完成
- 主要特性对比：
特性
传统模式
Batch模式
split生成方式
FE一次性读取完所有元数据，然后生成所有split
FE边读取元数据，边生成split
BE获取split方式
BE全程等待，需要FE主动发送split
BE主动向FE请求split，FE有生成好的split就可以发送给BE
split分配方式
FE将split预先分配好给固定的BE
没有分配固定的BE，只要BE读取完后就可以向FE获取新的split

- 优势：
  1. FE不需要同时保存所有的split，可以减少内存压力
  2. BE不需要等FE生成完所有split之后才开始读取数据，节省了等待split的时间
  3. split的分配不再固定，处理速度快的BE可以处理更多的split，减少了水桶效应
  4. FE的IO与BE的IO可以并行执行，提升整体查询效率
- 已知限制：
  1. 当FE被重启时，batch模式下读取数据可能会出现报错，需要重新尝试查询
  2. 不能够对count(*)做最优化处理（后期会单独优化）
  3. 针对Iceberg catalog，现在只能手动开启batch模式，不能够自动从传统模式切换至batch模式
  4. 当split个数较少时，可能会出现只有一个BE在处理split、其他BE没有split可处理的情况
  5. 由于FE的IO与BE的IO会出现并行的情况，可能会对存储集群（例如HDFS集群）造成一定的压力
3.2 输入/输出

- 输入：
  - 查询请求：用户提交的SQL查询语句
  - 配置参数：
    - num_partitions_in_batch_mode：使用batch模式的条件（分区个数阈值）
    - fetch_splits_max_wait_time_ms：BE端获取split的等待时间（默认1000ms）
    - remote_split_source_batch_size：BE端获取split的最大个数（默认1000）
  - 元数据信息：Iceberg/Hive/Hudi/MC等数据源的元数据文件
  - BE节点信息：可用的BE节点列表及其状态
- 输出：
  - 查询结果：符合SQL查询条件的数据结果集
  - Split分配：动态分配给BE的split列表
  - 性能指标：查询执行时间、资源使用情况等
  - 错误信息：当FE重启或出现异常时的错误提示（需要用户重新尝试查询）
4. 非功能性需求

4.1 性能要求

- 响应时间要求：
  - 相比传统模式，大数据量查询的响应时间应显著降低
  - BE获取split的等待时间可配置（默认1000ms），需在合理范围内
  - FE生成split的过程与BE读取数据的过程应尽可能并行执行
- 并发用户数：
  - 支持多用户并发查询
  - 每个BE可以独立向FE请求split，支持多BE并发处理
  - 系统应能根据BE的处理能力动态分配split，避免资源浪费
- 数据处理量：
  - 支持处理大规模数据查询（分区数量大于等于num_partitions_in_batch_mode时自动启用）
  - 单次BE请求的split数量由remote_split_source_batch_size控制（默认1000）
  - 应能有效处理TB级别甚至更大规模的数据查询
- 内存使用：
  - FE不需要同时保存所有split，应显著减少内存占用
  - 通过迭代方式生成split，内存使用应随查询规模线性增长而非指数增长
4.2 安全性要求

- 权限控制：
  - 继承Doris现有的用户权限体系
  - 用户必须具有相应数据源的查询权限才能使用batch模式
  - FE和BE之间的split请求通信应进行身份验证
- 数据保护：
  - 确保split分配过程中不会导致数据丢失
  - 当FE重启时，应通过报错机制提示用户重新查询，避免数据不一致
  - 保证数据读取的完整性和一致性
- 访问控制：
  - BE只能请求和读取被授权的split
  - FE应验证BE的身份和权限后再分配split
  - 防止未授权的BE节点获取split
4.3 兼容性要求

- 支持的数据库版本：
  - 支持Doris当前版本及后续版本
  - 向后兼容传统模式，用户可以选择使用传统模式或batch模式
- 数据源兼容性：
  - 支持Iceberg catalog（需手动开启batch模式）
  - 支持Hive/Hudi/MC catalog（根据分区数量自动切换）
  - 不同catalog的batch模式启用方式可能不同
- 操作系统兼容性：
  - 支持Doris支持的所有操作系统平台（Linux等）
  - 不依赖特定的操作系统特性
- 存储系统兼容性：
  - 支持HDFS等分布式存储系统
  - 需要考虑FE和BE并行IO对存储集群的压力
  - 应能适配各种对象存储和分布式文件系统
- 配置兼容性：
  - 支持通过会话级别配置启用batch模式
  - 支持通过BE端配置调整split获取参数
  - 配置应不影响传统模式的正常使用