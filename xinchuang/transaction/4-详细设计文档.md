1. 文档基本信息
1.1 功能标识
- 功能名称：事务（Transaction）
- 功能编码：DORIS-TXN-001-DD
- 关联文档：
  - 需求文档：事务功能需求定义文档 V1.0
  - 概要设计文档：事务功能概要设计文档 V1.0
- 设计版本：V1.0
- 设计日期：2025-06-20
- 设计人员：陈明雨
2. 设计概述

2.1 设计范围

- 本次设计覆盖事务功能的完整实现，包括FE端和BE端的核心模块设计
- FE端设计范围：
  - 事务管理器（TransactionMgr）的实现
  - Label管理器（LabelManager）的实现
  - 事务协调器（Coordinator）的实现
  - 两阶段提交服务（2PC Service）的实现
- BE端设计范围：
  - Delta Writer的事务支持
  - Tablet Writer的提交控制
  - RowSet可见性管理
- 支持的事务类型：
  - 显式事务（BEGIN/COMMIT/ROLLBACK）
  - 隐式事务（单语句自动事务）
  - Stream Load 2PC
  - Broker Load多表事务
- 不包括的内容：
  - 嵌套事务支持
  - SERIALIZABLE隔离级别
  - DDL事务支持
2.2 设计目标

- 技术实现目标：
  - 实现事务的原子性保证，所有操作要么全部成功，要么全部失败
  - 实现Label去重机制，保证Exactly-Once语义
  - 实现两阶段提交，支持外部系统协调
  - 实现READ COMMITTED隔离级别
- 质量属性目标：
  - 性能：事务开启/提交响应时间毫秒级
  - 可靠性：支持超时回滚、Session关闭回滚
  - 可维护性：模块职责清晰，接口设计合理
  - 可扩展性：支持多表事务，支持分布式写入
3. 模块详细设计

3.1 模块结构

```
事务模块
├── FE端模块
│   ├── 事务管理模块
│   │   ├── TransactionMgr类
│   │   │   ├── beginTransaction()方法
│   │   │   ├── commitTransaction()方法
│   │   │   ├── abortTransaction()方法
│   │   │   └── getTransactionState()方法
│   │   └── TransactionState类
│   │       ├── 状态机管理
│   │       └── 状态转换方法
│   ├── Label管理模块
│   │   └── LabelManager类
│   │       ├── addLabel()方法
│   │       ├── checkLabel()方法
│   │       ├── removeLabel()方法
│   │       └── cleanExpiredLabels()方法
│   ├── 事务协调模块
│   │   └── Coordinator类
│   │       ├── beginWriteTask()方法
│   │       ├── commitWriteTask()方法
│   │       └── abortWriteTask()方法
│   └── 2PC服务模块
│       └── StreamLoad2PCService类
│           ├── handlePrepare()方法
│           ├── handleCommit()方法
│           └── handleAbort()方法
└── BE端模块
    ├── 数据写入模块
    │   └── DeltaWriter类
    │       ├── write()方法
    │       ├── commit()方法
    │       └── cancel()方法
    ├── Tablet写入模块
    │   └── TabletWriter类
    │       ├── writeData()方法
    │       ├── finishWrite()方法
    │       └── cancelWrite()方法
    └── RowSet管理模块
        └── RowSetManager类
            ├── createRowSet()方法
            ├── publishRowSet()方法
            └── deleteRowSet()方法
```

3.2 类设计

3.2.1 类名：TransactionMgr

- 类职责：负责事务的创建、状态管理、提交和回滚
- 类关系：
  - 依赖：LabelManager、Coordinator
  - 关联：TransactionState、DatabaseTransactionMgr
- 属性列表：
  - dbIdToTxnMgr (Map<Long, DatabaseTransactionMgr>) - 数据库ID到事务管理器映射
  - idGenerator (AtomicLong) - 事务ID生成器
  - transactionTimeoutLimit (long) - 事务超时限制
  - maxTxnNumber (int) - 最大事务数量
- 方法列表：
  - beginTransaction(long dbId, List<Long> tableIds, String label, ...)
    - 返回类型：long（事务ID）
    - 说明：开始一个新事务
  - commitTransaction(long dbId, long txnId, List<TabletCommitInfo> commitInfos)
    - 返回类型：void
    - 说明：提交事务
  - abortTransaction(long dbId, long txnId, String reason)
    - 返回类型：void
    - 说明：回滚事务
  - getTransactionState(long dbId, long txnId)
    - 返回类型：TransactionState
    - 说明：获取事务状态

3.2.2 类名：TransactionState

- 类职责：表示一个事务的状态信息
- 类关系：
  - 枚举依赖：TransactionStatus
- 属性列表：
  - txnId (long) - 事务ID
  - label (String) - 事务Label
  - dbId (long) - 数据库ID
  - tableIdList (List<Long>) - 涉及的表ID列表
  - status (TransactionStatus) - 事务状态
  - prepareTime (long) - 准备时间
  - commitTime (long) - 提交时间
  - finishTime (long) - 完成时间
  - reason (String) - 错误原因
  - tabletCommitInfos (List<TabletCommitInfo>) - Tablet提交信息
- 方法列表：
  - getStatus() - 获取当前状态
  - setStatus(TransactionStatus status) - 设置状态
  - isRunning() - 判断事务是否运行中
  - isFinished() - 判断事务是否已完成

3.2.3 类名：LabelManager

- 类职责：管理事务Label，实现去重功能
- 类关系：
  - 关联：TransactionMgr
- 属性列表：
  - dbIdToLabelMap (Map<Long, Map<String, Long>>) - 数据库ID到Label映射
  - labelExpireTime (long) - Label过期时间，默认3天
  - maxLabelNumber (int) - 最大Label数量，默认2000
  - lock (ReentrantLock) - 同步锁
- 方法列表：
  - addLabel(long dbId, String label, long txnId)
    - 返回类型：boolean
    - 说明：添加新Label，如果已存在返回false
  - checkLabel(long dbId, String label)
    - 返回类型：Long（事务ID或null）
    - 说明：检查Label是否存在
  - removeLabel(long dbId, String label)
    - 返回类型：void
    - 说明：删除Label
  - cleanExpiredLabels()
    - 返回类型：void
    - 说明：清理过期的Label

3.2.4 类名：Coordinator

- 类职责：协调分布式事务的执行，向BE发送写入任务
- 类关系：
  - 依赖：BE节点通信模块
- 属性列表：
  - queryId (TUniqueId) - 查询ID
  - fragmentExecParams (List<FragmentExecParams>) - 执行参数
  - backends (List<Backend>) - BE节点列表
  - transactionId (long) - 事务ID
- 方法列表：
  - beginWriteTask(TransactionState txnState, List<Backend> backends)
    - 返回类型：void
    - 说明：开始写入任务
  - commitWriteTask(long txnId)
    - 返回类型：List<TabletCommitInfo>
    - 说明：提交写入任务，收集提交信息
  - abortWriteTask(long txnId, String reason)
    - 返回类型：void
    - 说明：取消写入任务

3.2.5 类名：StreamLoad2PCService

- 类职责：提供Stream Load两阶段提交的HTTP接口服务
- 类关系：
  - 依赖：TransactionMgr
- 属性列表：
  - transactionMgr (TransactionMgr) - 事务管理器引用
- 方法列表：
  - handlePrepare(HttpServletRequest request, HttpServletResponse response)
    - 返回类型：void
    - 说明：处理预提交请求
  - handleCommit(String txnIdOrLabel, String db, String table)
    - 返回类型：TxnCommitResult
    - 说明：处理提交请求
  - handleAbort(String txnIdOrLabel, String db, String table)
    - 返回类型：TxnAbortResult
    - 说明：处理回滚请求

3.2.6 类名：DeltaWriter

- 类职责：BE端负责事务数据的增量写入
- 类关系：
  - 依赖：TabletWriter、RowSetManager
- 属性列表：
  - tabletId (long) - Tablet ID
  - txnId (long) - 事务ID
  - rowset (Rowset) - 当前写入的RowSet
  - memTable (MemTable) - 内存表
  - isClosed (bool) - 是否已关闭
- 方法列表：
  - write(Tuple tuple)
    - 返回类型：Status
    - 说明：写入一行数据
  - commit()
    - 返回类型：Status
    - 说明：提交写入
  - cancel()
    - 返回类型：Status
    - 说明：取消写入

3.2.7 类名：RowSetManager

- 类职责：管理RowSet的创建、发布和删除
- 类关系：
  - 关联：Tablet
- 属性列表：
  - tablet (Tablet) - 关联的Tablet
  - pendingRowsets (Map<Long, Rowset>) - 待发布的RowSet
  - lock (Mutex) - 同步锁
- 方法列表：
  - createRowSet(long txnId, RowsetMetaPB meta)
    - 返回类型：Rowset
    - 说明：创建新的RowSet
  - publishRowSet(long txnId, long version)
    - 返回类型：Status
    - 说明：发布RowSet，使其可见
  - deleteRowSet(long txnId)
    - 返回类型：void
    - 说明：删除RowSet（回滚时调用）

3.3 关键方法详细设计

3.3.1 方法名：TransactionMgr.beginTransaction()

- 功能描述：开始一个新的事务，分配事务ID，创建事务状态，检查Label唯一性
- 算法描述：
```
1. 获取数据库的事务管理器（DatabaseTransactionMgr）
2. 检查Label是否已存在
   a. 如果Label已存在且对应事务成功，抛出LabelAlreadyUsedException
   b. 如果Label已存在且对应事务失败/运行中，根据策略处理
3. 生成新的事务ID（txnId）
4. 创建TransactionState对象
5. 注册Label到LabelManager
6. 将事务添加到运行中事务列表
7. 返回事务ID
```
- 输入参数：
  - dbId (long, 必填) - 数据库ID
  - tableIdList (List<Long>, 必填) - 涉及的表ID列表
  - label (String, 必填) - 事务Label
  - sourceType (TransactionSourceType, 必填) - 事务来源类型
  - timeout (long, 可选) - 超时时间
- 返回值：
  - long - 事务ID
- 异常处理：
  - LabelAlreadyUsedException - Label已被使用
  - BeginTransactionException - 开始事务失败
  - AnalysisException - 参数校验失败
- 性能考虑：
  - 时间复杂度：O(1)，主要是Map查找和插入
  - 空间复杂度：O(1)，创建常量大小的对象

3.3.2 方法名：TransactionMgr.commitTransaction()

- 功能描述：提交事务，将所有写入的数据持久化并可见
- 算法描述：
```
1. 获取事务状态（TransactionState）
2. 检查事务状态是否为PREPARE
   a. 如果不是，抛出异常
3. 收集所有Tablet的提交信息（TabletCommitInfo）
4. 调用DatabaseTransactionMgr.commitTransaction()
   a. 更新事务状态为COMMITTED
   b. 持久化事务日志
5. 发布版本（publishVersion）使数据可见
   a. 向所有涉及的BE发送publish version请求
   b. 等待多数副本响应
6. 更新事务状态为VISIBLE
7. 返回成功
```
- 输入参数：
  - dbId (long, 必填) - 数据库ID
  - txnId (long, 必填) - 事务ID
  - tabletCommitInfos (List<TabletCommitInfo>, 必填) - Tablet提交信息
- 返回值：
  - void
- 异常处理：
  - TransactionNotFoundException - 事务不存在
  - TransactionCommitFailedException - 提交失败
  - UserException - 用户相关异常
- 性能考虑：
  - 时间复杂度：O(n)，n为涉及的Tablet数量
  - 空间复杂度：O(n)，存储提交信息

3.3.3 方法名：TransactionMgr.abortTransaction()

- 功能描述：回滚事务，撤销所有写入的数据
- 算法描述：
```
1. 获取事务状态（TransactionState）
2. 检查事务是否可以回滚
   a. 如果状态为COMMITTED/VISIBLE，抛出异常
3. 向所有涉及的BE发送取消写入请求
4. 更新事务状态为ABORTED
5. 设置回滚原因
6. 从运行中事务列表移除
7. 清理相关资源
```
- 输入参数：
  - dbId (long, 必填) - 数据库ID
  - txnId (long, 必填) - 事务ID
  - reason (String, 可选) - 回滚原因
- 返回值：
  - void
- 异常处理：
  - TransactionNotFoundException - 事务不存在
  - TransactionCommittedException - 事务已提交，无法回滚
- 性能考虑：
  - 时间复杂度：O(n)，n为涉及的BE数量
  - 空间复杂度：O(1)

3.3.4 方法名：LabelManager.addLabel()

- 功能描述：添加新的Label，实现去重检查
- 算法描述：
```
1. 获取锁
2. 检查数据库的Label数量是否达到上限
   a. 如果达到，触发Label淘汰
3. 检查Label是否已存在
   a. 如果存在，返回false
4. 添加Label到映射
5. 释放锁
6. 返回true
```
- 输入参数：
  - dbId (long, 必填) - 数据库ID
  - label (String, 必填) - Label名称
  - txnId (long, 必填) - 关联的事务ID
- 返回值：
  - boolean - 添加成功返回true，已存在返回false
- 异常处理：
  - 无显式异常
- 性能考虑：
  - 时间复杂度：O(1)，HashMap操作
  - 空间复杂度：O(1)

3.3.5 方法名：DeltaWriter.commit()

- 功能描述：BE端提交写入，将内存数据持久化
- 算法描述：
```
1. 检查是否有待写入的数据
2. 刷新MemTable到磁盘
   a. 将内存数据序列化
   b. 写入Segment文件
3. 完成RowSet的创建
4. 将RowSet添加到待发布列表
5. 返回提交信息（TabletCommitInfo）
```
- 输入参数：
  - 无（使用类属性）
- 返回值：
  - Status - 提交状态
- 异常处理：
  - 写入失败时返回错误Status
- 性能考虑：
  - 时间复杂度：O(n)，n为数据量
  - 空间复杂度：O(n)，需要序列化数据

3.3.6 方法名：RowSetManager.publishRowSet()

- 功能描述：发布RowSet，使数据可见
- 算法描述：
```
1. 获取事务对应的RowSet
2. 设置RowSet的版本号
3. 将RowSet添加到Tablet的可见RowSet列表
4. 从待发布列表移除
5. 更新Tablet的最大版本号
6. 返回成功
```
- 输入参数：
  - txnId (long, 必填) - 事务ID
  - version (long, 必填) - 版本号
- 返回值：
  - Status - 发布状态
- 异常处理：
  - RowSet不存在时返回错误
- 性能考虑：
  - 时间复杂度：O(1)
  - 空间复杂度：O(1)

4. 接口详细设计

4.1 API接口

4.1.1 接口名称：BEGIN事务开启

- 请求方式：MySQL协议SQL命令
- URL路径：N/A（SQL语句）
- 语法格式：
```sql
BEGIN;
BEGIN WITH LABEL {label};
```
- 请求参数：
  - label (String, 可选) - 用户指定的事务Label
- 响应格式：
```json
{
  "label": "txn_insert_xxx",
  "status": "PREPARE",
  "txnId": ""
}
```
- 错误码定义：
  - 1064 - 语法错误
  - 5025 - Label已被使用
- 示例请求/响应：
```sql
mysql> BEGIN WITH LABEL my_label;
Query OK, 0 rows affected (0.01 sec)
{'label':'my_label', 'status':'PREPARE', 'txnId':''}
```

4.1.2 接口名称：COMMIT事务提交

- 请求方式：MySQL协议SQL命令
- URL路径：N/A（SQL语句）
- 语法格式：
```sql
COMMIT;
```
- 请求参数：无
- 响应格式：
```json
{
  "label": "txn_insert_xxx",
  "status": "VISIBLE",
  "txnId": "10013"
}
```
- 错误码定义：
  - 5026 - 事务不存在
  - 5027 - 提交失败
- 示例请求/响应：
```sql
mysql> COMMIT;
Query OK, 0 rows affected (1.02 sec)
{'label':'my_label', 'status':'VISIBLE', 'txnId':'10013'}
```

4.1.3 接口名称：Stream Load 2PC预提交

- 请求方式：POST
- URL路径：/api/{db}/{table}/_stream_load
- 请求头：
  - two_phase_commit (String, 必须) - 值为"true"
  - label (String, 可选) - 用户指定Label
  - Authorization (String, 必须) - Basic认证
- 请求参数：
  - Body：数据文件内容
- 响应格式：
```json
{
  "TxnId": 18036,
  "Label": "55c8ffc9-1c40-4d51-b75e-f2265b3602ef",
  "TwoPhaseCommit": "true",
  "Status": "Success",
  "Message": "OK",
  "NumberTotalRows": 100,
  "NumberLoadedRows": 100,
  "NumberFilteredRows": 0,
  "NumberUnselectedRows": 0,
  "LoadBytes": 1031,
  "LoadTimeMs": 77
}
```
- 错误码定义：
  - 400 - 请求参数错误
  - 401 - 认证失败
  - 500 - 服务器内部错误
- 示例请求/响应：
```bash
# 请求
curl --location-trusted -u user:passwd \
  -H "two_phase_commit:true" \
  -T test.txt \
  http://fe_host:8030/api/testdb/testtable/_stream_load

# 响应
{
  "TxnId": 18036,
  "Label": "55c8ffc9-1c40-4d51-b75e-f2265b3602ef",
  "TwoPhaseCommit": "true",
  "Status": "Success"
}
```

4.1.4 接口名称：Stream Load 2PC提交/回滚

- 请求方式：PUT
- URL路径：/api/{db}/{table}/_stream_load_2pc
- 请求头：
  - txn_id (String, 二选一) - 事务ID
  - label (String, 二选一) - 事务Label
  - txn_operation (String, 必须) - "commit"或"abort"
  - Authorization (String, 必须) - Basic认证
- 请求参数：无Body
- 响应格式：
```json
{
  "status": "Success",
  "msg": "transaction [18036] commit successfully."
}
```
- 错误码定义：
  - 400 - 参数错误
  - 404 - 事务不存在
  - 500 - 操作失败
- 示例请求/响应：
```bash
# 提交请求
curl -X PUT --location-trusted -u user:passwd \
  -H "txn_id:18036" \
  -H "txn_operation:commit" \
  http://fe_host:8030/api/testdb/testtable/_stream_load_2pc

# 响应
{
  "status": "Success",
  "msg": "transaction [18036] commit successfully."
}
```

4.2 内部接口

4.2.1 服务接口

- 接口名称：DatabaseTransactionMgr.beginTransaction
- 方法签名：
```java
public long beginTransaction(List<Long> tableIdList, String label, 
    TxnCoordinator coordinator, TransactionSourceType sourceType, 
    long listenerId, long timeout)
    throws AnalysisException, LabelAlreadyUsedException, 
           BeginTransactionException, DuplicatedRequestException
```
- 参数说明：
  - tableIdList - 涉及的表ID列表
  - label - 事务Label
  - coordinator - 事务协调器信息
  - sourceType - 事务来源类型
  - listenerId - 监听器ID
  - timeout - 超时时间（秒）
- 返回值说明：
  - long - 分配的事务ID
- 依赖服务：
  - LabelManager - 检查和注册Label
  - EditLog - 持久化事务日志

4.2.2 服务接口

- 接口名称：DatabaseTransactionMgr.commitTransaction
- 方法签名：
```java
public void commitTransaction(long transactionId, 
    List<TabletCommitInfo> tabletCommitInfos,
    TxnCommitAttachment txnCommitAttachment)
    throws UserException
```
- 参数说明：
  - transactionId - 事务ID
  - tabletCommitInfos - Tablet提交信息列表
  - txnCommitAttachment - 事务提交附件信息
- 返回值说明：
  - void
- 依赖服务：
  - PublishVersionDaemon - 发布版本
  - EditLog - 持久化事务日志

4.2.3 服务接口

- 接口名称：BE Thrift接口 - publish_version
- 方法签名：
```thrift
TPublishVersionResult publish_version(TPublishVersionRequest request)
```
- 参数说明：
  - request.transactionId - 事务ID
  - request.partitionVersionInfos - 分区版本信息列表
- 返回值说明：
  - TPublishVersionResult - 发布结果，包含失败的Tablet列表
- 依赖服务：
  - RowSetManager - 发布RowSet

5. 配置设计

5.1 配置文件

5.1.1 文件：fe.conf

- 文件格式：Properties
- 配置项：
  - label_keep_max_second (long)
    - 功能：Label保留的最大时间
    - 默认值：259200（3天）
    - 说明：超过此时间的Label会被自动清理
  - label_num_threshold (int)
    - 功能：触发Label淘汰的数量阈值
    - 默认值：2000
    - 说明：当Label数量超过此值时触发淘汰
  - max_running_txn_num_per_db (int)
    - 功能：每个数据库最大运行中事务数
    - 默认值：100
    - 说明：超过此值时新事务会失败
  - transaction_timeout_second (long)
    - 功能：事务默认超时时间
    - 默认值：300（5分钟）
    - 说明：超时的事务会自动回滚
- 热更新支持：部分支持（通过ADMIN SET命令）

5.1.2 文件：Session变量

- 配置项：
  - insert_timeout (int)
    - 功能：INSERT语句超时时间
    - 默认值：3600（1小时）
    - 单位：秒
  - query_timeout (int)
    - 功能：查询超时时间
    - 默认值：300（5分钟）
    - 单位：秒
  - transaction_insert (boolean)
    - 功能：是否开启事务写入
    - 默认值：true
    - 说明：控制INSERT INTO VALUES是否使用事务
- 热更新支持：是（通过SET命令）

6. 错误处理设计

6.1 错误分类

| 错误类型 | 错误码范围 | 处理策略 | 日志级别 |
|---------|-----------|---------|---------|
| 参数校验错误 | 1064 | 返回错误信息 | WARN |
| Label冲突 | 5025 | 返回已存在的事务信息 | WARN |
| 事务不存在 | 5026 | 返回错误信息 | WARN |
| 提交失败 | 5027 | 回滚事务 | ERROR |
| 超时错误 | 5028 | 自动回滚 | WARN |
| 系统内部错误 | 5000 | 回滚事务并报警 | ERROR |

6.2 错误处理机制

- 重试机制：
  * 网络超时自动重试：
    * 最大重试次数：3次
    * 重试间隔：指数退避（1s, 2s, 4s）
  * Label冲突不重试：
    * 如果Label对应的事务已成功，返回成功
    * 如果Label对应的事务失败/运行中，返回错误

- 降级方案：
  * 事务提交失败自动回滚
  * 部分BE不可用时，使用可用副本继续
  * publish version失败时，标记事务为COMMITTED但不VISIBLE

- 报警机制：
  * 报警条件：
    * 事务提交失败率超过阈值
    * 事务超时数量超过阈值
    * Label淘汰失败
  * 报警方式：
    * 日志记录：ERROR级别日志
    * 监控指标：Prometheus指标

7. 部署与运维设计

7.1 监控指标

| 指标名称 | 采集方式 | 报警阈值 | 处理建议 |
|---------|---------|---------|---------|
| doris_fe_txn_running_count | Prometheus | >1000 | 检查事务是否正常提交 |
| doris_fe_txn_commit_latency_ms | Prometheus | P99>5000ms | 检查BE状态和网络 |
| doris_fe_txn_failed_count | Prometheus | >10/min | 检查错误日志 |
| doris_fe_label_count | Prometheus | >1800 | 检查Label淘汰是否正常 |
| doris_be_publish_version_latency_ms | Prometheus | P99>1000ms | 检查磁盘IO |

7.2 日志规范

- 日志级别：DEBUG/INFO/WARN/ERROR
- 日志格式：
```
[timestamp] [level] [thread] [class] [txnId] [label] message [key=value]*
```
- 示例：
```
2025-06-20 10:30:45.123 INFO [TransactionMgr] [txn_123456] [my_label] Begin transaction, tables=[1001, 1002]
2025-06-20 10:30:46.456 INFO [TransactionMgr] [txn_123456] [my_label] Commit transaction success, duration=1333ms
2025-06-20 10:30:47.789 WARN [TransactionMgr] [txn_123457] [error_label] Commit failed, reason=Replica not enough
```
- 关键日志点：
  * FE端：
    * INFO：事务开始、提交成功、回滚
    * WARN：Label冲突、提交警告
    * ERROR：提交失败、系统异常
  * BE端：
    * INFO：数据写入完成、publish version成功
    * WARN：写入慢
    * ERROR：写入失败、publish失败
