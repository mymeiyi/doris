1. 功能设计概述

1.1 功能基本信息

- 功能名称：事务两阶段提交（Transaction Two-Phase Commit）
- 关联需求编号：Transaction-2PC-REQ-001
- 设计负责人：陈明雨
- 设计日期：2025-06-20
- 版本：V1.0
1.2 设计目标

- 实现两阶段提交（2PC）协议，支持外部系统（如Flink）协调事务
- 通过FE统一管理事务状态，实现分布式环境下的事务一致性
- 提供Label机制实现导入去重，保证Exactly-Once语义
- 提供HTTP接口供外部系统进行事务协调
- 实现事务状态机，管理事务从创建到完成的完整生命周期
2. 整体架构设计

2.1 架构示意图

两阶段提交采用FE集中管理的架构模式：

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           External Coordinator                               │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │                     Flink / 其他外部协调器                              │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐                    │ │
│  │  │  Checkpoint │  │   2PC       │  │  Recovery   │                    │ │
│  │  │  Manager    │  │ Coordinator │  │  Manager    │                    │ │
│  │  └─────────────┘  └─────────────┘  └─────────────┘                    │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                    HTTP (Stream Load 2PC API)
                                    ↓
┌─────────────────────────────────────────────────────────────────────────────┐
│                              FE (Frontend)                                   │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │                      2PC Transaction Layer                             │ │
│  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐       │ │
│  │  │  HTTP Handler   │  │  Transaction    │  │    Label        │       │ │
│  │  │  (2PC API)      │  │    Manager      │  │   Manager       │       │ │
│  │  └─────────────────┘  └─────────────────┘  └─────────────────┘       │ │
│  │           │                    │                    │                 │ │
│  │           ↓                    ↓                    ↓                 │ │
│  │  ┌─────────────────────────────────────────────────────────────────┐ │ │
│  │  │                  Transaction State Machine                       │ │ │
│  │  │                                                                   │ │ │
│  │  │    ┌─────────┐     ┌──────────────┐     ┌───────────┐           │ │ │
│  │  │    │ PREPARE │────>│ PRECOMMITTED │────>│ COMMITTED │           │ │ │
│  │  │    └─────────┘     └──────────────┘     └───────────┘           │ │ │
│  │  │         │                  │                   │                 │ │ │
│  │  │         │                  │                   ↓                 │ │ │
│  │  │         │                  │            ┌─────────┐             │ │ │
│  │  │         └──────────────────┴───────────>│ ABORTED │             │ │ │
│  │  │                                         └─────────┘             │ │ │
│  │  │                   ↓                                              │ │ │
│  │  │            ┌─────────┐                                          │ │ │
│  │  │            │ VISIBLE │                                          │ │ │
│  │  │            └─────────┘                                          │ │ │
│  │  └─────────────────────────────────────────────────────────────────┘ │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │                         Metadata Layer                                 │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐                   │ │
│  │  │ Transaction │  │   Label     │  │   EditLog   │                   │ │
│  │  │   Storage   │  │   Storage   │  │ (持久化)    │                   │ │
│  │  └─────────────┘  └─────────────┘  └─────────────┘                   │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────┘
```

架构层次：

1. 外部协调器层（External Coordinator）：
- Flink或其他外部系统作为事务协调器
- 负责决定事务最终提交还是回滚
- 通过Checkpoint机制保证故障恢复
2. FE层（Frontend）：
- HTTP Handler：提供Stream Load 2PC的REST API
- Transaction Manager：管理事务状态和生命周期
- Label Manager：管理Label去重
- Transaction State Machine：事务状态机，管理状态转换
- Metadata Layer：事务元数据的存储和持久化
3. 模块详细设计

3.1 模块划分

3.1.1 FE端模块

1. HTTP接口模块（Stream Load 2PC Handler）
- 功能：提供2PC的HTTP REST接口
- 职责：
  - 处理预提交请求（_stream_load with two_phase_commit:true）
  - 处理提交请求（_stream_load_2pc with txn_operation:commit）
  - 处理回滚请求（_stream_load_2pc with txn_operation:abort）
2. 事务管理模块（TransactionMgr）
- 功能：管理事务的生命周期
- 职责：
  - 事务创建和状态管理
  - 事务提交和回滚
  - 超时事务清理
3. Label管理模块（LabelManager）
- 功能：管理事务Label，实现去重功能
- 职责：
  - Label的创建、查询、淘汰
  - Label唯一性检查
4. 事务状态机模块
- 功能：管理事务状态转换
- 职责：
  - 状态转换的合法性检查
  - 状态变更的持久化
3.2 关键流程设计

3.2.1 Stream Load 2PC完整流程

流程名称：Stream Load两阶段提交流程

流程图：

```
┌──────────────┐                    ┌──────────────┐
│   External   │                    │      FE      │
│  Coordinator │                    │              │
└──────┬───────┘                    └──────┬───────┘
       │                                   │
       │  1. Stream Load Request           │
       │     (two_phase_commit:true)       │
       │──────────────────────────────────>│
       │                                   │
       │                          2. 创建事务，状态=PREPARE
       │                                   │
       │                          3. 数据写入处理
       │                                   │
       │                          4. 状态转为PRECOMMITTED
       │                                   │
       │  5. 返回TxnId, Label              │
       │     Status=Success                │
       │<──────────────────────────────────│
       │                                   │
       │  ... (外部协调决策) ...            │
       │                                   │
       │  6a. Commit Request               │
       │      (txn_operation:commit)       │
       │──────────────────────────────────>│
       │                          7a. 状态转为COMMITTED
       │                          8a. 发布版本，状态=VISIBLE
       │  9a. 返回Success                  │
       │<──────────────────────────────────│
       │                                   │
       │  --- 或者 ---                     │
       │                                   │
       │  6b. Abort Request                │
       │      (txn_operation:abort)        │
       │──────────────────────────────────>│
       │                          7b. 状态转为ABORTED
       │                          8b. 清理资源
       │  9b. 返回Success                  │
       │<──────────────────────────────────│
```

步骤说明：

1. 预提交阶段（Phase 1 - Prepare）：
- 外部协调器发送Stream Load请求，Header包含`two_phase_commit:true`
- FE创建事务，分配TxnId，检查Label唯一性
- 数据写入处理
- 事务状态转为PRECOMMITTED
- 返回TxnId和Label给外部协调器
2. 提交阶段（Phase 2 - Commit）：
- 外部协调器发送提交请求
- FE验证事务状态（必须是PRECOMMITTED）
- 事务状态转为COMMITTED
- 发布版本使数据可见
- 事务状态转为VISIBLE
- 返回成功
3. 回滚阶段（Phase 2 - Abort）：
- 外部协调器发送回滚请求
- FE验证事务状态
- 事务状态转为ABORTED
- 清理相关资源
- 返回成功
3.2.2 Flink Exactly-Once集成流程

流程名称：Flink EOS集成流程

```
Flink任务                             Doris FE
   │                                     │
   │  1. 开始Checkpoint                  │
   │                                     │
   │  2. Stream Load (2PC预提交)         │
   │──────────────────────────────────>  │
   │                                     │
   │  3. 返回TxnId (PRECOMMITTED)        │
   │<──────────────────────────────────  │
   │                                     │
   │  4. 记录TxnId到Checkpoint状态        │
   │                                     │
   │  5. Checkpoint完成通知              │
   │                                     │
   │  6. 2PC Commit                      │
   │──────────────────────────────────>  │
   │                                     │
   │  7. 返回Success (VISIBLE)           │
   │<──────────────────────────────────  │
   │                                     │
   │  === 故障恢复场景 ===               │
   │                                     │
   │  8. 从Checkpoint恢复                │
   │                                     │
   │  9. 检查TxnId状态                   │
   │──────────────────────────────────>  │
   │                                     │
   │  10. 返回事务状态                   │
   │<──────────────────────────────────  │
   │                                     │
   │  11. 根据状态决定重提交或跳过        │
```

4. 数据模型设计

4.1 事务状态数据结构

```java
// 事务状态枚举
enum TransactionStatus {
    PREPARE,        // 事务已创建，等待数据写入
    PRECOMMITTED,   // 数据已写入，等待提交指令（2PC特有）
    COMMITTED,      // 事务已提交
    VISIBLE,        // 数据已可见
    ABORTED         // 事务已回滚
}

// 事务状态类
class TransactionState {
    long txnId;                    // 事务ID
    String label;                  // 事务Label
    long dbId;                     // 数据库ID
    List<Long> tableIdList;        // 涉及的表ID列表
    TransactionStatus status;      // 当前状态
    long prepareTime;              // 准备时间
    long preCommitTime;            // 预提交时间（2PC）
    long commitTime;               // 提交时间
    long finishTime;               // 完成时间
    String reason;                 // 失败原因
    TransactionSourceType sourceType;  // 事务来源类型
}
```

4.2 Label数据结构

```java
// Label信息
class LabelInfo {
    String label;          // Label名称
    long txnId;            // 关联的事务ID
    long dbId;             // 数据库ID
    long createTime;       // 创建时间
    TransactionStatus status;  // 事务状态
}
```

4.3 事务状态转换规则

| 当前状态 | 允许的操作 | 目标状态 |
|---------|-----------|---------|
| PREPARE | 数据写入完成 | PRECOMMITTED |
| PREPARE | 回滚 | ABORTED |
| PRECOMMITTED | 提交 | COMMITTED |
| PRECOMMITTED | 回滚 | ABORTED |
| PRECOMMITTED | 超时 | ABORTED |
| COMMITTED | 发布完成 | VISIBLE |
| VISIBLE | - | 终态 |
| ABORTED | - | 终态 |

5. 接口设计

5.1 外部接口

5.1.1 Stream Load 2PC预提交接口

* 接口端点：POST /api/{db}/{table}/_stream_load

* 请求方法：POST

* 请求头：
| 头字段 | 是否必须 | 示例值 | 说明 |
|-------|---------|--------|------|
| two_phase_commit | 是 | true | 启用两阶段提交 |
| label | 否 | my_label | 自定义Label |
| Authorization | 是 | Basic xxx | 认证信息 |

* 请求Body：数据文件内容

* 返回结果：
```json
{
    "TxnId": 18036,
    "Label": "55c8ffc9-1c40-4d51-b75e-f2265b3602ef",
    "TwoPhaseCommit": "true",
    "Status": "Success",
    "Message": "OK",
    "NumberTotalRows": 100,
    "NumberLoadedRows": 100,
    "NumberFilteredRows": 0,
    "NumberUnselectedRows": 0,
    "LoadBytes": 1031,
    "LoadTimeMs": 77,
    "BeginTxnTimeMs": 1,
    "StreamLoadPutTimeMs": 1,
    "ReadDataTimeMs": 0,
    "WriteDataTimeMs": 58,
    "CommitAndPublishTimeMs": 0
}
```

5.1.2 Stream Load 2PC提交接口

* 接口端点：PUT /api/{db}/{table}/_stream_load_2pc

* 请求方法：PUT

* 请求头：
| 头字段 | 是否必须 | 示例值 | 说明 |
|-------|---------|--------|------|
| txn_id | 二选一 | 18036 | 事务ID |
| label | 二选一 | my_label | 事务Label |
| txn_operation | 是 | commit | 操作类型 |
| Authorization | 是 | Basic xxx | 认证信息 |

* 返回结果：
```json
{
    "status": "Success",
    "msg": "transaction [18036] commit successfully."
}
```

5.1.3 Stream Load 2PC回滚接口

* 接口端点：PUT /api/{db}/{table}/_stream_load_2pc

* 请求方法：PUT

* 请求头：
| 头字段 | 是否必须 | 示例值 | 说明 |
|-------|---------|--------|------|
| txn_id | 二选一 | 18037 | 事务ID |
| label | 二选一 | my_label | 事务Label |
| txn_operation | 是 | abort | 操作类型 |
| Authorization | 是 | Basic xxx | 认证信息 |

* 返回结果：
```json
{
    "status": "Success",
    "msg": "transaction [18037] abort successfully."
}
```

5.2 内部接口

5.2.1 事务状态查询接口

* 类/方法名：TransactionMgr.getTransactionState()
* 参数：
  - dbId (long) - 数据库ID
  - txnId (long) - 事务ID
* 返回值：TransactionState - 事务状态对象

5.2.2 事务提交接口

* 类/方法名：TransactionMgr.commitTransaction()
* 参数：
  - dbId (long) - 数据库ID
  - txnId (long) - 事务ID
* 返回值：void
* 异常处理：
  - TransactionNotFoundException - 事务不存在
  - TransactionCommitFailedException - 提交失败

5.2.3 事务回滚接口

* 类/方法名：TransactionMgr.abortTransaction()
* 参数：
  - dbId (long) - 数据库ID
  - txnId (long) - 事务ID
  - reason (String) - 回滚原因
* 返回值：void

6. 性能与安全设计

6.1 性能优化设计

6.1.1 事务状态管理优化

* 状态缓存：事务状态在FE内存中缓存，减少磁盘访问
* 异步持久化：状态变更异步写入EditLog
* 批量操作：支持批量查询事务状态

6.1.2 Label管理优化

* 内存索引：Label使用HashMap存储，O(1)查询复杂度
* 定期清理：后台线程定期清理过期Label
* 数量限制：超过阈值时触发淘汰

6.2 安全设计

6.2.1 权限控制

* 接口认证：HTTP接口需要Basic认证
* 操作授权：只有具有表写入权限的用户才能执行2PC操作
* 事务隔离：不同用户的事务相互隔离

6.2.2 数据安全

* 原子性保证：2PC协议保证事务原子性
* Label去重：防止重复导入
* 状态持久化：事务状态持久化到EditLog，支持故障恢复

6.2.3 异常处理与容错

* 超时机制：PRECOMMITTED状态的事务超时自动回滚
* 故障恢复：外部协调器可以通过查询事务状态实现故障恢复
* 幂等操作：重复的提交/回滚操作幂等处理

7. 设计约束与限制

7.1 已知限制

1. 超时限制：
- PRECOMMITTED状态的事务有超时限制，超时后自动回滚
- 外部协调器需要在超时前完成提交或回滚
2. Label淘汰：
- Label会根据时间（默认3天）和数量（默认2000个）自动淘汰
- 淘汰后相同Label可以再次使用，不再具有去重语义
3. 单点协调：
- 事务状态由FE集中管理
- FE故障可能影响进行中的2PC事务
7.2 假设条件

1. 外部协调器可靠性：假设外部协调器（如Flink）正确实现2PC协议
2. 网络稳定性：假设外部协调器与FE之间网络相对稳定
3. 超时配置合理：假设超时时间配置能满足外部协调器的处理需求
7.3 技术债务

1. 分布式事务协调：
- 当前依赖外部协调器，未来可考虑内置分布式事务协调
2. 跨FE事务：
- 当前事务状态在单个FE管理，多FE场景需要考虑一致性
8. 附录

8.1 配置参数说明

8.1.1 FE端配置

* **`label_keep_max_second`** (FE配置)
- 功能：Label保留的最大时间
- 默认值：259200（3天）
- 单位：秒

* **`label_num_threshold`** (FE配置)
- 功能：触发Label淘汰的数量阈值
- 默认值：2000

* **`max_running_txn_num_per_db`** (FE配置)
- 功能：每个数据库最大运行中事务数
- 默认值：100

* **`streaming_label_keep_max_second`** (FE配置)
- 功能：Stream Load Label保留时间
- 默认值：43200（12小时）

8.2 使用示例

8.2.1 Stream Load 2PC完整示例

```bash
# 步骤1：预提交（Phase 1）
curl --location-trusted -u user:passwd \
  -H "two_phase_commit:true" \
  -H "label:my_2pc_label" \
  -T data.csv \
  http://fe_host:8030/api/testdb/testtable/_stream_load

# 返回：
# {
#     "TxnId": 18036,
#     "Label": "my_2pc_label",
#     "TwoPhaseCommit": "true",
#     "Status": "Success"
# }

# 步骤2a：提交（Phase 2 - Commit）
curl -X PUT --location-trusted -u user:passwd \
  -H "txn_id:18036" \
  -H "txn_operation:commit" \
  http://fe_host:8030/api/testdb/testtable/_stream_load_2pc

# 返回：
# {
#     "status": "Success",
#     "msg": "transaction [18036] commit successfully."
# }

# 或者 步骤2b：回滚（Phase 2 - Abort）
curl -X PUT --location-trusted -u user:passwd \
  -H "txn_id:18036" \
  -H "txn_operation:abort" \
  http://fe_host:8030/api/testdb/testtable/_stream_load_2pc

# 返回：
# {
#     "status": "Success",
#     "msg": "transaction [18036] abort successfully."
# }
```

8.2.2 使用Label进行提交/回滚

```bash
# 使用Label提交
curl -X PUT --location-trusted -u user:passwd \
  -H "label:my_2pc_label" \
  -H "txn_operation:commit" \
  http://fe_host:8030/api/testdb/testtable/_stream_load_2pc

# 使用Label回滚
curl -X PUT --location-trusted -u user:passwd \
  -H "label:my_2pc_label" \
  -H "txn_operation:abort" \
  http://fe_host:8030/api/testdb/testtable/_stream_load_2pc
```

8.3 相关文档

- 事务功能说明：transaction.md
- Flink Doris Connector文档
