1. 功能设计概述

1.1 功能基本信息

- 功能名称：事务（Transaction）
- 关联需求编号：Transaction-REQ-001
- 设计负责人：陈明雨
- 设计日期：2025-06-20
- 版本：V1.0
1.2 设计目标

- 实现数据写入的原子性保证机制，确保事务中的所有操作要么全部成功，要么全部失败
- 通过FE和BE协同工作，实现分布式环境下的事务管理
- 提供Label机制实现导入去重，保证Exactly-Once语义
- 支持两阶段提交（2PC），为外部系统提供事务协调能力
- 实现READ COMMITTED隔离级别，保证数据一致性
- 提升系统的可靠性和数据完整性
2. 整体架构设计

2.1 架构示意图

事务功能采用FE和BE协同工作的架构模式：

┌─────────────────────────────────────────────────────────────────────────┐
│                            Client Layer                                   │
│  ┌───────────────────┐  ┌───────────────────┐  ┌───────────────────┐    │
│  │   MySQL Client    │  │   JDBC Client     │  │   HTTP Client     │    │
│  │   (BEGIN/COMMIT)  │  │   (Transaction)   │  │   (Stream Load)   │    │
│  └───────────────────┘  └───────────────────┘  └───────────────────┘    │
└─────────────────────────────────────────────────────────────────────────┘
                                    ↓
┌─────────────────────────────────────────────────────────────────────────┐
│                          FE (Frontend)                                    │
│  ┌───────────────────────────────────────────────────────────────────┐  │
│  │  事务管理模块                                                        │  │
│  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐    │  │
│  │  │ TransactionMgr  │  │   LabelManager  │  │  Coordinator    │    │  │
│  │  │ (事务状态管理)   │  │   (Label管理)   │  │  (事务协调器)   │    │  │
│  │  └─────────────────┘  └─────────────────┘  └─────────────────┘    │  │
│  │           ↓                    ↓                    ↓             │  │
│  │  ┌─────────────────────────────────────────────────────────────┐  │  │
│  │  │              Transaction State Machine                       │  │  │
│  │  │  PREPARE → PRECOMMITTED → COMMITTED → VISIBLE               │  │  │
│  │  │                    ↓                                          │  │  │
│  │  │               ABORTED                                         │  │  │
│  │  └─────────────────────────────────────────────────────────────┘  │  │
│  └───────────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────┘
                                    ↓ (RPC/Thrift)
┌─────────────────────────────────────────────────────────────────────────┐
│                          BE (Backend)                                     │
│  ┌───────────────────────────────────────────────────────────────────┐  │
│  │  数据写入模块                                                        │  │
│  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐    │  │
│  │  │  Delta Writer   │  │  Tablet Writer  │  │   RowSet Mgr    │    │  │
│  │  │  (增量数据写入)  │  │  (Tablet写入)   │  │  (RowSet管理)   │    │  │
│  │  └─────────────────┘  └─────────────────┘  └─────────────────┘    │  │
│  │           ↓                    ↓                    ↓             │  │
│  │  ┌─────────────────────────────────────────────────────────────┐  │  │
│  │  │                      Storage Layer                           │  │  │
│  │  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐          │  │  │
│  │  │  │   Tablet    │  │   Tablet    │  │   Tablet    │ ...      │  │  │
│  │  │  │  (Replica)  │  │  (Replica)  │  │  (Replica)  │          │  │  │
│  │  │  └─────────────┘  └─────────────┘  └─────────────┘          │  │  │
│  │  └─────────────────────────────────────────────────────────────┘  │  │
│  └───────────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────┘

架构层次：

1. Client层（客户端）：
- MySQL Client：通过MySQL协议执行BEGIN/COMMIT/ROLLBACK
- JDBC Client：通过JDBC连接执行事务操作
- HTTP Client：通过HTTP接口执行Stream Load 2PC
2. FE层（Frontend）：
- TransactionMgr：负责事务状态管理和生命周期控制
- LabelManager：负责Label的管理和去重检查
- Coordinator：负责事务的协调，协调多个BE的数据写入
- Transaction State Machine：事务状态机，管理事务状态转换
3. BE层（Backend）：
- Delta Writer：负责增量数据的写入
- Tablet Writer：负责向Tablet写入数据
- RowSet Manager：负责RowSet的管理
- Storage Layer：底层存储层，管理Tablet和副本
3. 模块详细设计

3.1 模块划分

3.1.1 FE端模块

1. 事务管理模块（TransactionMgr）
- 功能：管理事务的生命周期，包括开启、提交、回滚
- 职责：维护事务状态，协调多个BE的数据提交
2. Label管理模块（LabelManager）
- 功能：管理事务的Label，实现去重功能
- 职责：Label的创建、查询、淘汰
3. 事务协调模块（Coordinator）
- 功能：协调分布式事务的执行
- 职责：向BE发送写入任务，收集写入结果
4. 两阶段提交服务（2PC Service）
- 功能：提供Stream Load 2PC的HTTP接口
- 职责：处理PREPARE、COMMIT、ABORT请求
3.1.2 BE端模块

1. 数据写入模块（Delta Writer）
- 功能：负责事务数据的写入
- 职责：接收数据并写入到内存，等待提交指令
2. Tablet写入模块（Tablet Writer）
- 功能：负责向具体Tablet写入数据
- 职责：数据序列化、写入、副本同步
3. 提交控制模块
- 功能：控制数据的提交和可见性
- 职责：在收到FE的提交指令后，使数据可见
3.2 关键流程设计

3.2.1 显式事务流程

流程名称：显式事务执行流程

流程图：

Client                    FE                           BE
  │                        │                            │
  │  1. BEGIN              │                            │
  │───────────────────────>│                            │
  │  返回Label和状态        │                            │
  │<───────────────────────│                            │
  │                        │                            │
  │  2. INSERT/UPDATE/     │                            │
  │     DELETE语句          │                            │
  │───────────────────────>│  2.1 开启子事务            │
  │                        │───────────────────────────>│
  │                        │  2.2 数据写入              │
  │                        │<───────────────────────────│
  │  返回执行结果           │                            │
  │<───────────────────────│                            │
  │                        │                            │
  │  3. COMMIT             │                            │
  │───────────────────────>│  3.1 发送提交指令          │
  │                        │───────────────────────────>│
  │                        │  3.2 数据持久化            │
  │                        │<───────────────────────────│
  │  返回VISIBLE状态        │                            │
  │<───────────────────────│                            │

步骤说明：

1. 事务开启阶段：
- Client发送BEGIN命令
- FE创建事务上下文，生成或使用用户指定的Label
- 返回事务状态（PREPARE）和Label信息
2. 数据写入阶段：
- Client发送INSERT/UPDATE/DELETE语句
- FE解析SQL，生成执行计划
- FE将数据发送到BE进行写入
- BE将数据写入内存，但不可见
- 返回执行结果（状态仍为PREPARE）
3. 事务提交阶段：
- Client发送COMMIT命令
- FE向所有涉及的BE发送提交指令
- BE持久化数据，使数据可见
- FE更新事务状态为VISIBLE
- 返回提交结果
3.2.2 Stream Load 2PC流程

流程名称：Stream Load两阶段提交流程

流程图：

Client                    FE/BE                         Storage
  │                        │                              │
  │  1. Stream Load        │                              │
  │     (two_phase_commit) │                              │
  │───────────────────────>│  1.1 数据写入                │
  │                        │────────────────────────────>│
  │  返回TxnId/Label       │                              │
  │<───────────────────────│                              │
  │                        │                              │
  │  ... (外部协调)...      │                              │
  │                        │                              │
  │  2. Commit/Abort       │                              │
  │───────────────────────>│  2.1 提交/回滚数据           │
  │                        │────────────────────────────>│
  │  返回结果               │                              │
  │<───────────────────────│                              │

步骤说明：

1. 预提交阶段（PREPARE）：
- Client发送Stream Load请求，Header中设置two_phase_commit:true
- 数据写入BE，但不提交
- 返回TxnId和Label，事务处于PRECOMMITTED状态
2. 提交/回滚阶段：
- Client根据外部协调结果，发送COMMIT或ABORT请求
- 可以使用txn_id或label指定事务
- FE协调BE完成数据提交或回滚
4. 数据模型设计

4.1 事务数据结构设计

事务是Doris中数据写入的核心数据单元，包含以下信息：

// 事务数据结构（伪代码）
class Transaction {
    // 事务唯一标识
    long txnId;
    
    // 事务Label（用于去重）
    String label;
    
    // 数据库ID
    long dbId;
    
    // 涉及的表ID列表
    List<Long> tableIds;
    
    // 涉及的Tablet ID列表
    List<Long> tabletIds;
    
    // 事务状态
    TransactionStatus status;  // PREPARE, PRECOMMITTED, COMMITTED, VISIBLE, ABORTED
    
    // 创建时间
    long createTime;
    
    // 提交时间
    long commitTime;
    
    // 超时时间
    long timeout;
    
    // 关联的写入任务
    List<WriteTask> writeTasks;
}

4.2 Label数据结构

// Label数据结构（伪代码）
class LabelInfo {
    // Label名称
    String label;
    
    // 关联的事务ID
    long txnId;
    
    // 数据库ID
    long dbId;
    
    // 创建时间
    long createTime;
    
    // Label状态
    LabelStatus status;  // PREPARE, COMMITTED, VISIBLE, ABORTED
}

4.3 数据关系图

Client请求
    ↓
FE接收并解析
    ↓
TransactionMgr创建事务 → LabelManager检查/创建Label
    ↓
Coordinator分发写入任务
    ↓
BE接收数据 → Delta Writer写入 → Tablet
    ↓
FE发送提交指令
    ↓
BE持久化 → 数据可见

4.4 事务状态机

事务状态转换图：

┌─────────┐     开启事务      ┌─────────┐
│  INIT   │ ─────────────────>│ PREPARE │
└─────────┘                   └─────────┘
                                   │
                      ┌────────────┴────────────┐
                      │                         │
                 预提交(2PC)                 直接提交
                      │                         │
                      ↓                         │
               ┌─────────────┐                  │
               │ PRECOMMITTED│                  │
               └─────────────┘                  │
                      │                         │
                      ├─────────────────────────┤
                      │                         │
                   提交成功                   提交失败/回滚
                      │                         │
                      ↓                         ↓
               ┌───────────┐             ┌─────────┐
               │ COMMITTED │             │ ABORTED │
               └───────────┘             └─────────┘
                      │
                  数据可见
                      ↓
               ┌─────────┐
               │ VISIBLE │
               └─────────┘

5. 接口设计

5.1 外部接口

5.1.1 事务控制SQL接口

* BEGIN - 开启事务
```sql
BEGIN;
BEGIN WITH LABEL {user_label};
```

* COMMIT - 提交事务
```sql
COMMIT;
```

* ROLLBACK - 回滚事务
```sql
ROLLBACK;
```

5.1.2 Stream Load 2PC HTTP接口

* 预提交接口：
```
POST /api/{db}/{table}/_stream_load
Header: two_phase_commit: true
```

* 提交接口：
```
PUT /api/{db}/{table}/_stream_load_2pc
Header: txn_id: {txnId} 或 label: {label}
Header: txn_operation: commit
```

* 回滚接口：
```
PUT /api/{db}/{table}/_stream_load_2pc
Header: txn_id: {txnId} 或 label: {label}
Header: txn_operation: abort
```

5.2 内部接口

5.2.1 FE-BE事务接口

* 类/方法名：BE.beginTransaction()
* 参数：transactionId, tableIds, tabletIds
* 返回值：执行结果

* 类/方法名：BE.commitTransaction()
* 参数：transactionId
* 返回值：执行结果

* 类/方法名：BE.abortTransaction()
* 参数：transactionId
* 返回值：执行结果

6. 性能与安全设计

6.1 性能优化设计

6.1.1 批量写入优化

* 事务批量提交：通过事务将多个INSERT INTO VALUES合并，减少提交开销
* 减少网络往返：事务内的多个语句共享同一个事务上下文
* 并行写入：支持多个BE并行写入数据

6.1.2 内存优化

* 事务数据缓存：数据在BE内存中缓存，提交时批量持久化
* Label淘汰机制：自动淘汰过期Label，默认超过2000个或3天自动淘汰

6.1.3 提交优化

* 异步提交：提交操作可以异步执行，减少客户端等待时间
* 副本并行同步：多副本并行写入，提升提交效率

6.2 安全设计

6.2.1 权限控制

* 事务权限验证：执行事务操作前验证用户权限
* 表级别权限：用户必须具有相应表的写入权限

6.2.2 数据安全

* 原子性保证：事务要么全部成功，要么全部失败
* Label去重：防止重复导入
* 副本一致性：多副本写入保证数据一致性

6.2.3 异常处理与容错

* Session关闭自动回滚：Session中止或关闭时自动回滚未提交的事务
* 超时自动回滚：事务超时后自动回滚
* 部分失败处理：事务中某个语句失败时，该语句自动回滚，其他语句可继续

7. 设计约束与限制

7.1 已知限制

1. 不支持嵌套事务：
- 如果在事务执行中再次执行BEGIN，会被忽略
2. DDL和查询限制：
- 显式事务中不支持DDL和查询语句
- 只支持INSERT、UPDATE、DELETE
3. 隔离级别限制：
- 只支持READ COMMITTED隔离级别
- 事务中的语句不能看到同一事务中其他语句的修改
4. 混合写入限制：
- INSERT INTO VALUES和INSERT INTO SELECT不能混用
- 对相同表的DELETE必须在INSERT之前执行
5. 存算分离限制：
- 存算分离模式下事务写不支持Merge-on-Write表
7.2 假设条件

1. 网络稳定性：假设FE和BE之间的网络连接相对稳定
2. 存储可用性：假设底层存储系统正常可用
3. Session稳定性：假设Session在事务执行期间保持连接
7.3 技术债务

1. 嵌套事务支持：
- 当前不支持嵌套事务，未来可能需要支持
2. 更高隔离级别：
- 当前只支持READ COMMITTED，可能需要支持更高隔离级别
3. 跨事务语句可见性：
- 当前事务中语句不能看到同事务其他语句的修改，可能需要优化
8. 附录

8.1 配置参数说明

8.1.1 Session变量

* **`insert_timeout`** (Session变量)
- 功能：INSERT语句的超时时间
- 默认值：根据系统配置
- 说明：事务超时使用insert_timeout和query_timeout的最大值

* **`query_timeout`** (Session变量)
- 功能：查询语句的超时时间
- 默认值：根据系统配置

8.1.2 系统配置

* Label淘汰配置
- 数量阈值：默认2000个
- 时间阈值：默认3天
8.2 使用示例

8.2.1 显式事务示例

```sql
-- 开启事务
BEGIN;

-- 执行写入
INSERT INTO dt (id, name, score) VALUES (1, "Emily", 25);
INSERT INTO dt (id, name, score) VALUES (2, "Benjamin", 35);

-- 提交事务
COMMIT;
```

8.2.2 带Label的事务

```sql
-- 开启事务并指定Label
BEGIN WITH LABEL my_label_20250620;

-- 执行写入
INSERT INTO dt SELECT * FROM source_table;

-- 提交事务
COMMIT;
```

8.2.3 Stream Load 2PC示例

```bash
# 预提交
curl --location-trusted -u user:passwd \
  -H "two_phase_commit:true" \
  -T test.txt \
  http://fe_host:http_port/api/{db}/{table}/_stream_load

# 提交
curl -X PUT --location-trusted -u user:passwd \
  -H "txn_id:18036" \
  -H "txn_operation:commit" \
  http://fe_host:http_port/api/{db}/{table}/_stream_load_2pc
```

8.3 相关文档

- 事务功能说明：transaction.md
- 数据导入机制：Doris的数据导入机制以及原子性保证.pdf
