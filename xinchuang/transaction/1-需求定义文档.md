1. 功能基本信息
- 功能名称：事务（Transaction）
- 创建日期：2025-06-20
- 提出人：陈明雨
- 当前版本：V1.0
2. 功能概述

2.1 功能目标

- 提供数据写入的原子性保证，确保一组SQL语句要么全部成功执行，要么全部失败回滚，是一个不可分割的工作单位
- 支持显式事务和隐式事务两种模式，满足不同场景下的数据一致性需求
- 通过Label机制实现数据导入的不重不丢（Exactly-Once语义），保证数据一致性
- 支持两阶段提交（2PC），为Flink等外部系统提供端到端的精确一次语义支持
- 预期达到的效果：确保数据在导入过程中的原子性、一致性，支持多表事务写入，提供可靠的数据一致性保障
3. 功能详述

3.1 功能描述

- 事务是指一个操作，包含一个或多个SQL语句，这些语句的执行要么完全成功，要么完全失败，是一个不可分割的工作单位。Doris支持显式事务和隐式事务两种模式，为数据写入提供原子性保证。
- 功能具体内容：
  **显式事务**：
- 用户主动开启、提交或回滚事务
- 使用BEGIN开启事务，COMMIT提交事务，ROLLBACK回滚事务
- 支持设置Label标识事务，用于去重和状态查询
- 目前不支持DDL和查询语句
  **隐式事务**：
- 用户无需显式添加开启和提交事务的语句
- 每个导入语句在开始执行时自动开启事务
- 语句执行完成后自动提交，失败后自动回滚
- 每个查询或DDL也是一个隐式事务
  **事务类型支持**：
  | 事务类型 | 支持的操作 | 说明 |
  |---------|-----------|------|
  | 显式事务 | INSERT、UPDATE、DELETE | 需要BEGIN/COMMIT/ROLLBACK |
  | 隐式事务 | 所有导入操作、查询、DDL | 自动管理事务生命周期 |
  | Stream Load 2PC | Stream Load | 支持外部系统协调的两阶段提交 |
  | Broker Load多表事务 | 多表批量导入 | 多表导入原子生效 |
  
  **主要特性**：
  | 特性 | 说明 |
  |------|------|
  | 原子性 | 事务中的所有操作要么全部成功，要么全部失败 |
  | 隔离级别 | 支持READ COMMITTED隔离级别 |
  | Label机制 | 通过Label实现导入去重，保证不重不丢 |
  | 两阶段提交 | 支持Stream Load 2PC，用于Flink EOS语义 |
  | 多表事务 | 支持一个事务中操作多张表 |
  | Session级别 | 事务是Session级别的，Session关闭自动回滚 |
  
- 优势：
  1. 保证数据导入的原子性，避免部分数据写入导致的数据不一致
  2. 通过Label机制实现Exactly-Once语义，配合上游At-Least-Once可保证不重不丢
  3. 支持两阶段提交，可与Flink等外部系统协调实现端到端精确一次
  4. 多表事务支持，一个事务可以操作多张表，保证跨表操作的原子性
  5. 提升INSERT INTO VALUES的写入性能，通过事务批量提交减少开销
- 已知限制：
  1. 查询和DDL单个语句是隐式事务，不支持多语句事务中包含查询和DDL
  2. 目前Doris不支持嵌套事务
  3. 事务中的多个语句，每个语句不能读到本事务内其它语句做出的修改
  4. 存算分离模式下，事务写不支持Merge-on-Write表
  5. 两种事务写入（INSERT INTO SELECT/UPDATE/DELETE和INSERT INTO VALUES）不能混用
  6. 对相同表的删除必须在写入前执行
3.2 输入/输出

- 输入：
  - SQL语句：用户提交的事务控制语句（BEGIN、COMMIT、ROLLBACK）和DML语句
  - 配置参数：
    - insert_timeout：事务写入超时时间
    - query_timeout：查询超时时间
    - Label（可选）：用户自定义的事务标识，用于去重和状态查询
  - HTTP请求（Stream Load）：数据文件和事务控制参数
  - 元数据信息：表结构、分区信息等
- 输出：
  - 执行结果：事务状态（PREPARE/VISIBLE等）、影响行数、txnId等信息
  - 查询结果：符合SQL查询条件的数据结果集
  - 错误信息：事务执行失败时的错误提示
  - Label状态：可通过Label查询导入任务状态
4. 非功能性需求

4.1 性能要求

- 响应时间要求：
  - 事务开启（BEGIN）响应时间应在毫秒级别
  - 事务提交（COMMIT）时间取决于数据量，应尽可能快速完成
  - 单表多次INSERT INTO VALUES写入性能应显著优于非事务模式的多次单独写入
- 并发用户数：
  - 支持多用户并发事务操作
  - 每个Session可以独立管理自己的事务
  - 系统应能处理大量并发的事务提交请求
- 数据处理量：
  - 支持大规模数据的事务写入
  - 单个事务可以包含多个写入语句
  - Broker Load支持TB级别数据的原子导入
- 超时控制：
  - 事务超时使用Session变量insert_timeout和query_timeout的最大值
  - 超时后事务自动回滚，导入失败
4.2 安全性要求

- 权限控制：
  - 用户必须具有相应表的写入权限才能执行事务写入
  - 继承Doris现有的用户权限体系
  - 事务操作需要验证用户身份
- 数据保护：
  - 事务回滚时确保数据完全撤销，不会留下部分数据
  - Label机制防止重复导入
  - 两阶段提交保证数据不丢失
- 访问控制：
  - 事务是Session级别的，不同Session的事务相互隔离
  - Session关闭时自动回滚未提交的事务
  - 防止未授权的事务操作
4.3 兼容性要求

- 支持的数据库版本：
  - 支持Doris当前版本及后续版本
  - 向后兼容已有的导入方式
- SQL兼容性：
  - 使用标准的BEGIN/COMMIT/ROLLBACK语法
  - 兼容MySQL协议
  - 支持通过JDBC连接进行事务操作（需添加useLocalSessionState=true参数）
- 导入方式兼容性：
  - 支持INSERT INTO VALUES事务写入
  - 支持INSERT INTO SELECT事务写入
  - 支持UPDATE和DELETE事务写入
  - 支持Stream Load两阶段提交
  - 支持Broker Load多表事务
- 操作系统兼容性：
  - 支持Doris支持的所有操作系统平台（Linux等）
  - 不依赖特定的操作系统特性
- 外部系统兼容性：
  - 支持Flink Connector的EOS语义
  - 支持通过HTTP接口进行两阶段提交
  - 支持多种数据源的Broker Load
