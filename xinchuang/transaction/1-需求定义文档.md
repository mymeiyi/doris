1. 功能基本信息
- 功能名称：事务两阶段提交（Transaction Two-Phase Commit）
- 创建日期：2025-06-20
- 提出人：陈明雨
- 当前版本：V1.0
2. 功能概述

2.1 功能目标

- 提供数据写入的原子性保证，确保一组SQL语句要么全部成功执行，要么全部失败回滚，是一个不可分割的工作单位
- 支持显式事务和隐式事务两种模式，满足不同场景下的数据一致性需求
- 通过两阶段提交（2PC）协议，支持外部系统（如Flink）协调多个事务，实现端到端的精确一次（Exactly-Once）语义
- 通过Label机制实现数据导入的不重不丢，配合上游At-Least-Once语义保证Exactly-Once
- 预期达到的效果：确保数据在导入过程中的原子性、一致性，支持外部事务协调，提供可靠的数据一致性保障
3. 功能详述

3.1 功能描述

- 事务是指一个操作，包含一个或多个SQL语句，这些语句的执行要么完全成功，要么完全失败，是一个不可分割的工作单位。Doris通过两阶段提交协议支持外部系统协调事务，实现分布式场景下的数据一致性。
- 功能具体内容：
  **两阶段提交（2PC）机制**：
  两阶段提交是一种分布式事务协议，将事务提交过程分为两个阶段：
  
  | 阶段 | 名称 | 说明 |
  |------|------|------|
  | 第一阶段 | 预提交（Prepare） | 数据写入但不可见，事务处于PRECOMMITTED状态 |
  | 第二阶段 | 提交/回滚（Commit/Abort） | 根据协调者指令提交或回滚事务 |
  
  **Stream Load 2PC流程**：
  1. 预提交阶段：
     - 客户端发送Stream Load请求，Header中设置`two_phase_commit:true`
     - 数据写入Doris，但事务不提交
     - 返回TxnId和Label，事务处于PRECOMMITTED状态
  2. 提交/回滚阶段：
     - 客户端根据外部协调结果，发送COMMIT或ABORT请求
     - 可以使用txn_id或label指定事务
     - Doris完成数据提交或回滚
  
  **Label机制**：
  - Label是事务的唯一标识，用于实现去重
  - Label在数据库级别具有唯一性
  - 相同Label的事务只会成功执行一次
  - Label会根据时间和数量自动淘汰（默认超过2000个或3天）
  
  **隔离级别**：
  - Doris支持READ COMMITTED隔离级别
  - 语句只能看到在该语句开始执行之前已经提交的数据
  - 单个语句在开始时捕获表快照
  
  **事务状态转换**：
  | 状态 | 说明 |
  |------|------|
  | PREPARE | 事务已开启，等待数据写入 |
  | PRECOMMITTED | 数据已写入，等待提交指令（2PC特有） |
  | COMMITTED | 事务已提交，数据持久化 |
  | VISIBLE | 数据可见 |
  | ABORTED | 事务已回滚 |
  
- 优势：
  1. 支持外部系统协调：Flink等系统可以通过2PC协议协调多个Doris事务
  2. 实现EOS语义：配合Flink Connector实现端到端精确一次语义
  3. Label去重：保证数据不重不丢
  4. 灵活的提交控制：外部系统可以根据业务逻辑决定提交或回滚
- 已知限制：
  1. 2PC事务在PRECOMMITTED状态下，如果长时间未提交会超时回滚
  2. Label被淘汰后相同名称的Label可以再次执行成功，不再具有去重语义
  3. 需要外部系统正确实现协调逻辑
3.2 输入/输出

- 输入：
  - HTTP请求（Stream Load 2PC）：
    - 预提交请求：数据文件 + `two_phase_commit:true` Header
    - 提交请求：`txn_id` 或 `label` + `txn_operation:commit`
    - 回滚请求：`txn_id` 或 `label` + `txn_operation:abort`
  - 配置参数：
    - Label（可选）：用户自定义的事务标识，用于去重和状态查询
    - 超时时间：事务超时配置
- 输出：
  - 预提交响应：TxnId、Label、状态、写入统计信息
  - 提交/回滚响应：操作状态、消息
  - 错误信息：事务执行失败时的错误提示
4. 非功能性需求

4.1 性能要求

- 响应时间要求：
  - 预提交响应时间取决于数据量，通常秒级完成
  - 提交/回滚操作响应时间应在毫秒至秒级
  - 事务状态查询响应时间应在毫秒级
- 并发用户数：
  - 支持多个外部系统并发执行2PC事务
  - 每个数据库支持的并发事务数可配置
- 数据处理量：
  - 单个2PC事务支持GB级数据写入
  - 支持大规模数据的原子导入
- 超时控制：
  - PRECOMMITTED状态的事务有超时限制
  - 超时后事务自动回滚
4.2 安全性要求

- 权限控制：
  - 用户必须具有相应表的写入权限
  - HTTP接口需要Basic认证
  - 只有事务创建者可以提交或回滚事务
- 数据保护：
  - 事务回滚时确保数据完全撤销
  - Label机制防止重复导入
  - 2PC协议保证数据一致性
- 访问控制：
  - 事务通过txn_id或label唯一标识
  - 防止未授权的事务操作
4.3 兼容性要求

- 支持的数据库版本：
  - 支持Doris当前版本及后续版本
  - 向后兼容已有的Stream Load方式
- 接口兼容性：
  - HTTP REST接口，兼容标准HTTP客户端
  - 支持curl、HTTP库等多种方式调用
- 外部系统兼容性：
  - 支持Flink Connector的EOS语义
  - 支持任何实现2PC协议的外部协调器
  - 支持通过HTTP接口进行事务协调
