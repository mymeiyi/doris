1. 文档概述
1.1 设计目的
- 明确事务两阶段提交（2PC）功能的技术实现蓝图和总体架构
- 定义各模块职责和接口关系
- 为详细设计与开发提供依据
1.2 预期读者
- 系统架构师
- 开发工程师
- 测试工程师
- 项目管理人员
2. 系统总体设计
2.1 设计目标与原则
- 功能目标：
  - 实现两阶段提交（2PC）协议，支持外部系统协调事务
  - 提供数据写入的原子性保证
  - 通过Label机制实现Exactly-Once语义
  - 支持Flink等外部系统的端到端精确一次语义
- 设计原则：
  - 高可靠性：保证事务的原子性和一致性
  - 易用性：提供简单的HTTP REST接口
  - 可扩展性：支持多种外部协调器集成
  - 容错性：支持故障恢复和超时处理
- 技术约束：
  - 必须遵循标准的2PC协议语义
  - 需要保持与现有Stream Load接口的兼容性
  - 事务状态需要持久化以支持故障恢复
2.2 系统架构图

```
┌────────────────────────────────────────────────────────────────────────────┐
│                         External Coordinator Layer                          │
│  ┌────────────────┐  ┌────────────────┐  ┌────────────────┐               │
│  │ Flink Connector│  │ Custom Client  │  │ Other System   │               │
│  │  (2PC支持)     │  │  (HTTP调用)    │  │  (2PC协调器)   │               │
│  └────────────────┘  └────────────────┘  └────────────────┘               │
└────────────────────────────────────────────────────────────────────────────┘
                                    │
                         HTTP REST API
                                    ↓
┌────────────────────────────────────────────────────────────────────────────┐
│                              FE (Frontend)                                  │
│  ┌──────────────────────────────────────────────────────────────────────┐ │
│  │                      2PC Service Layer                                │ │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐               │ │
│  │  │Stream Load   │  │   2PC        │  │  Transaction │               │ │
│  │  │2PC Handler   │  │ Coordinator  │  │  State Query │               │ │
│  │  └──────────────┘  └──────────────┘  └──────────────┘               │ │
│  └──────────────────────────────────────────────────────────────────────┘ │
│  ┌──────────────────────────────────────────────────────────────────────┐ │
│  │                    Transaction Management Layer                       │ │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐               │ │
│  │  │ Transaction  │  │    Label     │  │   State      │               │ │
│  │  │   Manager    │  │   Manager    │  │   Machine    │               │ │
│  │  └──────────────┘  └──────────────┘  └──────────────┘               │ │
│  └──────────────────────────────────────────────────────────────────────┘ │
│  ┌──────────────────────────────────────────────────────────────────────┐ │
│  │                       Persistence Layer                               │ │
│  │  ┌──────────────┐  ┌──────────────┐                                  │ │
│  │  │   EditLog    │  │  Transaction │                                  │ │
│  │  │  (WAL)       │  │   Storage    │                                  │ │
│  │  └──────────────┘  └──────────────┘                                  │ │
│  └──────────────────────────────────────────────────────────────────────┘ │
└────────────────────────────────────────────────────────────────────────────┘
```

2.3 关键技术选型
| 技术领域 | 选用方案 | 简要说明 |
|---------|---------|---------|
| 通信协议 | HTTP REST | 提供标准的REST API接口 |
| 事务协议 | 两阶段提交(2PC) | 标准的分布式事务协议 |
| 状态管理 | 状态机 | 管理事务状态转换 |
| 持久化 | EditLog | 事务状态持久化到WAL |
| 去重机制 | Label | 基于Label的幂等性保证 |
| 认证方式 | Basic Auth | HTTP基本认证 |
3. 模块/组件设计
3.1 模块划分图

```
事务两阶段提交模块
├── 2PC服务层
│   ├── Stream Load 2PC Handler
│   │   ├── 预提交请求处理
│   │   ├── 提交请求处理
│   │   └── 回滚请求处理
│   └── 事务状态查询服务
│       └── 状态查询接口
├── 事务管理层
│   ├── TransactionMgr
│   │   ├── 事务创建
│   │   ├── 事务提交
│   │   └── 事务回滚
│   ├── LabelManager
│   │   ├── Label注册
│   │   ├── Label查询
│   │   └── Label淘汰
│   └── 状态机
│       ├── 状态转换验证
│       └── 状态变更处理
└── 持久化层
    ├── EditLog
    │   └── 事务日志记录
    └── Transaction Storage
        └── 事务状态存储
```

3.2 模块功能描述
| 模块名称 | 主要职责 | 输入 | 输出 | 依赖模块 |
|---------|---------|------|------|---------|
| Stream Load 2PC Handler | 处理2PC HTTP请求 | HTTP请求 | HTTP响应 | TransactionMgr |
| TransactionMgr | 管理事务生命周期 | 事务操作请求 | 事务状态 | LabelManager, 状态机 |
| LabelManager | 管理Label去重 | Label信息 | 去重结果 | Transaction Storage |
| 状态机 | 管理状态转换 | 状态转换请求 | 新状态 | - |
| EditLog | 持久化事务日志 | 事务变更 | 持久化确认 | - |
4. 接口设计
4.1 外部接口
- Stream Load 2PC预提交接口：POST /api/{db}/{table}/_stream_load
- Stream Load 2PC提交接口：PUT /api/{db}/{table}/_stream_load_2pc (txn_operation:commit)
- Stream Load 2PC回滚接口：PUT /api/{db}/{table}/_stream_load_2pc (txn_operation:abort)
4.2 内部接口
| 接口名称 | 调用方 | 被调用方 | 通信方式 | 数据格式 |
|---------|--------|---------|---------|---------|
| beginTransaction | 2PC Handler | TransactionMgr | 内部调用 | Java Object |
| preCommitTransaction | 2PC Handler | TransactionMgr | 内部调用 | Java Object |
| commitTransaction | 2PC Handler | TransactionMgr | 内部调用 | Java Object |
| abortTransaction | 2PC Handler | TransactionMgr | 内部调用 | Java Object |
| checkLabel | TransactionMgr | LabelManager | 内部调用 | Java Object |
| persistState | TransactionMgr | EditLog | 内部调用 | Java Object |
5. 数据设计概要
5.1 数据流图

```
外部协调器请求
      │
      ↓
┌─────────────────┐
│ 2PC Handler     │ ─────> 认证验证
└─────────────────┘
      │
      ↓
┌─────────────────┐
│ TransactionMgr  │ ─────> Label检查
└─────────────────┘
      │
      ↓
┌─────────────────┐
│ 状态机          │ ─────> 状态转换验证
└─────────────────┘
      │
      ↓
┌─────────────────┐
│ EditLog         │ ─────> 状态持久化
└─────────────────┘
      │
      ↓
返回响应给外部协调器
```

5.2 存储方案
- 结构化数据：
  - 事务状态存储在FE内存中
  - 事务日志持久化到EditLog
- 缓存数据：
  - 活跃事务缓存在内存HashMap中
  - Label信息缓存在LabelManager
5.3 数据一致性方案
- 事务处理机制：
  - 使用状态机保证状态转换的一致性
  - 状态变更前先写EditLog
  - 支持从EditLog恢复事务状态
- 数据同步策略：
  - FE主从同步事务状态
  - 通过EditLog实现状态复制
6. 关键技术方案
6.1 核心业务逻辑实现方案
- 两阶段提交实现：
  - Phase 1（Prepare）：数据写入，状态转为PRECOMMITTED
  - Phase 2（Commit/Abort）：根据协调器指令提交或回滚
- Label去重实现：
  - 预提交时检查Label是否已存在
  - 已成功的Label拒绝重复使用
  - Label定期淘汰释放资源
- 状态机实现：
  - 定义合法的状态转换路径
  - 拒绝非法的状态转换请求
  - 状态变更原子化
6.2 性能关键点设计
- 瓶颈预估：
  - 大量并发2PC事务可能导致FE内存压力
  - Label查询可能成为瓶颈
- 优化方向：
  - Label使用HashMap存储，O(1)查询
  - 异步持久化减少延迟
  - 定期清理过期事务和Label
6.3 容错与异常处理
- 异常分类：
  - 网络异常：连接超时、请求失败
  - 业务异常：Label冲突、状态非法
- 处理策略：
  - 超时自动回滚PRECOMMITTED状态的事务
  - 幂等处理重复的提交/回滚请求
  - 故障恢复时从EditLog重建事务状态
7. 非功能性设计
7.1 性能设计
- 响应时间目标：
  - 预提交：取决于数据量，通常秒级
  - 提交/回滚：毫秒至秒级
  - 状态查询：毫秒级
- 吞吐量目标：
  - 支持数百并发2PC事务
- 资源预估：
  - FE内存：事务状态 + Label缓存
7.2 安全性设计
- 认证授权：HTTP Basic认证
- 数据安全：2PC协议保证原子性
- 安全审计：事务操作日志记录
7.3 可扩展性设计
- 支持多种外部协调器集成
- 支持更多的事务操作类型
8. 开发计划建议
8.1 开发阶段划分
| 阶段 | 主要内容 | 预计周期 | 输出物 |
|------|---------|---------|--------|
| 阶段1 | 2PC HTTP接口 | 1周 | REST API |
| 阶段2 | 事务状态机 | 1周 | 状态管理模块 |
| 阶段3 | Label管理 | 1周 | Label模块 |
| 阶段4 | 持久化与恢复 | 1周 | EditLog集成 |
| 阶段5 | 测试与优化 | 1周 | 测试报告 |
8.2 技术风险评估
| 风险描述 | 可能性 | 影响程度 | 应对措施 |
|---------|--------|---------|---------|
| 外部协调器实现不正确 | 中 | 高 | 提供详细文档和示例 |
| 超时配置不合理 | 中 | 中 | 提供合理默认值和配置建议 |
| FE故障影响进行中事务 | 低 | 高 | 支持从EditLog恢复 |
| Label淘汰影响去重 | 低 | 中 | 合理配置淘汰策略 |
