1. 文档概述
1.1 设计目的
- 明确事务功能的技术实现蓝图和总体架构
- 定义各模块职责和接口关系
- 为详细设计与开发提供依据
1.2 预期读者
- 系统架构师
- 开发工程师
- 测试工程师
- 项目管理人员
2. 系统总体设计
2.1 设计目标与原则
- 功能目标：
  - 实现数据写入的原子性保证，确保事务中所有操作要么全部成功，要么全部失败
  - 支持显式事务和隐式事务，满足不同场景的数据一致性需求
  - 通过Label机制实现Exactly-Once语义，保证数据不重不丢
  - 支持两阶段提交（2PC），为Flink等外部系统提供EOS支持
- 设计原则：
  - 高可靠性：保证数据的原子性和一致性
  - 高性能：通过批量提交和并行写入优化性能
  - 易用性：兼容MySQL协议，使用标准SQL语法
  - 可扩展性：支持多表事务和分布式写入
- 技术约束：
  - 必须遵循Doris的分布式架构设计
  - 需要保持与MySQL协议的兼容性
  - 事务操作需要FE和BE协同完成
2.2 系统架构图

```
┌────────────────────────────────────────────────────────────────────────────┐
│                              Client Layer                                   │
│  ┌────────────────┐  ┌────────────────┐  ┌────────────────────────────┐   │
│  │  MySQL Client  │  │  JDBC Client   │  │  HTTP Client (Stream Load) │   │
│  └────────────────┘  └────────────────┘  └────────────────────────────┘   │
└────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ↓
┌────────────────────────────────────────────────────────────────────────────┐
│                              FE (Frontend)                                  │
│  ┌──────────────────────────────────────────────────────────────────────┐ │
│  │                      Transaction Management Layer                     │ │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐               │ │
│  │  │ Transaction  │  │    Label     │  │  Coordinator │               │ │
│  │  │   Manager    │  │   Manager    │  │   Service    │               │ │
│  │  └──────────────┘  └──────────────┘  └──────────────┘               │ │
│  └──────────────────────────────────────────────────────────────────────┘ │
│  ┌──────────────────────────────────────────────────────────────────────┐ │
│  │                         SQL Parser & Planner                          │ │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐               │ │
│  │  │  SQL Parser  │  │   Analyzer   │  │   Planner    │               │ │
│  │  └──────────────┘  └──────────────┘  └──────────────┘               │ │
│  └──────────────────────────────────────────────────────────────────────┘ │
│  ┌──────────────────────────────────────────────────────────────────────┐ │
│  │                          Metadata Layer                               │ │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐               │ │
│  │  │ Catalog Mgr  │  │  Table Meta  │  │ Partition Mgr│               │ │
│  │  └──────────────┘  └──────────────┘  └──────────────┘               │ │
│  └──────────────────────────────────────────────────────────────────────┘ │
└────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ↓ (Thrift RPC)
┌────────────────────────────────────────────────────────────────────────────┐
│                              BE (Backend)                                   │
│  ┌──────────────────────────────────────────────────────────────────────┐ │
│  │                        Data Write Layer                               │ │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐               │ │
│  │  │ Delta Writer │  │ Tablet Writer│  │  RowSet Mgr  │               │ │
│  │  └──────────────┘  └──────────────┘  └──────────────┘               │ │
│  └──────────────────────────────────────────────────────────────────────┘ │
│  ┌──────────────────────────────────────────────────────────────────────┐ │
│  │                         Storage Layer                                 │ │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐               │ │
│  │  │   Tablet 1   │  │   Tablet 2   │  │   Tablet N   │               │ │
│  │  │  (Replicas)  │  │  (Replicas)  │  │  (Replicas)  │               │ │
│  │  └──────────────┘  └──────────────┘  └──────────────┘               │ │
│  └──────────────────────────────────────────────────────────────────────┘ │
└────────────────────────────────────────────────────────────────────────────┘
```

2.3 关键技术选型
| 技术领域 | 选用方案 | 简要说明 |
|---------|---------|---------|
| 通信协议 | MySQL Protocol + Thrift RPC | 客户端使用MySQL协议，FE/BE使用Thrift |
| 事务模型 | MVCC | 多版本并发控制 |
| 隔离级别 | READ COMMITTED | 读已提交隔离级别 |
| 去重机制 | Label | 基于Label的幂等性保证 |
| 2PC | Stream Load 2PC | 支持外部协调的两阶段提交 |
| 状态管理 | 状态机 | 事务状态机管理 |
3. 模块/组件设计
3.1 模块划分图

```
事务功能模块
├── FE端模块
│   ├── 事务管理模块（TransactionMgr）
│   │   ├── 事务创建
│   │   ├── 事务状态管理
│   │   └── 事务提交/回滚
│   ├── Label管理模块（LabelManager）
│   │   ├── Label创建
│   │   ├── Label查询
│   │   └── Label淘汰
│   ├── 协调服务模块（Coordinator）
│   │   ├── 写入任务分发
│   │   ├── 结果收集
│   │   └── 异常处理
│   └── 2PC服务模块
│       ├── HTTP接口
│       ├── 预提交处理
│       └── 提交/回滚处理
├── BE端模块
│   ├── 数据写入模块（Delta Writer）
│   │   ├── 数据接收
│   │   ├── 内存写入
│   │   └── 提交控制
│   ├── Tablet写入模块
│   │   ├── 数据序列化
│   │   ├── 副本写入
│   │   └── 同步控制
│   └── RowSet管理模块
│       ├── RowSet创建
│       ├── RowSet可见性
│       └── RowSet合并
└── 公共组件
    ├── 状态机
    ├── 日志组件
    └── 监控组件
```

3.2 模块功能描述
| 模块名称 | 主要职责 | 输入 | 输出 | 依赖模块 |
|---------|---------|------|------|---------|
| TransactionMgr | 管理事务生命周期 | 事务请求 | 事务状态 | LabelManager, Coordinator |
| LabelManager | 管理Label去重 | Label信息 | 去重结果 | 元数据存储 |
| Coordinator | 协调分布式写入 | 写入任务 | 执行结果 | BE节点 |
| Delta Writer | 数据增量写入 | 数据记录 | 写入结果 | Tablet Writer |
| Tablet Writer | Tablet数据写入 | 数据块 | 持久化结果 | Storage |
| RowSet Mgr | RowSet管理 | RowSet | 可见性状态 | Storage |
4. 接口设计
4.1 外部接口
- MySQL协议接口：BEGIN/COMMIT/ROLLBACK SQL语句
- HTTP REST接口：Stream Load 2PC的预提交、提交、回滚
- JDBC接口：通过JDBC连接执行事务操作
4.2 内部接口
| 接口名称 | 调用方 | 被调用方 | 通信方式 | 数据格式 |
|---------|--------|---------|---------|---------|
| beginTransaction | Coordinator | TransactionMgr | 内部调用 | Java Object |
| commitTransaction | Coordinator | TransactionMgr | 内部调用 | Java Object |
| executeWrite | Coordinator | BE | Thrift RPC | Thrift |
| publishVersion | FE | BE | Thrift RPC | Thrift |
| checkLabel | TransactionMgr | LabelManager | 内部调用 | Java Object |
5. 数据设计概要
5.1 数据流图

```
用户请求 → FE解析 → 事务创建 → Label检查 → 写入任务分发
                                              ↓
                                          BE数据写入
                                              ↓
                                          提交请求
                                              ↓
FE协调提交 → BE持久化 → 数据可见 → 返回结果
```

5.2 存储方案
- 结构化数据：
  - 事务元数据存储在FE的内存和持久化存储中
  - 写入数据存储在BE的Tablet中
- 非结构化数据：
  - 事务日志存储在editlog中
- 缓存数据：
  - 事务状态缓存在FE内存
  - Label信息缓存在LabelManager
5.3 数据一致性方案
- 事务处理机制：
  - 使用状态机管理事务状态转换
  - 多副本写入保证数据一致性
  - 通过publish version机制保证可见性一致
- 数据同步策略：
  - 主从副本同步写入
  - Quorum机制保证多数副本成功
6. 关键技术方案
6.1 核心业务逻辑实现方案
- 事务原子性实现：
  - 通过FE统一协调多BE的写入
  - 使用两阶段协议保证原子性
  - 提交时统一publish version使数据可见
- Label去重实现：
  - Label在数据库级别唯一
  - 提交前检查Label是否已存在
  - 已成功的Label不允许重复使用
- 隔离级别实现：
  - 每个语句开始时捕获表快照
  - 只能看到语句开始前已提交的数据
  - 事务内语句不能看到其他语句的修改
6.2 性能关键点设计
- 瓶颈预估：
  - 大量并发事务可能导致FE内存压力
  - 多副本写入可能成为性能瓶颈
  - Label淘汰可能影响查询性能
- 优化方向：
  - 批量提交减少网络往返
  - 并行副本写入
  - 异步Label淘汰
6.3 容错与异常处理
- 异常分类：
  - 系统异常：网络故障、节点宕机
  - 业务异常：数据校验失败、权限不足
- 处理策略：
  - 超时自动回滚
  - Session关闭自动回滚
  - 部分语句失败自动回滚该语句
7. 非功能性设计
7.1 性能设计
- 响应时间目标：
  - BEGIN/COMMIT：毫秒级
  - 单次写入：根据数据量，通常秒级
  - P95：< 1s（中等数据量）
  - P99：< 5s（大数据量）
- 吞吐量目标：
  - 支持数百并发事务
  - 单事务支持GB级数据写入
- 资源预估：
  - FE内存：事务元数据、Label缓存
  - BE内存：写入缓冲区
7.2 安全性设计
- 认证授权：用户权限验证，表级别写入权限
- 数据安全：原子性保证，防止部分写入
- 安全审计：事务操作日志记录
7.3 可扩展性设计
- 水平扩展：支持多FE、多BE的分布式部署
- 垂直扩展：支持更大的事务数据量
8. 开发计划建议
8.1 开发阶段划分
| 阶段 | 主要内容 | 预计周期 | 输出物 |
|------|---------|---------|--------|
| 阶段1 | 基础事务框架 | 2周 | 事务管理模块 |
| 阶段2 | Label机制 | 1周 | Label管理模块 |
| 阶段3 | 2PC支持 | 2周 | Stream Load 2PC |
| 阶段4 | 多表事务 | 2周 | 多表事务支持 |
| 阶段5 | 测试优化 | 2周 | 测试报告、性能优化 |
8.2 技术风险评估
| 风险描述 | 可能性 | 影响程度 | 应对措施 |
|---------|--------|---------|---------|
| 分布式事务一致性问题 | 中 | 高 | 完善状态机、加强测试 |
| 性能不达预期 | 中 | 中 | 批量优化、并行处理 |
| Label淘汰影响查询 | 低 | 低 | 异步淘汰、合理配置 |
| 2PC外部协调失败 | 中 | 中 | 超时机制、重试策略 |
